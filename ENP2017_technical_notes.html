<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-07-21 ven. 16:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Technical notes for the ENP 2017 course</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Christophe Pouzat" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Technical notes for the ENP 2017 course</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#introduction">1. Introduction</a>
<ul>
<li><a href="#org902e9f1">1.1. Why <code>C</code>, <code>gnuplot</code> and the <code>shell</code>?</a></li>
<li><a href="#orgf809f5b">1.2. Required software and libraries</a></li>
<li><a href="#orgf4ddd77">1.3. A remark on the code presentation</a></li>
</ul>
</li>
<li><a href="#Getting-the-data">2. Getting the data</a>
<ul>
<li><a href="#downloading-the-data">2.1. Downloading the data</a></li>
<li><a href="#python-code-converting-hdf5-to-fits">2.2. <code>Python</code> code converting <code>HDF5</code> to <code>FITS</code></a></li>
</ul>
</li>
<li><a href="#pomc-data-visualization">3. POMC Data visualization</a>
<ul>
<li><a href="#data-summaries-with-the-hdf5-tools">3.1. Data summaries with the <code>HDF5</code> tools</a></li>
<li><a href="#c-code-printing-to-stdout-part-of-the-data-set-for-gnuplot">3.2. <code>C</code> code printing to <code>STDOUT</code> part of the data set for <code>gnuplot</code></a></li>
</ul>
</li>
<li><a href="#why-does-a-proper-noise-model-matter">4. Why does a proper noise model matter?</a>
<ul>
<li><a href="#figure-data-=-deterministic-part-+-noise">4.1. Figure <code>data = deterministic part + noise</code></a>
<ul>
<li><a href="#org9e378ad">4.1.1. <code>C</code> code requirements</a></li>
<li><a href="#org533e3ec">4.1.2. Program <code>sim_mono_exp</code></a></li>
<li><a href="#orga13b492">4.1.3. <code>sim_mono_exp</code> usage</a></li>
<li><a href="#org8bec30e">4.1.4. Making the figure</a></li>
</ul>
</li>
<li><a href="#orgf6c54f4">4.2. Simple case simulation</a>
<ul>
<li><a href="#org9df79fc">4.2.1. What do we want to do?</a></li>
<li><a href="#org7e988da">4.2.2. <code>C</code> implementation for a single case</a>
<ul>
<li><a href="#orge77a6f4">4.2.2.1. A note on the nonlinear least-squares routines</a></li>
<li><a href="#org830853a">4.2.2.2. Program skeleton</a></li>
<li><a href="#org187e8e1">4.2.2.3. Headers and macros</a></li>
<li><a href="#orga947b49">4.2.2.4. A structure holding "what is fixed"</a></li>
<li><a href="#org7d09c67">4.2.2.5. Residual returning function definition for the first estimator</a></li>
<li><a href="#org63d5e9e">4.2.2.6. Jacobian returning function definition for the first estimator</a></li>
<li><a href="#org23ac1f7">4.2.2.7. Residual returning function definition for the second estimator</a></li>
<li><a href="#org37c8952">4.2.2.8. Jacobian returning function definition for the second estimator</a></li>
<li><a href="#org5be37e4">4.2.2.9. "callback" function definition</a></li>
<li><a href="#org4ce0614">4.2.2.10. Data simulation and "fixed parameters" initialization</a></li>
<li><a href="#orgf217894">4.2.2.11. Definitions of convergence / stopping conditions</a></li>
<li><a href="#orgc1d8c98">4.2.2.12. <code>&lt;&lt;expl_beta_est-setup-tilde-solver&gt;&gt;</code>: solver memory allocation and initialization for the first estimator</a></li>
<li><a href="#orgd87d82a">4.2.2.13. <code>&lt;&lt;expl_beta_est-setup-hat-solver&gt;&gt;</code>: solver memory allocation and initialization for the second estimator</a></li>
<li><a href="#orgdd54949">4.2.2.14. <code>&lt;&lt;expl_beta_est-free-solver&gt;&gt;</code>: free solvers' space</a></li>
<li><a href="#org5ade761">4.2.2.15. <code>&lt;&lt;expl_beta_est-fdf-tilde&gt;&gt;</code>: function to minimize for the first estimator</a></li>
<li><a href="#orgef8e711">4.2.2.16. <code>&lt;&lt;expl_beta_est-fdf-hat&gt;&gt;</code>: function to minimize for the second estimator</a></li>
<li><a href="#orgf866151">4.2.2.17. <code>&lt;&lt;expl_beta_est-inital-cost-tilde&gt;&gt;</code></a></li>
<li><a href="#org12c24c4">4.2.2.18. <code>&lt;&lt;expl_beta_est-inital-cost-hat&gt;&gt;</code></a></li>
<li><a href="#orgeb2fe5f">4.2.2.19. <code>&lt;&lt;expl_beta_est-get-beta-tilde&gt;&gt;</code></a></li>
<li><a href="#org0ca4eb7">4.2.2.20. <code>&lt;&lt;expl_beta_est-get-beta-hat&gt;&gt;</code></a></li>
<li><a href="#org4dba1b8">4.2.2.21. <code>&lt;&lt;expl_beta_est-free-covar&gt;&gt;</code>: frees space taken by covariance matrices</a></li>
<li><a href="#org0774b4a">4.2.2.22. Code compilation</a></li>
<li><a href="#orgc9f3fd0">4.2.2.23. Code use</a></li>
<li><a href="#org46b5c6f">4.2.2.24. Using valgrind</a></li>
</ul>
</li>
<li><a href="#orgb2a3082">4.2.3. <code>C</code> implementation of a systematic simulation</a>
<ul>
<li><a href="#orga989af8">4.2.3.1. <code>&lt;&lt;beta_samp_dist&gt;&gt;</code> code skeleton</a></li>
<li><a href="#org1f66576">4.2.3.2. <code>&lt;&lt;beta_samp_dist-include&gt;&gt;</code> header</a></li>
<li><a href="#org3691d22">4.2.3.3. <code>&lt;&lt;beta_samp_dist-usage&gt;&gt;</code></a></li>
<li><a href="#orgff5e4d9">4.2.3.4. <code>&lt;&lt;beta_samp_dist-args&gt;&gt;</code></a></li>
<li><a href="#orgec5bbee">4.2.3.5. <code>&lt;&lt;beta_samp_dist-fdf-tilde&gt;&gt;</code></a></li>
<li><a href="#orgcc8adb1">4.2.3.6. <code>&lt;&lt;beta_samp_dist-fdf-hat&gt;&gt;</code></a></li>
<li><a href="#org869d638">4.2.3.7. <code>&lt;&lt;beta_samp_dist-setup-tilde-solver&gt;&gt;</code></a></li>
<li><a href="#orgc08d147">4.2.3.8. <code>&lt;&lt;beta_samp_dist-setup-hat-solver&gt;&gt;</code></a></li>
<li><a href="#org98c96ca">4.2.3.9. <code>&lt;&lt;beta_samp_dist-allocate-beta-vectors&gt;&gt;</code></a></li>
<li><a href="#org92d47f7">4.2.3.10. <code>&lt;&lt;beta_samp_dist-free-beta-vectors&gt;&gt;</code></a></li>
<li><a href="#org3004551">4.2.3.11. <code>&lt;&lt;beta_samp_dist-get-beta-tilde&gt;&gt;</code></a></li>
<li><a href="#org84e1ef3">4.2.3.12. <code>&lt;&lt;beta_samp_dist-get-beta-hat&gt;&gt;</code></a></li>
<li><a href="#org570d9b0">4.2.3.13. <code>&lt;&lt;beta_samp_dist-store-results&gt;&gt;</code></a></li>
<li><a href="#org886ace6">4.2.3.14. <code>&lt;&lt;beta_samp_dist-beta-range&gt;&gt;</code></a></li>
<li><a href="#orge6f1161">4.2.3.15. <code>&lt;&lt;beta_samp_dist-allocate-hist&gt;&gt;</code></a></li>
<li><a href="#org0554bfa">4.2.3.16. <code>&lt;&lt;beta_samp_dist-free-hist&gt;&gt;</code></a></li>
<li><a href="#org52cb350">4.2.3.17. <code>&lt;&lt;beta_samp_dist-fill-hist&gt;&gt;</code></a></li>
<li><a href="#org6dba715">4.2.3.18. <code>&lt;&lt;beta_samp_dist-write-hist&gt;&gt;</code></a></li>
<li><a href="#orgb92a145">4.2.3.19. Code compilation</a></li>
<li><a href="#org3b40438">4.2.3.20. Code use</a></li>
<li><a href="#org7418b3f">4.2.3.21. Figure construction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1bea4e4">5. Convergence in law of a Poisson random variable towards a normal one</a>
<ul>
<li><a href="#org9047df9">5.1. Scaled Poisson CDF</a>
<ul>
<li>
<ul>
<li><a href="#orgd233086">5.1.0.1. <code>&lt;&lt;scaled_poisson&gt;&gt;</code> skeleton</a></li>
<li><a href="#org837dbf5">5.1.0.2. <code>&lt;&lt;scaled_poisson-include&gt;&gt;</code></a></li>
<li><a href="#org67a38a1">5.1.0.3. <code>&lt;&lt;scaled_poisson-usage&gt;&gt;</code></a></li>
<li><a href="#org0a028f3">5.1.0.4. <code>&lt;&lt;scaled_poisson-args&gt;&gt;</code></a></li>
<li><a href="#orgb3ceeda">5.1.0.5. <code>&lt;&lt;scaled_poisson-free-n_seq&gt;&gt;</code></a></li>
<li><a href="#orgae781ab">5.1.0.6. <code>&lt;&lt;scaled_poisson-print-header&gt;&gt;</code></a></li>
<li><a href="#org2cd3de6">5.1.0.7. <code>&lt;&lt;scaled_poisson-get-and-print-CDF&gt;&gt;</code></a></li>
<li><a href="#org6e33a01">5.1.0.8. Code compilation</a></li>
<li><a href="#org6be3504">5.1.0.9. Code use</a></li>
<li><a href="#org93d55fd">5.1.0.10. Figures construction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf4d5f6b">6. Calibration data analysis</a>
<ul>
<li><a href="#org5e236b1">6.1. Getting the data</a>
<ul>
<li><a href="#org6ae1720">6.1.1. Donwlading the calibration data</a></li>
<li><a href="#org65361c2">6.1.2. Overview of the file content</a></li>
</ul>
</li>
<li><a href="#org1581cb5">6.2. Dumping and plotting an image</a>
<ul>
<li>
<ul>
<li><a href="#orgd5d421b">6.2.0.1. <code>print-exposure</code> skeleton</a></li>
<li><a href="#org8553354">6.2.0.2. <code>&lt;&lt;print-exposure-include&gt;&gt;</code></a></li>
<li><a href="#org23be834">6.2.0.3. <code>&lt;&lt;print-exposure-usage&gt;&gt;</code></a></li>
<li><a href="#orgd24fbb9">6.2.0.4. <code>&lt;&lt;print-exposure-args&gt;&gt;</code></a></li>
<li><a href="#orgbb71925">6.2.0.5. <code>&lt;&lt;print-exposure-open-FILE-and-read-DSET&gt;&gt;</code></a></li>
<li><a href="#org82ab8ba">6.2.0.6. <code>&lt;&lt;print-exposure-close-file-free-data&gt;&gt;</code></a></li>
<li><a href="#org95330fa">6.2.0.7. <code>&lt;&lt;print-exposure-print-results&gt;&gt;</code></a></li>
<li><a href="#org20870d6">6.2.0.8. Compile <code>print-exposure</code></a></li>
<li><a href="#orga57f304">6.2.0.9. Use and test</a></li>
<li><a href="#orgbafb54c">6.2.0.10. Do the figure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3d3d56b">6.3. Dumping and plotting ADU sequences</a>
<ul>
<li><a href="#org5f68e85">6.3.1. Definition and use of a shell function to dump the data</a></li>
<li><a href="#org3cab1ea">6.3.2. Making the figure</a></li>
</ul>
</li>
<li><a href="#orgf4c407a">6.4. Linear fit of a single sequence</a>
<ul>
<li>
<ul>
<li><a href="#org571a808">6.4.0.1. <code>adu_sequence_fit</code> skeleton</a></li>
<li><a href="#org13b9c18">6.4.0.2. <code>&lt;&lt;adu_sequence_fit-include&gt;&gt;</code></a></li>
<li><a href="#org7b6c89c">6.4.0.3. <code>&lt;&lt;adu_sequence_fit-usage&gt;&gt;</code></a></li>
<li><a href="#org7979bcf">6.4.0.4. <code>&lt;&lt;adu_sequence_fit-args&gt;&gt;</code></a></li>
<li><a href="#orge492621">6.4.0.5. <code>&lt;&lt;adu_sequence_fit-read-data&gt;&gt;</code></a></li>
<li><a href="#org41c37f6">6.4.0.6. <code>&lt;&lt;adu_sequence_fit-fit&gt;&gt;</code></a></li>
<li><a href="#org79e915a">6.4.0.7. <code>&lt;&lt;adu_sequence_fit-print-results&gt;&gt;</code></a></li>
<li><a href="#org2e43d02">6.4.0.8. Compile <code>adu_sequence_fit</code></a></li>
<li><a href="#orgbb72c5a">6.4.0.9. Use and test <code>adu_sequence_fit</code></a></li>
</ul>
</li>
<li><a href="#org2b1589d">6.4.1. Making the figure</a></li>
</ul>
</li>
<li><a href="#orgd170c8c">6.5. Linear fit of all sequences in a given group</a>
<ul>
<li><a href="#org264863f">6.5.1. Program <code>adu_drift_test</code> definition</a>
<ul>
<li><a href="#org37191d5">6.5.1.1. <code>adu_drift_test</code> skeleton</a></li>
<li><a href="#org5115f10">6.5.1.2. <code>&lt;&lt;adu_drift_test-include&gt;&gt;</code></a></li>
<li><a href="#org3ca556d">6.5.1.3. <code>&lt;&lt;adu_drift_test-usage&gt;&gt;</code></a></li>
<li><a href="#orgbef8f84">6.5.1.4. <code>&lt;&lt;adu_drift_test-args&gt;&gt;</code></a></li>
<li><a href="#org17e73eb">6.5.1.5. <code>&lt;&lt;adu_drift_test-read-data&gt;&gt;</code></a></li>
<li><a href="#orga77788a">6.5.1.6. <code>&lt;&lt;adu_drift_test-close-file&gt;&gt;</code></a></li>
<li><a href="#org8ab9814">6.5.1.7. <code>&lt;&lt;adu_drift_test-fit&gt;&gt;</code></a></li>
<li><a href="#orge73560d">6.5.1.8. <code>&lt;&lt;adu_drift_test-print-results&gt;&gt;</code></a></li>
<li><a href="#org49cafae">6.5.1.9. Compile <code>adu_drift_test</code></a></li>
<li><a href="#org151a8fe">6.5.1.10. Use, test, etc of  <code>adu_drift_test</code></a></li>
<li><a href="#orgad04875">6.5.1.11. Computation of the drift statistic for all the groups</a></li>
</ul>
</li>
<li><a href="#orga48a23d">6.5.2. Histogram building program</a>
<ul>
<li><a href="#orgfb86f65">6.5.2.1. <code>mk_histogram</code> skeleton</a></li>
<li><a href="#orgff0ff65">6.5.2.2. <code>&lt;&lt;mk_histogram-include&gt;&gt;</code></a></li>
<li><a href="#orgffda559">6.5.2.3. <code>&lt;&lt;mk_histogram-usage&gt;&gt;</code></a></li>
<li><a href="#org95bff2d">6.5.2.4. <code>&lt;&lt;mk_histogram-args&gt;&gt;</code></a></li>
<li><a href="#org80b64e3">6.5.2.5. <code>&lt;&lt;mk_histogram-read-data&gt;&gt;</code></a></li>
<li><a href="#orgf009103">6.5.2.6. <code>&lt;&lt;mk_histogram-make-histo&gt;&gt;</code></a></li>
<li><a href="#org4e3f7cd">6.5.2.7. <code>&lt;&lt;mk_histogram-print-results&gt;&gt;</code></a></li>
<li><a href="#orgc7174e8">6.5.2.8. <code>&lt;&lt;mk_histogram-free-memory&gt;&gt;</code></a></li>
<li><a href="#org0e0e285">6.5.2.9. Compile <code>mk_histogram</code></a></li>
<li><a href="#org974568d">6.5.2.10. Check <code>mk_histogram</code></a></li>
</ul>
</li>
<li><a href="#org80f8eaa">6.5.3. Making the figure</a></li>
</ul>
</li>
<li><a href="#orgbc5846f">6.6. Correlation coefficients between sequences of nearest neighbor pixels</a>
<ul>
<li><a href="#orga4c6d56">6.6.1. Program <code>adu_corr_test</code> definition</a>
<ul>
<li><a href="#org9368618">6.6.1.1. <code>&lt;&lt;adu_corr_test&gt;&gt;</code> skeleton</a></li>
<li><a href="#org73481ac">6.6.1.2. <code>&lt;&lt;adu_corr_test-include&gt;&gt;</code></a></li>
<li><a href="#orga2db2a4">6.6.1.3. <code>&lt;&lt;adu_corr_test-usage&gt;&gt;</code></a></li>
<li><a href="#orgeebb580">6.6.1.4. <code>&lt;&lt;adu_corr_test-corr-and-print&gt;&gt;</code></a></li>
<li><a href="#org73d5cbb">6.6.1.5. Compile and check <code>adu_corr_test</code></a></li>
<li><a href="#org3b35d74">6.6.1.6. Computation of the correlation statistic for all the groups</a></li>
</ul>
</li>
<li><a href="#orgc852bb7">6.6.2. Making the figure</a></li>
</ul>
</li>
<li><a href="#org0849ebe">6.7. Getting the CCD parameters: G and \(\sigma^2_{ro}\)</a>
<ul>
<li><a href="#orge6d9c16">6.7.1. Obtaining the data for the regression analysis</a>
<ul>
<li><a href="#org77105ce">6.7.1.1. Program <code>adu_mu_s2</code> skeleton</a></li>
<li><a href="#org9990919">6.7.1.2. <code>&lt;&lt;adu_mu_s2-include&gt;&gt;</code></a></li>
<li><a href="#org458160a">6.7.1.3. <code>&lt;&lt;adu_mu_s2-usage&gt;&gt;</code></a></li>
<li><a href="#org5e9f9c6">6.7.1.4. <code>&lt;&lt;adu_mu_s2-args&gt;&gt;</code></a></li>
<li><a href="#org9a859f5">6.7.1.5. <code>&lt;&lt;adu_mu_s2-open-file&gt;&gt;</code></a></li>
<li><a href="#org292f9c2">6.7.1.6. <code>&lt;&lt;adu_mu_s2-get-mean-variance-and-print&gt;&gt;</code></a></li>
<li><a href="#org0795db7">6.7.1.7. <code>&lt;&lt;adu_mu_s2-close-file-free-data&gt;&gt;</code></a></li>
<li><a href="#orgddcc9eb">6.7.1.8. Compile and test <code>adu_mu_s2</code></a></li>
</ul>
</li>
<li><a href="#org1cb2b98">6.7.2. Making the first figure</a></li>
<li><a href="#org2709397">6.7.3. Doing the weighted linear regression</a>
<ul>
<li><a href="#org14ed316">6.7.3.1. <code>adu_mu_s2_fit</code> skeleton</a></li>
<li><a href="#org7afdc14">6.7.3.2. <code>&lt;&lt;adu_mu_s2_fit-include&gt;&gt;</code></a></li>
<li><a href="#orgb6d061f">6.7.3.3. <code>&lt;&lt;adu_mu_s2_fit-usage&gt;&gt;</code></a></li>
<li><a href="#orga60f924">6.7.3.4. <code>&lt;&lt;adu_mu_s2_fit-args&gt;&gt;</code></a></li>
<li><a href="#org6d81b0f">6.7.3.5. <code>&lt;&lt;adu_mu_s2_fit-read-data&gt;&gt;</code></a></li>
<li><a href="#org8dc4ec8">6.7.3.6. <code>&lt;&lt;adu_mu_s2_fit-fit&gt;&gt;</code></a></li>
<li><a href="#org6af5e60">6.7.3.7. <code>&lt;&lt;adu_mu_s2_fit-print-results&gt;&gt;</code></a></li>
<li><a href="#org452bf4e">6.7.3.8. Compile, run and test <code>adu_mu_s2_fit</code></a></li>
</ul>
</li>
<li><a href="#org1320d80">6.7.4. Doing the fit figures</a></li>
</ul>
</li>
<li><a href="#org583750e">6.8. Variance stabilization</a>
<ul>
<li><a href="#org724667a">6.8.1. Doing the figure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga686c54">7. Automatic ROI detection</a>
<ul>
<li><a href="#orgb98ee44">7.1. Program <code>roi</code></a>
<ul>
<li>
<ul>
<li><a href="#orgb50b727">7.1.0.1. <code>roi</code> skeleton</a></li>
<li><a href="#orgc788b07">7.1.0.2. <code>&lt;&lt;roi-include&gt;&gt;</code></a></li>
<li><a href="#orgf169887">7.1.0.3. <code>&lt;&lt;roi-usage&gt;&gt;</code></a></li>
<li><a href="#orge80b59f">7.1.0.4. <code>&lt;&lt;roi-args&gt;&gt;</code></a></li>
<li><a href="#org6c2f153">7.1.0.5. <code>&lt;&lt;roi-open-file-and-read-dset&gt;&gt;</code></a></li>
<li><a href="#orgc6ffd0c">7.1.0.6. <code>&lt;&lt;roi-close-file-free-memory&gt;&gt;</code></a></li>
<li><a href="#org4d19645">7.1.0.7. <code>&lt;&lt;roi-stabilize-variance-and-get-pRSS&gt;&gt;</code></a></li>
<li><a href="#orgfb4e759">7.1.0.8. <code>&lt;&lt;roi-stabilize-print-results&gt;&gt;</code></a></li>
<li><a href="#org91a737b">7.1.0.9. Compile, run and test <code>roi</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org31a8dd7">7.2. Making the figure</a></li>
</ul>
</li>
<li><a href="#orgde7e1cb">8. Signal estimation</a>
<ul>
<li><a href="#orga90aac3">8.1. The model: a piecewise constant function</a></li>
<li><a href="#org44d395c">8.2. Parameters and data organization</a>
<ul>
<li><a href="#org51fd670">8.2.1. Data layout</a></li>
<li><a href="#orgf78fcbb">8.2.2. Going from the parameters to the model prediction</a></li>
<li><a href="#org38fc85d">8.2.3. Getting initial guesses</a></li>
</ul>
</li>
<li><a href="#org9e20852">8.3. The program</a>
<ul>
<li><a href="#org30625ca">8.3.1. Code definition</a>
<ul>
<li><a href="#org98182f0">8.3.1.1. <code>fit_pwc_to_roi</code> skeleton</a></li>
<li><a href="#orgcb0f3b2">8.3.1.2. <code>&lt;&lt;fit_pwc_to_roi-include&gt;&gt;</code></a></li>
<li><a href="#org0743ba9">8.3.1.3. <code>&lt;&lt;fit_pwc_to_roi-macro&gt;&gt;</code></a></li>
<li><a href="#orga905e59">8.3.1.4. <code>&lt;&lt;fit_pwc_to_roi-data-structure&gt;&gt;</code></a></li>
<li><a href="#org8001cb8">8.3.1.5. <code>&lt;&lt;fit_pwc_to_roi-usage&gt;&gt;</code></a></li>
<li><a href="#org088df75">8.3.1.6. <code>&lt;&lt;fit_pwc_to_roi-args&gt;&gt;</code></a></li>
<li><a href="#orga42b6ba">8.3.1.7. <code>&lt;&lt;fit_pwc_to_roi-free-memory&gt;&gt;</code></a></li>
<li><a href="#org6b39a07">8.3.1.8. <code>&lt;&lt;fit_pwc_to_roi-print-info&gt;&gt;</code></a></li>
<li><a href="#org0f9f979">8.3.1.9. <code>&lt;&lt;fit_pwc_to_roi-read-data&gt;&gt;</code></a></li>
<li><a href="#orgc3f1cfe">8.3.1.10. <code>&lt;&lt;fit_pwc_to_roi-initialize-data-structure&gt;&gt;</code></a></li>
<li><a href="#orgd525705">8.3.1.11. <code>&lt;&lt;fit_pwc_to_roi-initial-guess&gt;&gt;</code></a></li>
<li><a href="#orgce3a960">8.3.1.12. <code>&lt;&lt;fit_pwc_to_roi-residual-fct&gt;&gt;</code></a></li>
<li><a href="#orge593dd5">8.3.1.13. <code>&lt;&lt;fit_pwc_to_roi-callback-fct&gt;&gt;</code></a></li>
<li><a href="#org98b0eb4">8.3.1.14. <code>&lt;&lt;fit_pwc_to_roi-initialize-gsl_multifit_nlinear_fdf&gt;&gt;</code></a></li>
<li><a href="#orgb79efda">8.3.1.15. <code>&lt;&lt;fit_pwc_to_roi-allocate-and-initialize-solver&gt;&gt;</code></a></li>
<li><a href="#orged8fcd5">8.3.1.16. <code>&lt;&lt;fit_pwc_to_roi-inital-rss&gt;&gt;</code></a></li>
<li><a href="#org6ba4ca1">8.3.1.17. <code>&lt;&lt;fit_pwc_to_roi-do-nls&gt;&gt;</code></a></li>
<li><a href="#org567a321">8.3.1.18. <code>&lt;&lt;fit_pwc_to_roi-print-info-final&gt;&gt;</code></a></li>
<li><a href="#org33c8eaa">8.3.1.19. <code>&lt;&lt;fit_pwc_to_roi-print-results&gt;&gt;</code></a></li>
<li><a href="#org5d48f26">8.3.1.20. Compile, run and test <code>roi</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbd7b2b2">8.4. Doing the figures</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org7304ef9" class="outline-2">
<h2 id="introduction"><a id="org7304ef9"></a><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-introduction">
<p>
What follows is a detailed description of the analysis presented during the course. The analysis is carried out with <code>C</code> programs, <code>gnuplot</code> (for the figures) and some <code>shell</code> commands and scripts. The same analysis (or almost the same) is "available" using  <code>R</code> on <a href="https://zenodo.org/record/15097">zenodo</a> and using <code>Python</code> on <a href="https://github.com/christophe-pouzat/ENP2015">GitHub</a> (the <code>IPython</code> notebook can be visualized directly with <a href="http://nbviewer.ipython.org/github/christophe-pouzat/ENP2015/blob/master/Pouzat-ENP-2015.ipynb">nbviewer</a>).
</p>
</div>

<div id="outline-container-org902e9f1" class="outline-3">
<h3 id="org902e9f1"><span class="section-number-3">1.1</span> Why <code>C</code>, <code>gnuplot</code> and the <code>shell</code>?</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This document is the exploration of an idea: use the shell (<code>bash</code> or <code>zsh</code>) instead of the <code>Python</code> or <code>R</code> command line for interactive analysis and write the short functions performing the actual analysis in <code>C</code>. The motivation for this exploration comes from two books by Ben Klemens: <a href="http://modelingwithdata.org/about_the_book.html">Modeling With Data</a> and <i>21st Century C</i>. The main advantages of <code>C</code> compared to the other two languages are:
</p>
<ul class="org-ul">
<li>Its stability (the programs written here are very likely to run unchanged in 20 years from now; what can be sure that this won't be true with <code>Python</code>).</li>
<li>The development tools that come with it are just spectacular (see the very short and very clear book of Brian Gough <a href="http://www.network-theory.co.uk/docs/gccintro/">An Introduction to GCC</a> to understand what I mean by that).</li>
</ul>
</div>
</div>

<div id="outline-container-orgf809f5b" class="outline-3">
<h3 id="orgf809f5b"><span class="section-number-3">1.2</span> Required software and libraries</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Since a <a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">Bash</a> or a <a href="https://en.wikipedia.org/wiki/Z_shell">Z shell</a> are going to be used, <code>Windows</code> users will have to install <a href="https://cygwin.com/index.html">Cygwin</a>, <code>Linux</code> and <code>MacOS</code> users should have the <code>bash</code> shell by default and the <code>zsh</code> shell readily available from their package manager. To dig deeper into the amazing possibilities (and spectacular editorial support) of these tools, check <a href="http://www.bash2zsh.com/">From Bash to Z Shell. Conquering the Command Line</a> by Kiddle, Peek and Stephenson.
</p>

<p>
The no-shell codes are going to be written in <code>C</code>, meaning that a <code>C</code> compiler together with the "classical" development tools (<code>make</code>, etc) are required. I'm going to use <a href="https://gcc.gnu.org/"><code>gcc</code></a> here.
</p>

<p>
The heavy computational work is going to be performed mainly by the <a href="http://www.gnu.org/software/gsl/">gsl</a> (the <i>GNU Scientific Library</i>) that is easily installed through your package manager (from now one, for windows users, the "package manager" refers to the one of <code>Cygwin</code>). The graphs are be generated with <a href="http://www.gnuplot.info/">gnuplot</a>; for a quick tutorial check <a href="http://physicspmb.ukzn.ac.za/index.php/Gnuplot_tutorial">http://physicspmb.ukzn.ac.za/index.php/Gnuplot_tutorial</a>, for an easy to navigate set of (sophisticated) recipes check <a href="http://www.gnuplotting.org/">http://www.gnuplotting.org/</a>. The data sets are in <a href="https://www.hdfgroup.org/HDF5/">HDF5</a> format and the <code>C</code> library, as well as the command line tools, developed by the HDF5 group are going to be heavily used here. 
</p>
</div>
</div>

<div id="outline-container-orgf4ddd77" class="outline-3">
<h3 id="orgf4ddd77"><span class="section-number-3">1.3</span> A remark on the code presentation</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a> approach is used here. This means that the code is broken into "manageable" pieces that are individually explained (when just reading the code is not enough), they are then pasted together to give the code that will actually get compiled. These manageable pieces are called blocks and each block gets a name like: <code>&lt;&lt;name-of-the-block&gt;&gt;</code> upon definition. It is then referred to by this name when used in subsequent codes. See Schulte, Davison, Dye and Dominik (2010) <a href="https://www.jstatsoft.org/article/view/v046i03">A Multi-Language Computing Environment for Literate Programming and Reproducible Research </a>for further explanations.
</p>
</div>
</div>
</div>


<div id="outline-container-org7c5c925" class="outline-2">
<h2 id="Getting-the-data"><a id="org7c5c925"></a><span class="section-number-2">2</span> Getting the data</h2>
<div class="outline-text-2" id="text-Getting-the-data">
<p>
The data we will start working with can be found at the following
address: <a href="http://xtof.disque.math.cnrs.fr/data/Data_POMC.hdf5">http://xtof.disque.math.cnrs.fr/data/Data_POMC.hdf5</a> and are
in <a href="http://www.hdfgroup.org/HDF5/">HDF5</a> format. We will start by downloading them. We will then rewrite them in a
<a href="https://fits.gsfc.nasa.gov/">FITS</a> format. Readers might be interest in this format since it is simpler than <code>HDF5</code> and its <code>C</code>
library is easier to use than the one of <code>HDF5</code>. Both formats are (essentially) fully supported by <code>Python</code> libraries (<a href="http://docs.h5py.org/en/latest/"><code>h5py</code></a> and <a href="https://pythonhosted.org/pyfits/#"><code>pyFits</code></a>). <code>HDF5</code> is fully supported in <code>R</code> by <a href="http://www.bioconductor.org/packages/release/bioc/html/rhdf5.html"><code>rhdf5</code></a> while the support for <code>FITS</code> is not as good (especially for writting) and is provided by <a href="https://cran.r-project.org/package=FITSio"><code>FITSio</code></a>
</p>
</div>

<div id="outline-container-org5ab4557" class="outline-3">
<h3 id="downloading-the-data"><a id="org5ab4557"></a><span class="section-number-3">2.1</span> Downloading the data</h3>
<div class="outline-text-3" id="text-downloading-the-data">
<p>
The data can be download from the command line using <code>wget</code> as follows:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org3522fdb">wget http://xtof.disque.math.cnrs.fr/data/Data_POMC.hdf5
</pre>
</div>
</div>
</div>


<div id="outline-container-org34052cc" class="outline-3">
<h3 id="python-code-converting-hdf5-to-fits"><a id="org34052cc"></a><span class="section-number-3">2.2</span> <code>Python</code> code converting <code>HDF5</code> to <code>FITS</code></h3>
<div class="outline-text-3" id="text-python-code-converting-hdf5-to-fits">
<p>
Doing the conversion with <code>Python</code> is rather straightforward but
requires, in addition to <code>numpy</code>, to modules: <a href="http://www.h5py.org/"><code>h5py</code></a> and <a href="http://www.stsci.edu/institute/software_hardware/pyfits/"><code>PyFITS</code></a>.
Once these two modules have been intalled&#x2013;the <a href="https://www.continuum.io/anaconda-overview"><code>anaconda</code></a> distribution
include <code>h5py</code> and <code>astropy</code> that is very similar to <code>PyFITS</code>&#x2013;write the
following in a file called <code>h5_to_fits.py</code> (see the
<a href="https://pythonhosted.org/pyfits/#"><code>PyFITS</code> documentation</a> for details):
</p>

<div class="org-src-container">
<pre class="src src-python" id="org94808dc"><span style="color: #2c5115;">#</span><span style="color: #888a85;">!/usr/bin/env python3</span>
<span style="color: #729fcf; font-weight: bold;">import</span> h5py
<span style="color: #729fcf; font-weight: bold;">import</span> pyfits
<span style="color: #729fcf; font-weight: bold;">import</span> numpy <span style="color: #729fcf; font-weight: bold;">as</span> np

<span style="color: #ff6347;">hdf_data</span> = h5py.File(<span style="color: #ad7fa8; font-style: italic;">"Data_POMC.hdf5"</span>,<span style="color: #ad7fa8; font-style: italic;">'r'</span>)
<span style="color: #ff6347;">time_hdf</span> = hdf_data[<span style="color: #ad7fa8; font-style: italic;">'time'</span>][...]
<span style="color: #ff6347;">stack_hdf</span> = hdf_data[<span style="color: #ad7fa8; font-style: italic;">'stack'</span>][...]
hdf_data.close()

pyfits.writeto(<span style="color: #ad7fa8; font-style: italic;">'Data_POMC.fits'</span>, stack_hdf.swapaxes(0,2).swapaxes(1,2))
pyfits.append(<span style="color: #ad7fa8; font-style: italic;">'Data_POMC.fits'</span>,time_hdf)

<span style="color: #ff6347;">hdulist</span> = pyfits.<span style="color: #729fcf;">open</span>(<span style="color: #ad7fa8; font-style: italic;">'Data_POMC.fits'</span>,mode=<span style="color: #ad7fa8; font-style: italic;">'update'</span>)
<span style="color: #ff6347;">prihdr</span> = hdulist[0].header
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'AUTHOR'</span>,<span style="color: #ad7fa8; font-style: italic;">'Andreas Pippow'</span>)
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'LENGTH'</span>,340,<span style="color: #ad7fa8; font-style: italic;">'Excitation wavelength (nm)'</span>)
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'DYE'</span>,<span style="color: #ad7fa8; font-style: italic;">'Fura-2'</span>)
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'UNITS'</span>,<span style="color: #ad7fa8; font-style: italic;">'ADU'</span>)
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'REF'</span>,<span style="color: #ad7fa8; font-style: italic;">'Joucla et al (2013) Cell Calcium. 54(2):71-85.'</span>)
<span style="color: #ff6347;">prihdr</span>[<span style="color: #ad7fa8; font-style: italic;">'comment'</span>] = <span style="color: #ad7fa8; font-style: italic;">'A stim. (depol. induced calcium entry)\</span>
<span style="color: #ad7fa8; font-style: italic;">comes at time 527'</span>
<span style="color: #ff6347;">prihdr</span> = hdulist[1].header
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'UNITS'</span>,<span style="color: #ad7fa8; font-style: italic;">'second'</span>)
prihdr.<span style="color: #729fcf;">set</span>(<span style="color: #ad7fa8; font-style: italic;">'TIME'</span>,527,<span style="color: #ad7fa8; font-style: italic;">'Stimulation time'</span>)
hdulist.flush()
hdulist.close()
</pre>
</div>

<p>
Once this code has been saved into a file called <code>h5_to_fits.py</code>, change its <a href="https://en.wikipedia.org/wiki/File_system_permissions">file permission</a> to make executable and use it:
</p>

<div class="org-src-container">
<pre class="src src-bash" id="org79d5f5c">chmod u+x h5_to_fits.py
./h5_to_fits.py
</pre>
</div>

<p>
After running this short code you will have file <code>Data_POMC.fits</code> in your working directory. You can quickly visualize it with <a href="http://fiji.sc/">ImageJ</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org4fdd5ad" class="outline-2">
<h2 id="pomc-data-visualization"><a id="org4fdd5ad"></a><span class="section-number-2">3</span> POMC Data visualization</h2>
<div class="outline-text-2" id="text-pomc-data-visualization">
</div>
<div id="outline-container-org1f74d72" class="outline-3">
<h3 id="data-summaries-with-the-hdf5-tools"><a id="org1f74d72"></a><span class="section-number-3">3.1</span> Data summaries with the <code>HDF5</code> tools</h3>
<div class="outline-text-3" id="text-data-summaries-with-the-hdf5-tools">
<p>
We can start by using some of the <a href="https://support.hdfgroup.org/HDF5/Tutor/tools.html">"tools"</a> that come with the <code>HDF5</code> library in order to get a quick idea on the data file structure. We can do that with <code>h5ls</code> that lists (by default) the first level of a file:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgf185594">h5ls Data_POMC.hdf5
</pre>
</div>

<pre class="example">
stack                    Dataset {60, 80, 168}
time                     Dataset {168}

</pre>

<p>
We see that two "Datasets" are included in the file, one named <code>stack</code> (a 3-dimensional dataset) and the other named <code>time</code> (one dimensional).
</p>

<p>
The more sophisticated program <code>h5dump</code> gives us more details with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org9311767">h5dump -n 1 Data_POMC.hdf5
</pre>
</div>

<pre class="example">
HDF5 "Data_POMC.hdf5" {
FILE_CONTENTS {
 group      /
 attribute  /README
 dataset    /stack
 attribute  /stack/CCD chip dimensions
 attribute  /stack/Dye
 attribute  /stack/Excitation wavelength
 attribute  /stack/Recordings performed by
 attribute  /stack/Reference
 attribute  /stack/Units
 dataset    /time
 attribute  /time/Stimulation time
 attribute  /time/Units
 }
}
</pre>

<p>
We can visualize the content of the <code>README</code> attribute with (result not shown):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org0d2d3b0">h5dump -a README Data_POMC.hdf5
</pre>
</div>

<p>
The content of attribute <code>CCD chip dimensions</code> of Dataset <code>stack</code> is most easily visualized with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orge8779ab">h5dump -N <span style="color: #ad7fa8; font-style: italic;">"CCD chip dimensions"</span> Data_POMC.hdf5
</pre>
</div>

<pre class="example">
HDF5 "Data_POMC.hdf5" {
ATTRIBUTE "CCD chip dimensions" {
   DATATYPE  H5T_STRING {
      STRSIZE H5T_VARIABLE;
      STRPAD H5T_STR_NULLTERM;
      CSET H5T_CSET_UTF8;
      CTYPE H5T_C_S1;
   }
   DATASPACE  SCALAR
   DATA {
   (0): "60 x 80 pixels"
   }
}
}
</pre>
</div>
</div>

<div id="outline-container-org860daf1" class="outline-3">
<h3 id="c-code-printing-to-stdout-part-of-the-data-set-for-gnuplot"><a id="org860daf1"></a><span class="section-number-3">3.2</span> <code>C</code> code printing to <code>STDOUT</code> part of the data set for <code>gnuplot</code></h3>
<div class="outline-text-3" id="text-c-code-printing-to-stdout-part-of-the-data-set-for-gnuplot">
<p>
We will regenerate the first figure of the course with <a href="http://gnuplot.info/"><code>gnuplot</code></a> and for that we need to extract the "interesting part" of the data file <code>Data_POMC.hdf5</code>. This will be done with a short <code>C</code> code that opens the file, gets the <code>stack</code> Dataset. By the "interesting part" we mean the specification of ranges of rows and columns of the CCD chip. The display we want to generate is a matrix of ADU time series (with the lowest interesting row of the CCD chip at the bottom and the lowest interesting column at the left). Each element of the matrix will correspond a pixel of the interesting part. The ADU time series will all be display using the same horizontal and vertical scales. Since we will display all these time series on a single plot, we will have to scale them. Our program will output data tailored for <a href="http://gnuplot.info/">gnuplot</a> display in ASCII format to the standard output. The data will be organized in two columns with the scaled time (first column) and scaled ADU (second column). Measurements corresponding to successive pixels are separated by a blank line (this allows us to plot the whole set of time series with a single and <i>simple</i> <code>plot</code> command in <code>gnuplot</code>, see pp 85-86 of <a href="http://gnuplot.info/docs_5.0/gnuplot.pdf">the gnuplot manual</a>). The output starts with "general information" on the data set entered as a <code>gnuplot</code> comment, that is, following a "#". Our presentation of the code follows what is properly called <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>, that is, the program is broken into logical pieces&#x2014;code blocks whose names appear like <code>&lt;&lt;code-block-name&gt;&gt;</code>&#x2014;and only its skeleton is presented first as here for our program <code>read_POMC_stack</code> that should be saved in a file named <code>read_POMC_stack.c</code>.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org5f2b6ee">&lt;&lt;read_POMC_stack-include&gt;&gt;
&lt;&lt;read_POMC_stack-define&gt;&gt;

<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;read_POMC_stack-read-args&gt;&gt;
  &lt;&lt;read_POMC_stack-open-FILE-and-read-DSET&gt;&gt;
  &lt;&lt;read_POMC_stack-find-min-and-max-in-DSET&gt;&gt;
  &lt;&lt;read_POMC_stack-print-results&gt;&gt;
  &lt;&lt;read_POMC_stack-close-file&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;

}
</pre>
</div>

<p>
The first code block <code>&lt;&lt;read_POMC_stack-include&gt;&gt;</code> contains the necessary <a href="https://en.wikipedia.org/wiki/C_preprocessor#Including_files">include directives</a>. We need <code>&lt;stdio.h&gt;</code> to call the printing functions, <code>&lt;stdlib.h&gt;</code> for the <code>atoi</code> function and the other two <code>&lt;hdf5.h&gt;</code> and <code>&lt;hdf5_hl.h&gt;</code> to get the hdf5 library functions.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org6f2aa59"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
</pre>
</div>

<p>
Code block <code>&lt;&lt;read_POMC_stack-define&gt;&gt;</code> contains <a href="https://en.wikipedia.org/wiki/C_preprocessor#Macro_definition_and_expansion">expansions</a> definitions. This is where the parameters of the program are defined (to keep the code short we pass only the limits of the interesting part as arguments): the file we are going to work on (<code>FILE</code>), the Dataset of interest within the file (<code>DSET</code>):
</p>

<div class="org-src-container">
<pre class="src src-C" id="org40069ec"><span style="color: #3B5998;">#define</span> <span style="color: #ff6347;">FILE</span> <span style="color: #ad7fa8; font-style: italic;">"Data_POMC.hdf5"</span>
<span style="color: #3B5998;">#define</span> <span style="color: #ff6347;">DSET</span> <span style="color: #ad7fa8; font-style: italic;">"stack"</span>
</pre>
</div>

<p>
Code block <code>&lt;&lt;read_POMC_stack-read-args&gt;&gt;</code> reads the four arguments of the program: <code>first_row</code>, <code>last_row</code>, <code>first_col</code>, <code>last_col</code>. The only check that is made is that four argument are given. <i>This is very rudimentary, we should name the argument to get a proper code and make more checks, but this program is not meant for general use</i>.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org565ff29"><span style="color: #729fcf; font-weight: bold;">if</span> (argc != 5) {
  fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Expecting four arguments\n"</span>);
  <span style="color: #729fcf; font-weight: bold;">return</span> -1;
}
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">first_row</span> = atoi(argv[1]);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">last_row</span> = atoi(argv[2]);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">first_col</span> = atoi(argv[3]);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">last_col</span> = atoi(argv[4]);
</pre>
</div>

<p>
Code block <code>&lt;&lt;read_POMC_stack-open-FILE-and-read-DSET&gt;&gt;</code> opens the <code>FILE</code>, gets information on the dimensions, initializes the number of rows (<code>nrow</code>), the number of columns (<code>ncol</code>) and the number of time points (<code>nsamp</code>) before reading the data, storing the result in the 3D array <code>data</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org38e0bb2"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Open FILE</span>
<span style="color: #8ae234; font-weight: bold;">hid_t</span> <span style="color: #ff6347;">file_id</span> = H5Fopen (FILE, H5F_ACC_RDONLY, H5P_DEFAULT);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Get dimensions of 3D object contained in DSET</span>
<span style="color: #8ae234; font-weight: bold;">hsize_t</span> <span style="color: #ff6347;">dims</span>[3];
H5LTget_dataset_info(file_id,DSET,dims,<span style="color: #8ae234;">NULL</span>,<span style="color: #8ae234;">NULL</span>);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nrow</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[0];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">ncol</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[1];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nsamp</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[2];
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Read DSET in DATA</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">data</span>[nrow][ncol][nsamp];
H5LTread_dataset_int(file_id,<span style="color: #ad7fa8; font-style: italic;">"/stack"</span>,data);
</pre>
</div>

<p>
The strategy used in the last code block will work fine for "small" datasets since the line <code>int data[nrow][ncol][nsamp];</code> automatically allocates memory in the <code>stack</code>. If you run into problems running a similar code you would have to allocate "by hand" memory in the <code>heap</code> with something like:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgc71d2ce"><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">data</span> = malloc(nrow*ncol*nsamp*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
</pre>
</div>

<p>
Since such an allocation is done by hand <i>you would have to free the memory yourself before the</i> <code>return</code> <i>statement</i> with:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgeda5c9d">free(data);
</pre>
</div>

<p>
Within the code, statements like: <code>data[i][j][k]</code> should then be replaced by: <code>data[(i*ncol+j)*nsamp+k]</code>.
</p>

<p>
Code block <code>&lt;&lt;read_POMC_stack-find-min-and-max-in-DSET&gt;&gt;</code> looks at each measurement (ADU) of the interesting part and find the smallest and largest values stored in variables <code>adu_min</code> and <code>adu_max</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org8cada88"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Find out the smallest and largest observations</span>
<span style="color: #2c5115;">// </span><span style="color: #888a85;">in the selected part of DSET</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">adu_max</span>=0;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">adu_min</span>=10000;
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=first_row; i&lt;last_row; i++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=first_col; j&lt;last_col; j++)  {
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span> = data[i][j][k];
      <span style="color: #729fcf; font-weight: bold;">if</span> (adu &lt; adu_min) adu_min=adu;
      <span style="color: #729fcf; font-weight: bold;">if</span> (adu &gt; adu_max) adu_max=adu;
    }
  }
}
</pre>
</div>

<p>
Code block <code>&lt;&lt;read_POMC_stack-print-results&gt;&gt;</code> prints some general information on the dataset and on the interesting part of it (as <code>gnuplot</code> comments) before printing the scaled time and adu:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org0b8b92e"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Print some info to STDOUT</span>
printf(<span style="color: #ad7fa8; font-style: italic;">"# Data set stack from file: %s\n"</span>,FILE);
printf(<span style="color: #ad7fa8; font-style: italic;">"# Data set dimensions: (%d,%d,%d)\n"</span>,nrow,ncol,nsamp);
printf(<span style="color: #ad7fa8; font-style: italic;">"# Using rows from %d (inclusive) to %d (exclusive)\n"</span>,first_row,last_row);
printf(<span style="color: #ad7fa8; font-style: italic;">"# Using columns from %d (inclusive) to %d (exclusive)\n"</span>,first_col,last_col);
printf(<span style="color: #ad7fa8; font-style: italic;">"# Minimal ADU in this range: %d; maximal value: %d\n"</span>,adu_min,adu_max);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu_delta</span> = (<span style="color: #8ae234; font-weight: bold;">double</span>) (adu_max-adu_min);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Write the DATA in a 2 columns format with time in the first and normalized</span>
<span style="color: #2c5115;">// </span><span style="color: #888a85;">ADU in the second</span>
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=first_row; i&lt;last_row; i++) {
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">y_min</span> = i-first_row;
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=first_col; j&lt;last_col; j++)  {
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span> = (data[i][j][k]-adu_min)/adu_delta+y_min;
      printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g\n"</span>,((<span style="color: #8ae234; font-weight: bold;">double</span>) k/nsamp+j-first_col),adu);
    }
    printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
  }
}
</pre>
</div>

<p>
Code block <code>&lt;&lt;read_POMC_stack-close-file&gt;&gt;</code> close the hdf5 file:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org892ea5f">H5Fclose (file_id);
</pre>
</div>

<p>
Once the code has been properly "tangled" and stored in a file named <code>read_POMC_stack.c</code> (in the <code>code</code> sub-directory) we compile it with <a href="https://gcc.gnu.org/">gcc</a> (we could also do it with another compiler):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org282b93b">gcc -W -g -o code/read_POMC_stack code/read_POMC_stack.c -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We then call our code and <a href="https://en.wikipedia.org/wiki/Redirection_(computing)">redirect</a> the output to a file called <code>stack.txt</code>. Row 23 is the first row of interest while row 34 is the last of interest. Column 33 is the first of interest while column 43 is the last one (don't forget we start counting at 0 and we are using <code>Python</code> convention):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org20782e6">./code/read_POMC_stack 23 35 33 44 &gt; stack.txt
</pre>
</div>

<p>
We can look at the first lines of <code>stack.txt</code> with the <code>head</code> program:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org044e3c1">head stack.txt
</pre>
</div>

<pre class="example">
# Data set stack from file: Data_POMC.hdf5
# Data set dimensions: (60,80,168)
# Using rows from 23 (inclusive) to 35 (exclusive)
# Using columns from 33 (inclusive) to 44 (exclusive)
# Minimal ADU in this range: 261; maximal value: 1118
0 0.0536756
0.00595238 0.0793466
0.0119048 0.0548425
0.0178571 0.0700117
0.0238095 0.0723454
</pre>


<p>
Our figure is then simply generated with the following <code>gnuplot</code> commands:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="orgb8d0e80"><span style="color: #8ae234;">unset</span> key 
<span style="color: #8ae234;">unset</span> tics
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">'stack.txt'</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
     <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/plot_central_CCD_part_gnuplot.svg" class="org-svg" alt="Recordings from central part of CCD chip" align="center" width="600" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 1: </span><a id="org26733c1"></a> Central part of the CCD chip (rows between 23 and 32, inclusive, starting at 0, row 23 at the bottom; columns between 35 and 43, column 35 on the left).</p>
</div>


<p>
We get the second figure that shows the ADU time series of pixel (27,39) by first dumping the data to a file:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org4a49e46">./code/read_POMC_stack 27 28 39 40 &gt; sgl_pixel.txt 
</pre>
</div>

<p>
Then, within <code>gnuplot</code>:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="org4265536"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Time (s)"</span> 
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"ADU count"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> tics
<span style="color: #8ae234;">unset</span> key
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">'sgl_pixel.txt'</span> <span style="color: #8ae234; font-weight: bold;">using</span> (525+25*$1):(776+$2*(937-776)) \
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span> 
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/sgl_pxl_gnuplot.svg" class="org-svg" alt="Recordings from entral pixel of CCD chip" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 2: </span><a id="orge063de2"></a> "Central pixel" (27,39) of the CCD chip.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org447dbba" class="outline-2">
<h2 id="why-does-a-proper-noise-model-matter"><a id="org447dbba"></a><span class="section-number-2">4</span> Why does a proper noise model matter?</h2>
<div class="outline-text-2" id="text-why-does-a-proper-noise-model-matter">
</div>

<div id="outline-container-orgb33ec7e" class="outline-3">
<h3 id="figure-data-=-deterministic-part-+-noise"><a id="orgb33ec7e"></a><span class="section-number-3">4.1</span> Figure <code>data = deterministic part + noise</code></h3>
<div class="outline-text-3" id="text-figure-data-=-deterministic-part-+-noise">
</div>

<div id="outline-container-org9e378ad" class="outline-4">
<h4 id="org9e378ad"><span class="section-number-4">4.1.1</span> <code>C</code> code requirements</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
We write a short <code>C</code> code that takes:
</p>
<dl class="org-dl">
<dt><code>F_inf</code></dt><dd>an asymptotic value whose default is 800.</dd>
<dt><code>Delta</code></dt><dd>a jump size whose default is 150.</dd>
<dt><code>beta</code></dt><dd>an inverse time constant whose default is 0.1.</dd>
<dt><code>t_onset</code></dt><dd>an onset time whose default is 5.</dd>
<dt><code>t_0</code></dt><dd>the time at which the observation starts (default of 0).</dd>
<dt><code>delta_t</code></dt><dd>the interval between successive observations (default of 0.15).</dd>
<dt><code>n_obs</code></dt><dd>the number of observations (default of 168).</dd>
</dl>

<p>
The program returns a three columns text file containing:
</p>
<dl class="org-dl">
<dt>first column</dt><dd>the observation times.</dd>
<dt>second column</dt><dd>the corresponding deterministic part.</dd>
<dt>third column</dt><dd>the observations (<code>deterministic part + noise</code>).</dd>
</dl>

<p>
Here the deterministic part is given by:
</p>
\begin{equation}\label{eq:deterministic-mono-exp}
 \mathtt{F}(t) = \mathtt{F\_\mathtt{inf}} + H(t-\mathtt{t\_\mathtt{onset}}) \mathtt{Delta} \exp \left(-\mathtt{beta} (t-\mathtt{t\_\mathtt{onset}})\right) \, ,
\end{equation}
<p>
where \(H(\;)\) stands for the <a href="https://en.wikipedia.org/wiki/Heaviside_step_function">Heaviside step function</a>, a function that is null for negative values of its argument and 1 otherwise. Since we are working in discrete time, <i>t</i> takes only a finite set of values given by <i>t</i> = <code>t_0</code> + i x <code>delta_t</code> and we have:
</p>
\begin{equation}\label{eq:deterministic-mono-exp-discrete}
 \mathtt{F}_i = \mathtt{F\_\mathtt{inf}} + H(\mathtt{t\_0}+i \, \mathtt{delta\_t}-\mathtt{t\_\mathtt{onset}}) \mathtt{Delta} \exp \left(-\mathtt{beta} (\mathtt{t\_0}+i \, \mathtt{delta\_t}-\mathtt{t\_\mathtt{onset}})\right) \quad \mathrm{for} \quad i=0,1,\ldots,\mathtt{n\_\mathtt{obs}}-1 \, .
\end{equation}
<p>
The observations are generated by drawing a random number from a Poisson distribution whose parameter is the deterministic part at the time considered:
</p>
\begin{equation}\label{eq:obs-mono-exp-discrete}
\mathtt{Y}_i \sim \mathtt{Pois}(\mathtt{F}_i) \, .
\end{equation}

<p>
Compared with our previous program, <code>read_POMC_stack</code>, we have to do more efforts at the argument reading stage and we have to do more "interesting" computations since we have to draw random numbers, compute exponential, etc. All this technical part will be carried out by calling functions from the <a href="https://www.gnu.org/software/gsl/">GSL</a> (<code>GNU Scientific Library</code>). Its <a href="https://www.gnu.org/software/gsl/manual/html_node/">Reference manual</a> is clearly written and contains many examples that are the best way to learn how to use the library's functions.
</p>
</div>
</div>

<div id="outline-container-org533e3ec" class="outline-4">
<h4 id="org533e3ec"><span class="section-number-4">4.1.2</span> Program <code>sim_mono_exp</code></h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
We now write a program <code>sim_mono_exp</code> (that we store in a file called <code>sim_mono_exp.c</code> in the <code>code</code> sub-directory) fulfilling the requirements of the previous section. The code skeleton is:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org1286b99">&lt;&lt;sim_mono_exp-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;sim_mono_exp-usage&gt;&gt;
  &lt;&lt;sim_mono_exp-read-args&gt;&gt;
  &lt;&lt;sim_mono_exp-setup-rng&gt;&gt;
  &lt;&lt;sim_mono_exp-simulate-and-print-results&gt;&gt;
  &lt;&lt;sim_mono_exp-free-rng&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
Every program that does some (half) decent command line argument reading, like  <code>sim_mono_exp</code>, will have a <code>usage</code> output printed to the standard output (<code>stdout</code>) with a short description of what the program arguments are and how to use them. This string is here defined in code block <code>&lt;&lt;sim_mono_exp-usage&gt;&gt;</code>.
</p>

<p>
Code block <code>&lt;&lt;sim_mono_exp-include&gt;&gt;</code> contains the include directives, <code>getopt</code> is required for reading the command line arguments, <code>math</code> for the <code>exp</code> function and two <code>gsl</code> directives are required for the random number generation functions.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgfee342c"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_rng.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_randist.h&gt;</span>
</pre>
</div>

<p>
Code block <code>&lt;&lt;sim_mono_exp-usage&gt;&gt;</code> declares string <code>usage</code> (making use of the <a href="https://en.wikipedia.org/wiki/C_syntax#String_literal_concatenation">string literal concatenation</a>). That is what gets printed to the <code>stdout</code> when something "wrong" is entered by the user:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org7b412de"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--F_inf=real] [--Delta=real] [--beta=real] [--t_onset=real] ...\n"</span> \
  <span style="color: #ad7fa8; font-style: italic;">"          ... [--t_0=real] [--delta_t=real] [--n_obs=int]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --F_inf &lt;positive real&gt;: asymptotic value (default 800)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --Delta &lt;positive real&gt;: signal jump amplitude (default 150)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --beta &lt;positive real&gt;: inverse time constant (default 0.1)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --t_onset &lt;real&gt;: the stimulus onset time (default 5)\n"</span>      \
  <span style="color: #ad7fa8; font-style: italic;">"  --t_0 &lt;real&gt;: observations start time (default 0)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --delta_t &lt;positive real&gt;: sampling period (default 0.15)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --n_obs &lt;positive integer&gt;: number of observations (default 168)\n\n"</span>;  
</pre>
</div>

<p>
Code block <code>&lt;&lt;sim_mono_exp-read-args&gt;&gt;</code> reads the command line arguments, checks that they have acceptable values and initializes the following variables: <code>F_inf</code>, <code>Delta</code>, <code>beta</code>, <code>t_onset</code>, <code>t_0</code>, <code>delta_t</code>, <code>n_obs</code>. Here the <a href="https://en.wikipedia.org/wiki/Getopt"><code>getop_long</code></a> function is heavily used. This is the longest code block of the program&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-C" id="org92aaaba"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = 800;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = 150;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = 0.1;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = 5;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_0</span> = 0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = 0.15;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_obs</span> = 168;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"F_inf"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"Delta"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'d'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"beta"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'b'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"t_onset"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'o'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"t_0"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'s'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"delta_t"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'t'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"n_obs"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'n'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:d:b:o:s:t:n"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      F_inf = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (F_inf &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"The asymptotic value should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'d'</span>:
    {
      Delta = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (Delta &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Delta should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'b'</span>:
    {
      beta = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (beta &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"beta should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      } 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'o'</span>:
    {
      t_onset = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg); 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'s'</span>:
    {
      t_0 = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg); 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'t'</span>:
    {
      delta_t = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"delta_t should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      } 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'n'</span>:
    {
      n_obs = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (n_obs &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"n_obs should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;  
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
}
</pre>
</div>


<p>
Code block <code>&lt;&lt;sim_mono_exp-setup-rng&gt;&gt;</code> sets up the a <code>random number generator</code> named <code>r</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org0c6c6f6"><span style="color: #8ae234; font-weight: bold;">gsl_rng</span> * <span style="color: #ff6347;">r</span>;
gsl_rng_env_setup();
r = gsl_rng_alloc(gsl_rng_default);
</pre>
</div>

<p>
Code block <code>&lt;&lt;sim_mono_exp-free-rng&gt;&gt;</code> frees the memory occupied by the rng <code>r</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org531fa7c">gsl_rng_free(r);
</pre>
</div>

<p>
Code block <code>&lt;&lt;sim_mono_exp-simulate-and-print-results&gt;&gt;</code> computes the deterministic part (variable <code>ideal</code> in the code) and generates the observations by calling <code>gsl_ran_poisson</code> before writing the results to the <code>stdout</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org8bea210"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;n_obs; i++) {
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t</span> = t_0 + i*delta_t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">ideal</span> = F_inf;
  <span style="color: #729fcf; font-weight: bold;">if</span> (t &gt;= t_onset) ideal += Delta*exp(-beta*(t-t_onset));
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">obs</span> = gsl_ran_poisson(r, ideal);
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g %g\n"</span>,t,ideal,obs);
}
</pre>
</div>

<p>
Once the code has been properly "tangled" and stored in a file named <code>sim_mono_exp.c</code> (in the <code>code</code> sub-directory) we compile it with <a href="https://gcc.gnu.org/">gcc</a> (we could also do it with another compiler):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgee2282a">gcc -W -g -o code/sim_mono_exp code/sim_mono_exp.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-orga13b492" class="outline-4">
<h4 id="orga13b492"><span class="section-number-4">4.1.3</span> <code>sim_mono_exp</code> usage</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
We can now check that our new program prints some hint when a wrong parameter value is given at the command line:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org092ddfa">./code/sim_mono_exp --F_inf=-10
</pre>
</div>

<pre class="example">
The asymptotic value should be &gt; 0.

</pre>

<p>
We can also get help with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org0fc01dd">./code/sim_mono_exp --help
</pre>
</div>

<pre class="example">
usage: ./code/sim_mono_exp [--F_inf=real] [--Delta=real] [--beta=real] [--t_onset=real] ...
          ... [--t_0=real] [--delta_t=real] [--n_obs=int]

  --F_inf &lt;positive real&gt;: asymptotic value (default 800)
  --Delta &lt;positive real&gt;: signal jump amplitude (default 150)
  --beta &lt;positive real&gt;: inverse time constant (default 0.1)
  --t_onset &lt;real&gt;: the stimulus onset time (default 5)
  --t_0 &lt;real&gt;: observations start time (default 0)
  --delta_t &lt;positive real&gt;: sampling period (default 0.15)
  --n_obs &lt;positive integer&gt;: number of observations (default 168)

</pre>

<p>
We get a simulation using parameters parameter values leading results similar to the previous courses with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org094aca0">./code/sim_mono_exp --F_inf=100 --Delta=900 --beta=1 --n_obs=51 <span style="color: #ad7fa8; font-style: italic;">\</span>
                    --t_onset=0 --t_0=0 --delta_t=0.1 &gt; sim_mono.txt
</pre>
</div>

<p>
By default, the random number generator used by the <code>GSL</code> and therefore by our <code>sim_mono_exp</code> code is the <code>Mersenne-Twister</code> of Matsumoto and Nishimura (version of 2002) and the default seed is zero (if you have no clue about random number generators, check the chapter <a href="http://www.iro.umontreal.ca/~lecuyer/myftp/papers/handstat2.pdf">"Random Number Generation"</a> by <a href="http://www.iro.umontreal.ca/~lecuyer/">Pierre L'Ecuyer</a> in the <i>Handbook of Computational Statistics</i>). We can change both of these features, setting the seed at 123 and using the "taus2" generator of L'Ecuyer by setting environment variables like this:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org064e53b"><span style="color: #ff6347;">GSL_RNG_SEED</span>=123 <span style="color: #ff6347;">GSL_RNG_TYPE</span>=taus2 ./code/sim_mono_exp --F_inf=100 <span style="color: #ad7fa8; font-style: italic;">\</span>
            --Delta=900 --beta=1 --n_obs=51 --t_onset=0 --t_0=0 <span style="color: #ad7fa8; font-style: italic;">\</span>
            --delta_t=0.1 &gt; sim_mono2.txt
</pre>
</div>
</div>
</div>

<div id="outline-container-org8bec30e" class="outline-4">
<h4 id="org8bec30e"><span class="section-number-4">4.1.4</span> Making the figure</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
We get a plot of the simulated data together with the deterministic curve and the two selected points with the command sequence that follows. We are making use of the <i>substitution of system commands in backquotes</i> capability of <code>gnuplot</code> (see the section with that name on p. 42 of the <a href="http://gnuplot.info/docs_5.0/gnuplot.pdf">User manual</a>). In order to show our two chosen points&#x2013;whose time and amplitude coordinates are located on lines 37 and 102 of the file we just generated, <code>sim_mono.txt</code>&#x2013;we extract the first column on line 37 to get the time of the first point with <code>t1 = "`sed -n '37,37p' sim_mono.txt | awk '{print $1}'`"</code> (the <a href="http://www.grymoire.com/Unix/Sed.html"><code>sed</code></a> command extracts the line and <a href="https://en.wikipedia.org/wiki/Pipeline_(Unix)">pipes</a> the result to the <a href="https://en.wikipedia.org/wiki/AWK"><code>awk</code></a> command that extracts the first column) and the third column of the same line to get the amplitude (we repeat this two commands sequences to get the coordinates of the second point). The second data set that gets plotted is again obtained by piping the result of the execution of a shell command: <code>"&lt;sed -n '37,37p' sim_mono.txt"</code>. Since <code>gnuplot</code> has limited capabilities for manipulating data files, we are using general POSIX programs like <code>sed</code> and <code>awk</code> to do it. 
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="orgf35fbcc"><span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Time (s)"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Observations"</span>
<span style="color: #8ae234;">unset</span> key
<span style="color: #ff6347;">t1 =</span> <span style="color: #ad7fa8; font-style: italic;">"`sed -n '4,4p' sim_mono.txt | awk '{print $1}'`"</span>
<span style="color: #ff6347;">y1 =</span> <span style="color: #ad7fa8; font-style: italic;">"`sed -n '4,4p' sim_mono.txt | awk '{print $3}'`"</span>
<span style="color: #ff6347;">t2 =</span> <span style="color: #ad7fa8; font-style: italic;">"`sed -n '31,31p' sim_mono.txt | awk '{print $1}'`"</span>
<span style="color: #ff6347;">y2 =</span> <span style="color: #ad7fa8; font-style: italic;">"`sed -n '31,31p' sim_mono.txt | awk '{print $3}'`"</span>
<span style="color: #8ae234;">set</span> arrow 1 from t1,0 to t1,y1 nohead dashtype <span style="color: #ad7fa8; font-style: italic;">'.'</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 1
<span style="color: #8ae234;">set</span> label 1 <span style="color: #ad7fa8; font-style: italic;">"t1"</span> at t1+0.1,25
<span style="color: #8ae234;">set</span> arrow 2 from 0,y1 to t1,y1 nohead dashtype <span style="color: #ad7fa8; font-style: italic;">'.'</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 1
<span style="color: #8ae234;">set</span> label 2 <span style="color: #ad7fa8; font-style: italic;">"y1"</span> at 0.1,y1-25
<span style="color: #8ae234;">set</span> arrow 3 from t2,0 to t2,y2 nohead dashtype <span style="color: #ad7fa8; font-style: italic;">'.'</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 1
<span style="color: #8ae234;">set</span> label 3 <span style="color: #ad7fa8; font-style: italic;">"t2"</span> at t2+0.1,25
<span style="color: #8ae234;">set</span> arrow 4 from 0,y2 to t2,y2 nohead dashtype <span style="color: #ad7fa8; font-style: italic;">'.'</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 1
<span style="color: #8ae234;">set</span> label 4 <span style="color: #ad7fa8; font-style: italic;">"y2"</span> at 0.1,y2+25
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">0:5</span>][<span style="color: #8ae234;">0:1100</span>] <span style="color: #ad7fa8; font-style: italic;">'sim_mono.txt'</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> <span style="color: #8ae234; font-weight: bold;">pointtype</span> 6 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>,\
     <span style="color: #ad7fa8; font-style: italic;">""</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"red"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2,\
     <span style="color: #ad7fa8; font-style: italic;">"&lt;sed -n '4,4p' sim_mono.txt"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> <span style="color: #8ae234; font-weight: bold;">pointtype</span> 7 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>,\
     <span style="color: #ad7fa8; font-style: italic;">"&lt;sed -n '31,31p' sim_mono.txt"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> <span style="color: #8ae234; font-weight: bold;">pointtype</span> 7 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/mono_exp_sim_gnuplot.svg" class="org-svg" alt="Recordings from entral pixel of CCD chip" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 3: </span><a id="org27dac29"></a> Simulated data with an intantaneous jump and a mono-exponential decay (red curve); the "observations" (circles) were drawn from a Poisson distribution whose parameter was the deterministic part (the red curve). The two "selected point" are indicated (blue discs).</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgf6c54f4" class="outline-3">
<h3 id="orgf6c54f4"><span class="section-number-3">4.2</span> Simple case simulation</h3>
<div class="outline-text-3" id="text-4-2">
<p>
We explore here in a simple setting (only one model parameter to estimate) the consequences at the <a href="https://en.wikipedia.org/wiki/Statistical_inference">inference</a> level of a wrong noise model. So we start from the "simple" mono-exponential decay of the previous section, assume <i>that only the inverse time constant</i>, <code>beta</code>, is unknown and that only two observations, like the two points of the <a href="#orgf35fbcc">previous figure</a>, are available. We then consider two <a href="https://en.wikipedia.org/wiki/Estimator">estimators</a>, first the classical residual sum of square (<code>RSS</code>) minimizer:
</p>
\begin{equation}\label{eq:classical-RSS}
\tilde{\beta} \equiv \arg \min_{\beta} \sum_{i=1}^2\left(y_i  -\mathtt{F\_\mathtt{inf}} - H(t_i-\mathtt{t\_\mathtt{onset}})\, \mathtt{Delta}\, \exp \left(-\beta (t_i-\mathtt{t\_\mathtt{onset}})\right) \right)^2 
\end{equation} 
<p>
and the minimizer of a residual sum computed from the square root of the observations and the predictions:
</p>
\begin{equation}\label{eq:sqrt-RSS}
\hat{\beta} \equiv \arg \min_{\beta} \sum_{i=1}^2\left(\sqrt{y_i}  -\sqrt{\mathtt{F\_\mathtt{inf}} + H(t_i-\mathtt{t\_\mathtt{onset}})\, \mathtt{Delta}\, \exp \left(-\beta (t_i-\mathtt{t\_\mathtt{onset}})\right)} \right)^2 \, .
\end{equation}
</div>

<div id="outline-container-org9df79fc" class="outline-4">
<h4 id="org9df79fc"><span class="section-number-4">4.2.1</span> What do we want to do?</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
We want to study the <a href="https://en.wikipedia.org/wiki/Sampling_distribution">sampling distribution</a> of the two estimators. To that end we are going to simulate a large number of data sets \(\{(t_1,y1),(t_2,y_2)\}\) according to the model specified by Eq. \ref{eq:deterministic-mono-exp-discrete} and \ref{eq:obs-mono-exp-discrete}. The two estimators will be obtained from each simulated data set and the empirical distribution of each estimator will be approximated by constructing an histogram from the set of estimators. In other words, we are going to do what is technically called a <a href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)#Parametric_bootstrap">parametric bootstrap</a>. 
</p>
</div>
</div>

<div id="outline-container-org7e988da" class="outline-4">
<h4 id="org7e988da"><span class="section-number-4">4.2.2</span> <code>C</code> implementation for a single case</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
Minimizing a residual sum of squares can be done with linear or, depending on the problem, non-linear regression routines. The predictors in the two cases above (Eq. \ref{eq:classical-RSS} and \ref{eq:sqrt-RSS}) are non-linear functions of the parameter of interest (\(\beta\)). We are going to use here the routines described in the <a href="https://www.gnu.org/software/gsl/manual/html_node/Nonlinear-Least_002dSquares-Fitting.html#Nonlinear-Least_002dSquares-Fitting">Nonlinear Least-Squares Fitting</a> chapter of the <code>gsl</code> manual. We will moreover start with a single case (the one we just simulated) before embarking in the full scale simulation study. We can then just adapt the <a href="https://www.gnu.org/software/gsl/manual/html_node/Nonlinear-Least_002dSquares-Exponential-Fit-Example.html#Nonlinear-Least_002dSquares-Exponential-Fit-Example">first example</a> of the <code>gsl</code> manual to suit our needs.
</p>
</div>

<div id="outline-container-orge77a6f4" class="outline-5">
<h5 id="orge77a6f4"><span class="section-number-5">4.2.2.1</span> A note on the nonlinear least-squares routines</h5>
<div class="outline-text-5" id="text-4-2-2-1">
<p>
The functions that the non-linear regression routines of the <code>gsl</code> minimize must return a <i>vector of residuals</i> not the sum of squared residuals. They must take three formal parameters:
</p>

<dl class="org-dl">
<dt>x</dt><dd>a (pointer to a gsl) vector of model parameters (in the case of Eq. \ref{eq:classical-RSS} and \ref{eq:sqrt-RSS}, this vector contains a single element, the parameter \(\beta\)).</dd>
<dt>params</dt><dd>a pointer to an adequate structure (in general) containing everything fixed (or known) and required to compute the residual (in the case of Eq. \ref{eq:classical-RSS} and \ref{eq:sqrt-RSS} it should contain \(t_1,t_2,y_1,y_2,\mathtt{F\_\mathtt{inf}},\mathtt{t\_\mathtt{onset}},\mathtt{Delta}\)).</dd>
<dt>f</dt><dd>a (pointer to a gsl) vector that will contain the residuals.</dd>
</dl>

<p>
In addition to the <i>required</i> function returning the residuals, we can provide a function returning the "Jacobian" matrix with has many rows as there are observations and as many column as there are parameters to estimate. Element \((i,j)\) of this matrix should contain the derivative of the $i$th residual with respect to $j$th model parameter. We will define such functions in the sequel. If they are not provided, a numerical estimate is obtained by the <code>gsl</code> routines using finite differences.
</p>
</div>
</div>

<div id="outline-container-org830853a" class="outline-5">
<h5 id="org830853a"><span class="section-number-5">4.2.2.2</span> Program skeleton</h5>
<div class="outline-text-5" id="text-4-2-2-2">
<p>
We will therefore construct our new program following the lines of the previous one <a href="#org1286b99"><code>sim_mono_exp</code></a>, essentially changing the end part of if in order to estimate <code>beta</code> instead of writing the simulated data to the standard output. We therefore define a program <code>expl_beta_est</code> (that we store in a file called <code>expl_beta_est.c</code>) whose somewhat "heavy" skeleton is:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org3409566">&lt;&lt;sim_mono_exp-include&gt;&gt;
&lt;&lt;expl_beta_est-extra-include&gt;&gt;
&lt;&lt;expl_beta_est-print-result-macro&gt;&gt;
&lt;&lt;expl_beta_est-data-structure&gt;&gt;
&lt;&lt;expl_beta_est-tilde_f&gt;&gt;
&lt;&lt;expl_beta_est-tilde_df&gt;&gt;
&lt;&lt;expl_beta_est-hat_f&gt;&gt;
&lt;&lt;expl_beta_est-hat_df&gt;&gt;
&lt;&lt;expl_beta_est-callback&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;sim_mono_exp-usage&gt;&gt;
  &lt;&lt;sim_mono_exp-read-args&gt;&gt;
  &lt;&lt;sim_mono_exp-setup-rng&gt;&gt;
  &lt;&lt;expl_beta_est-simulate&gt;&gt;
  &lt;&lt;expl_beta_est-set-tolerance&gt;&gt;

  &lt;&lt;expl_beta_est-fdf-tilde&gt;&gt;
  &lt;&lt;expl_beta_est-setup-tilde-solver&gt;&gt;
  &lt;&lt;expl_beta_est-inital-cost-tilde&gt;&gt;
  &lt;&lt;expl_beta_est-get-beta-tilde&gt;&gt;
  PRINT(tilde)

  &lt;&lt;expl_beta_est-fdf-hat&gt;&gt;
  &lt;&lt;expl_beta_est-setup-hat-solver&gt;&gt;
  &lt;&lt;expl_beta_est-inital-cost-hat&gt;&gt;
  &lt;&lt;expl_beta_est-get-beta-hat&gt;&gt;
  PRINT(hat)

  &lt;&lt;sim_mono_exp-free-rng&gt;&gt;
  &lt;&lt;expl_beta_est-free-solver&gt;&gt;
  &lt;&lt;expl_beta_est-free-covar&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org187e8e1" class="outline-5">
<h5 id="org187e8e1"><span class="section-number-5">4.2.2.3</span> Headers and macros</h5>
<div class="outline-text-5" id="text-4-2-2-3">
<p>
We first recycle with <code>&lt;&lt;sim_mono_exp-include&gt;&gt;</code> the header of our previous program and we extend it with <code>&lt;&lt;expl_beta_est-extra-include&gt;&gt;</code> in order to have the signatures of the non-linear fitting routines as well as <code>gsl_vector</code> and <code>gsl_matrix</code> types and functions definitions:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org32a6d58"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_matrix.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_vector.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_blas.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_multifit_nlinear.h&gt;</span>
</pre>
</div>

<p>
We define next a <code>PRINT</code> <a href="https://en.wikipedia.org/wiki/C_preprocessor#Special_macros_and_directives">macro</a> in code block <code>&lt;&lt;expl_beta_est-print-result-macro&gt;&gt;</code>. This is to save code writing since it allows us to write "code that generates code" since text substitution of macros is performed by the preprocessor. Calling following macro with <code>what</code> set to <code>tilde</code> will result in a third line having <code>w_tilde</code> where there is <code>w_##what</code> in the macro definition.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgbdc327c"><span style="color: #3B5998;">#define</span> <span style="color: #edd400; font-weight: bold;">PRINT</span>(<span style="color: #ff6347;">what</span>) {                                                   \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"summary from method '%s/%s'\n"</span>,                      \
          gsl_multifit_nlinear_name(w_##what),                          \
          gsl_multifit_nlinear_trs_name(w_##what));                     \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"number of iterations: %zu\n"</span>,                        \
          gsl_multifit_nlinear_niter(w_##what));                        \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"function evaluations: %zu\n"</span>, fdf_##what.nevalf);    \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"Jacobian evaluations: %zu\n"</span>, fdf_##what.nevaldf);   \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"reason for stopping: %s\n"</span>,                          \
          (info_##what == 1) ? <span style="color: #ad7fa8; font-style: italic;">"small step size"</span> : <span style="color: #ad7fa8; font-style: italic;">"small gradient"</span>);   \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"initial |f(x)| = %f\n"</span>, sqrt(chisq0_##what));        \
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"final   |f(x)| = %f\n"</span>, sqrt(chisq_##what));         \
  fprintf (stderr, <span style="color: #ad7fa8; font-style: italic;">"beta = %.5f +/- %.5f\n"</span>,                            \
           gsl_vector_get(w_##what-&gt;x, 0),                              \
           1.96*sqrt(gsl_matrix_get(covar_##what,0,0)));                \
  fprintf (stderr, <span style="color: #ad7fa8; font-style: italic;">"status = %s\n"</span>, gsl_strerror (status_##what));      \
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga947b49" class="outline-5">
<h5 id="orga947b49"><span class="section-number-5">4.2.2.4</span> A structure holding "what is fixed"</h5>
<div class="outline-text-5" id="text-4-2-2-4">
<p>
Code block <code>&lt;&lt;expl_beta_est-data-structure&gt;&gt;</code> contains the definition of a structure, names <code>data</code> that will hold what is fixed and required to compute the residuals. 
</p>
<div class="org-src-container">
<pre class="src src-C" id="orgd9bd682"><span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> {
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">number of observations</span>
  <span style="color: #8ae234; font-weight: bold;">double</span> * <span style="color: #ff6347;">t</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">pointer to an array (of size n) holding t_1 and t_2</span>
  <span style="color: #8ae234; font-weight: bold;">double</span> * <span style="color: #ff6347;">y</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">pointer to an array (of size n) holding y_1 and y_2</span>
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span>,<span style="color: #ff6347;">Delta</span>,<span style="color: #ff6347;">t_onset</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">the known model parameters</span>
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d09c67" class="outline-5">
<h5 id="org7d09c67"><span class="section-number-5">4.2.2.5</span> Residual returning function definition for the first estimator</h5>
<div class="outline-text-5" id="text-4-2-2-5">
<p>
Code block <code>&lt;&lt;expl_beta_est-tilde_f&gt;&gt;</code> contains the definition of the function returning the residuals corresponding to Eq. \ref{eq:classical-RSS}.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgb959960"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">tilde_f</span> (<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">x</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">data</span>, 
         <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">f</span>)
{
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;n;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">y</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;y;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">t</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;F_inf;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;Delta;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t_onset;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = gsl_vector_get (x, 0);

  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span> = 0; i &lt; n; i++) {
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">Model Yi = F_inf + H(t-t_onset) * Delta * exp(-beta * t) </span><span style="color: #2c5115;">*/</span>
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Yi</span> = F_inf;
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = t[i]-t_onset;
    <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &gt;= 0.) 
      Yi += Delta * exp (-beta * delta_t);
    gsl_vector_set (f, i, Yi - y[i]);
  }

  <span style="color: #729fcf; font-weight: bold;">return</span> GSL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org63d5e9e" class="outline-5">
<h5 id="org63d5e9e"><span class="section-number-5">4.2.2.6</span> Jacobian returning function definition for the first estimator</h5>
<div class="outline-text-5" id="text-4-2-2-6">
<p>
Code block <code>&lt;&lt;expl_beta_est-tilde_df&gt;&gt;</code> contains the definition of the function returning the Jacobian corresponding to Eq. \ref{eq:classical-RSS}.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org874d645"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">tilde_df</span> (<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">x</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">data</span>, 
          <span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> * <span style="color: #ff6347;">J</span>)
{
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;n;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">y</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;y;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">t</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;F_inf;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;Delta;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t_onset;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = gsl_vector_get (x, 0);

  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span> = 0; i &lt; n; i++) {
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">Jacobian matrix J(i,j) = dfi / dxj, </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">where fi = (Yi - yi)/sigma[i],      </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/*       </span><span style="color: #888a85;">Yi = F_inf + H(t-t_onset) * Delta * exp(-beta * t)  </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">and xj is the model parameter beta </span><span style="color: #2c5115;">*/</span>
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = t[i] - t_onset;
    <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &gt;= 0) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">e</span> = exp(-beta * delta_t);
      gsl_matrix_set (J, i, 0, -delta_t * Delta * e);
    } <span style="color: #729fcf; font-weight: bold;">else</span> {
      gsl_matrix_set (J, i, 0, 0);
    }
  }
  <span style="color: #729fcf; font-weight: bold;">return</span> GSL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org23ac1f7" class="outline-5">
<h5 id="org23ac1f7"><span class="section-number-5">4.2.2.7</span> Residual returning function definition for the second estimator</h5>
<div class="outline-text-5" id="text-4-2-2-7">
<p>
Code block <code>&lt;&lt;expl_beta_est-hat_f&gt;&gt;</code> contains the definition of the function returning the residuals corresponding to Eq. \ref{eq:sqrt-RSS}.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orga368587"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">hat_f</span> (<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">x</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">data</span>, 
       <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">f</span>)
{
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;n;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">y</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;y;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">t</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;F_inf;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;Delta;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t_onset;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = gsl_vector_get (x, 0);

  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span> = 0; i &lt; n; i++) {
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">Model Yi = sqrt(F_inf + H(t-t_onset) * Delta * exp(-beta * t)) </span><span style="color: #2c5115;">*/</span>
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Yi</span> = F_inf;
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = t[i]-t_onset;
    <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &gt;= 0) 
      Yi += Delta * exp (-beta * delta_t);
    gsl_vector_set (f, i, sqrt(Yi) - sqrt(y[i]));
  }

  <span style="color: #729fcf; font-weight: bold;">return</span> GSL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org37c8952" class="outline-5">
<h5 id="org37c8952"><span class="section-number-5">4.2.2.8</span> Jacobian returning function definition for the second estimator</h5>
<div class="outline-text-5" id="text-4-2-2-8">
<p>
Code block <code>&lt;&lt;expl_beta_est-hat_df&gt;&gt;</code> contains the definition of the function returning the Jacobian corresponding to Eq. \ref{eq:sqrt-RSS}.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org035307b"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">hat_df</span> (<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">x</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">data</span>, 
        <span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> * <span style="color: #ff6347;">J</span>)
{
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;n;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">y</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;y;
  <span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">t</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;F_inf;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;Delta;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;t_onset;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = gsl_vector_get (x, 0);

  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span> = 0; i &lt; n; i++) {
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">Jacobian matrix J(i,j) = dfi / dxj, </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">where fi = (Yi - yi)/sigma[i],      </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/*       </span><span style="color: #888a85;">Yi = F_inf + H(t-t_onset) * Delta * exp(-beta * t)  </span><span style="color: #2c5115;">*/</span>
    <span style="color: #2c5115;">/* </span><span style="color: #888a85;">and xj is the model parameter beta </span><span style="color: #2c5115;">*/</span>
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = t[i] - t_onset;
    <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &gt;= 0) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">e</span> = exp(-beta * delta_t);
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Yi</span> = F_inf+Delta*e;
        gsl_matrix_set (J, i, 0, -0.5 * delta_t * Delta * e / sqrt(Yi));
    } <span style="color: #729fcf; font-weight: bold;">else</span> {
      gsl_matrix_set (J, i, 0, 0);
    }
  }
  <span style="color: #729fcf; font-weight: bold;">return</span> GSL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5be37e4" class="outline-5">
<h5 id="org5be37e4"><span class="section-number-5">4.2.2.9</span> "callback" function definition</h5>
<div class="outline-text-5" id="text-4-2-2-9">
<p>
We optionally  pass to <code>gsl</code> routine doing the actual optimization <a href="https://www.gnu.org/software/gsl/manual/html_node/Nonlinear-Least_002dSquares-High-Level-Driver.html#Nonlinear-Least_002dSquares-High-Level-Driver"><code>gsl_multifit_nlinear_driver</code></a> a "callback" function that is called after each iteration of the solver and that can be use to print information on the progress of the procedure. This is what code black <code>&lt;&lt;expl_beta_est-callback&gt;&gt;</code> does here:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org92c2d04"><span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">callback</span>(<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">iter</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">params</span>,
         <span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w</span>)
{
  <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">f</span> = gsl_multifit_nlinear_residual(w);
  <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">x</span> = gsl_multifit_nlinear_position(w);
  
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"iter %2zu: beta = %.4f, |f(x)| = %.4f\n"</span>,
          iter,
          gsl_vector_get(x, 0),
          gsl_blas_dnrm2(f));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ce0614" class="outline-5">
<h5 id="org4ce0614"><span class="section-number-5">4.2.2.10</span> Data simulation and "fixed parameters" initialization</h5>
<div class="outline-text-5" id="text-4-2-2-10">
<p>
Code block <code>&lt;&lt;expl_beta_est-simulate&gt;&gt;</code> simulates the data after declaring vectors <code>y</code> and <code>t</code> to hold them. A <code>data</code> structure, called <code>d</code>, is then declared and initialized by <a href="https://en.wikipedia.org/wiki/C_syntax#Designated_initializers">designated initialization</a>. A vector (of length 1) holding the initial guess (set to the value used to simulate the data, that is the true value) is declared and initialized and a <code>gsl_vector_view</code> associated to it is declared and initialized (this is required for using the fitting routines):  
</p>

<div class="org-src-container">
<pre class="src src-C" id="org39aed96"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">y</span>[n_obs], <span style="color: #ff6347;">t</span>[n_obs];
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;n_obs; i++) {
  t[i] = t_0 + i*delta_t;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">ideal</span> = F_inf;
  <span style="color: #729fcf; font-weight: bold;">if</span> (t[i] &gt;= t_onset) ideal += Delta*exp(-beta*(t[i]-t_onset));
  y[i] = gsl_ran_poisson(r, ideal);
}
<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> <span style="color: #ff6347;">d</span> = { .n = n_obs, .t = t, .y = y,
                  .F_inf = F_inf, .Delta = Delta,
                  .t_onset = t_onset};
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">x_init</span>[1] = { beta }; <span style="color: #2c5115;">/* </span><span style="color: #888a85;">starting values </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">x</span> = gsl_vector_view_array (x_init, 1);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf217894" class="outline-5">
<h5 id="orgf217894"><span class="section-number-5">4.2.2.11</span> Definitions of convergence / stopping conditions</h5>
<div class="outline-text-5" id="text-4-2-2-11">
<p>
Code block <code>&lt;&lt;expl_beta_est-set-tolerance&gt;&gt;</code> contains the declaration and initialization of the tolerances used to stop the iterative fitting procedure. Check the <a href="https://www.gnu.org/software/gsl/manual/html_node/Nonlinear-Least_002dSquares-Testing-for-Convergence.html#Nonlinear-Least_002dSquares-Testing-for-Convergence">manual</a> to see what they mean (<b>you should really check that</b>).
</p>
<div class="org-src-container">
<pre class="src src-C" id="orga450d00"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">xtol</span> = 1e-8;
<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gtol</span> = 1e-8;
<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">ftol</span> = 0.0;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1d8c98" class="outline-5">
<h5 id="orgc1d8c98"><span class="section-number-5">4.2.2.12</span> <code>&lt;&lt;expl_beta_est-setup-tilde-solver&gt;&gt;</code>: solver memory allocation and initialization for the first estimator</h5>
<div class="outline-text-5" id="text-4-2-2-12">
<div class="org-src-container">
<pre class="src src-C" id="orgfe5350d"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_type</span> *<span style="color: #ff6347;">T_tilde</span> = gsl_multifit_nlinear_trust;
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_parameters</span> <span style="color: #ff6347;">fdf_params_tilde</span> =
  gsl_multifit_nlinear_default_parameters();
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">allocate workspace with default parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w_tilde</span> = gsl_multifit_nlinear_alloc (T_tilde,
                                                                      &amp;fdf_params_tilde,
                                                                      n_obs, 1);
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">initialize solver with starting point and weights </span><span style="color: #2c5115;">*/</span>
gsl_multifit_nlinear_init (&amp;x.vector, &amp;fdf_tilde, w_tilde);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd87d82a" class="outline-5">
<h5 id="orgd87d82a"><span class="section-number-5">4.2.2.13</span> <code>&lt;&lt;expl_beta_est-setup-hat-solver&gt;&gt;</code>: solver memory allocation and initialization for the second estimator</h5>
<div class="outline-text-5" id="text-4-2-2-13">
<div class="org-src-container">
<pre class="src src-C" id="org1a583d1"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_type</span> *<span style="color: #ff6347;">T_hat</span> = gsl_multifit_nlinear_trust;
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_parameters</span> <span style="color: #ff6347;">fdf_params_hat</span> =
  gsl_multifit_nlinear_default_parameters();
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">allocate workspace with default parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w_hat</span> = gsl_multifit_nlinear_alloc (T_hat,
                                                                    &amp;fdf_params_hat,
                                                                    n_obs, 1);
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">initialize solver with starting point and weights </span><span style="color: #2c5115;">*/</span>
gsl_multifit_nlinear_init (&amp;x.vector, &amp;fdf_hat, w_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd54949" class="outline-5">
<h5 id="orgdd54949"><span class="section-number-5">4.2.2.14</span> <code>&lt;&lt;expl_beta_est-free-solver&gt;&gt;</code>: free solvers' space</h5>
<div class="outline-text-5" id="text-4-2-2-14">
<div class="org-src-container">
<pre class="src src-C" id="org2c02f99">gsl_multifit_nlinear_free (w_tilde);
gsl_multifit_nlinear_free (w_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ade761" class="outline-5">
<h5 id="org5ade761"><span class="section-number-5">4.2.2.15</span> <code>&lt;&lt;expl_beta_est-fdf-tilde&gt;&gt;</code>: function to minimize for the first estimator</h5>
<div class="outline-text-5" id="text-4-2-2-15">
<div class="org-src-container">
<pre class="src src-C" id="org9dd44d0"><span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_fdf</span> <span style="color: #ff6347;">fdf_tilde</span>;
fdf_tilde.f = tilde_f;
fdf_tilde.df = tilde_df;   <span style="color: #2c5115;">/* </span><span style="color: #888a85;">set to NULL for finite-difference Jacobian </span><span style="color: #2c5115;">*/</span>
fdf_tilde.fvv = <span style="color: #8ae234;">NULL</span>;     <span style="color: #2c5115;">/* </span><span style="color: #888a85;">not using geodesic acceleration </span><span style="color: #2c5115;">*/</span>
fdf_tilde.n = n_obs;
fdf_tilde.p = 1;
fdf_tilde.params = &amp;d;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef8e711" class="outline-5">
<h5 id="orgef8e711"><span class="section-number-5">4.2.2.16</span> <code>&lt;&lt;expl_beta_est-fdf-hat&gt;&gt;</code>: function to minimize for the second estimator</h5>
<div class="outline-text-5" id="text-4-2-2-16">
<div class="org-src-container">
<pre class="src src-C" id="orgdabfbdd"><span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_fdf</span> <span style="color: #ff6347;">fdf_hat</span>;
fdf_hat.f = hat_f;
fdf_hat.df = hat_df;   <span style="color: #2c5115;">/* </span><span style="color: #888a85;">set to NULL for finite-difference Jacobian </span><span style="color: #2c5115;">*/</span>
fdf_hat.fvv = <span style="color: #8ae234;">NULL</span>;     <span style="color: #2c5115;">/* </span><span style="color: #888a85;">not using geodesic acceleration </span><span style="color: #2c5115;">*/</span>
fdf_hat.n = n_obs;
fdf_hat.p = 1;
fdf_hat.params = &amp;d;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf866151" class="outline-5">
<h5 id="orgf866151"><span class="section-number-5">4.2.2.17</span> <code>&lt;&lt;expl_beta_est-inital-cost-tilde&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-2-17">
<p>
We get the initial residual and the initial <code>RSS</code> value for the first estimator:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org71e3552"><span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">f_tilde</span> = gsl_multifit_nlinear_residual(w_tilde);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq0_tilde</span>;
gsl_blas_ddot(f_tilde, f_tilde, &amp;chisq0_tilde);
</pre>
</div>
</div>
</div>

<div id="outline-container-org12c24c4" class="outline-5">
<h5 id="org12c24c4"><span class="section-number-5">4.2.2.18</span> <code>&lt;&lt;expl_beta_est-inital-cost-hat&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-2-18">
<p>
We get the initial residual and the initial <code>RSS</code> value for the second estimator:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org72c87e0"><span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">f_hat</span> = gsl_multifit_nlinear_residual(w_hat);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq0_hat</span>;
gsl_blas_ddot(f_hat, f_hat, &amp;chisq0_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb2fe5f" class="outline-5">
<h5 id="orgeb2fe5f"><span class="section-number-5">4.2.2.19</span> <code>&lt;&lt;expl_beta_est-get-beta-tilde&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-2-19">
<p>
We perform the least squares optimization, get the standard error and the final <code>RSS</code> value for the first estimator:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgbf242a4"><span style="color: #2c5115;">/* </span><span style="color: #888a85;">solve the system with a maximum of 20 iterations </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">info_tilde</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">status_tilde</span> = gsl_multifit_nlinear_driver(20, xtol, gtol, ftol,
                                               callback, <span style="color: #8ae234;">NULL</span>, &amp;info_tilde,
                                               w_tilde);

  <span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute covariance of best fit parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">J_tilde</span> = gsl_multifit_nlinear_jac(w_tilde);
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">covar_tilde</span> = gsl_matrix_alloc (1, 1);
gsl_multifit_nlinear_covar (J_tilde, 0.0, covar_tilde);

<span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute final cost </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq_tilde</span>;
gsl_blas_ddot(f_tilde, f_tilde, &amp;chisq_tilde);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ca4eb7" class="outline-5">
<h5 id="org0ca4eb7"><span class="section-number-5">4.2.2.20</span> <code>&lt;&lt;expl_beta_est-get-beta-hat&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-2-20">
<p>
We perform the least squares optimization, get the standard error and the final <code>RSS</code> value for the second estimator:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org90e41b9"><span style="color: #2c5115;">/* </span><span style="color: #888a85;">solve the system with a maximum of 20 iterations </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">info_hat</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">status_hat</span> = gsl_multifit_nlinear_driver(20, xtol, gtol, ftol,
                                               callback, <span style="color: #8ae234;">NULL</span>, &amp;info_hat,
                                               w_hat);

  <span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute covariance of best fit parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">J_hat</span> = gsl_multifit_nlinear_jac(w_hat);
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">covar_hat</span> = gsl_matrix_alloc (1, 1);
gsl_multifit_nlinear_covar (J_hat, 0.0, covar_hat);

<span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute final cost </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq_hat</span>;
gsl_blas_ddot(f_hat, f_hat, &amp;chisq_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org4dba1b8" class="outline-5">
<h5 id="org4dba1b8"><span class="section-number-5">4.2.2.21</span> <code>&lt;&lt;expl_beta_est-free-covar&gt;&gt;</code>: frees space taken by covariance matrices</h5>
<div class="outline-text-5" id="text-4-2-2-21">
<div class="org-src-container">
<pre class="src src-C" id="orgef58ece">gsl_matrix_free (covar_tilde);
gsl_matrix_free (covar_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0774b4a" class="outline-5">
<h5 id="org0774b4a"><span class="section-number-5">4.2.2.22</span> Code compilation</h5>
<div class="outline-text-5" id="text-4-2-2-22">
<p>
Once the code has been properly "tangled" and stored in a file named <code>expl_beta_est.c</code> (in the <code>code</code> sub-directory) we compile it with <a href="https://gcc.gnu.org/">gcc</a> (we could also do it with another compiler):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org549f486">gcc -W -g -o code/expl_beta_est code/expl_beta_est.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9f3fd0" class="outline-5">
<h5 id="orgc9f3fd0"><span class="section-number-5">4.2.2.23</span> Code use</h5>
<div class="outline-text-5" id="text-4-2-2-23">
<p>
We can run the code using a data set made of two observations made at the same times as the two points of the <a href="#orgf35fbcc">previous figure</a> with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6892e92">./code/expl_beta_est --F_inf=100 --Delta=900 --beta=1 --n_obs=2 <span style="color: #ad7fa8; font-style: italic;">\</span>
                    --t_onset=0 --t_0=0.3 --delta_t=2.5
</pre>
</div>

<pre class="example">
iter  0: beta = 1.0000, |f(x)| = 10.9021
iter  1: beta = 0.9957, |f(x)| = 10.8452
iter  2: beta = 0.9955, |f(x)| = 10.8451
iter  3: beta = 0.9955, |f(x)| = 10.8451
iter  4: beta = 0.9955, |f(x)| = 10.8451
iter  5: beta = 0.9955, |f(x)| = 10.8451
iter  6: beta = 0.9955, |f(x)| = 10.8451
summary from method 'trust-region/levenberg-marquardt'
number of iterations: 6
function evaluations: 10
Jacobian evaluations: 7
reason for stopping: small step size
initial |f(x)| = 10.902140
final   |f(x)| = 10.845086
beta = 0.99547 +/- 0.00774
status = success
iter  0: beta = 1.0000, |f(x)| = 0.3816
iter  1: beta = 0.9630, |f(x)| = 0.2707
iter  2: beta = 0.9630, |f(x)| = 0.2707
iter  3: beta = 0.9629, |f(x)| = 0.2707
iter  4: beta = 0.9629, |f(x)| = 0.2707
iter  5: beta = 0.9629, |f(x)| = 0.2707
summary from method 'trust-region/levenberg-marquardt'
number of iterations: 5
function evaluations: 6
Jacobian evaluations: 6
reason for stopping: small step size
initial |f(x)| = 0.381617
final   |f(x)| = 0.270744
beta = 0.96295 +/- 0.25700
status = success
</pre>
</div>
</div>

<div id="outline-container-org46b5c6f" class="outline-5">
<h5 id="org46b5c6f"><span class="section-number-5">4.2.2.24</span> Using valgrind</h5>
<div class="outline-text-5" id="text-4-2-2-24">
<p>
Since our code makes several allocations (in the heap) it is a could idea to check that we did not forget to free of this allocated memory space when we quit the program. This is easily done with <a href="http://valgrind.org/">valgrind</a> as illustrated next:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6fc10b7">valgrind ./code/expl_beta_est --F_inf=100 --Delta=900 --beta=1 --n_obs=2 <span style="color: #ad7fa8; font-style: italic;">\</span>
                    --t_onset=0 --t_0=0.3 --delta_t=2.5
</pre>
</div>

<pre class="example">
==4656== Memcheck, a memory error detector
==4656== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==4656== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==4656== Command: ./code/expl_beta_est --F_inf=100 --Delta=900 --beta=1 --n_obs=2 --t_onset=0 --t_0=0.3 --delta_t=2.5
==4656== 
iter  0: beta = 1.0000, |f(x)| = 10.9021
iter  1: beta = 0.9957, |f(x)| = 10.8452
iter  2: beta = 0.9955, |f(x)| = 10.8451
iter  3: beta = 0.9955, |f(x)| = 10.8451
iter  4: beta = 0.9955, |f(x)| = 10.8451
iter  5: beta = 0.9955, |f(x)| = 10.8451
iter  6: beta = 0.9955, |f(x)| = 10.8451
summary from method 'trust-region/levenberg-marquardt'
number of iterations: 6
function evaluations: 10
Jacobian evaluations: 7
reason for stopping: small step size
initial |f(x)| = 10.902140
final   |f(x)| = 10.845086
beta = 0.99547 +/- 0.00774
status = success
iter  0: beta = 1.0000, |f(x)| = 0.3816
iter  1: beta = 0.9630, |f(x)| = 0.2707
iter  2: beta = 0.9630, |f(x)| = 0.2707
iter  3: beta = 0.9629, |f(x)| = 0.2707
iter  4: beta = 0.9629, |f(x)| = 0.2707
iter  5: beta = 0.9629, |f(x)| = 0.2707
summary from method 'trust-region/levenberg-marquardt'
number of iterations: 5
function evaluations: 6
Jacobian evaluations: 6
reason for stopping: small step size
initial |f(x)| = 0.381617
final   |f(x)| = 0.270744
beta = 0.96295 +/- 0.25700
status = success
==4656== 
==4656== HEAP SUMMARY:
==4656==     in use at exit: 0 bytes in 0 blocks
==4656==   total heap usage: 186 allocs, 186 frees, 10,136 bytes allocated
==4656== 
==4656== All heap blocks were freed -- no leaks are possible
==4656== 
==4656== For counts of detected and suppressed errors, rerun with: -v
==4656== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2a3082" class="outline-4">
<h4 id="orgb2a3082"><span class="section-number-4">4.2.3</span> <code>C</code> implementation of a systematic simulation</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
We can now code a systematic simulation where a sample is generated <code>nrep</code> times according to the model specified by Eq. \ref{eq:deterministic-mono-exp-discrete} and \ref{eq:obs-mono-exp-discrete}, the two estimators \(\tilde{\beta}\) (Eq. \ref{eq:classical-RSS}) and \(\hat{\beta}\) (Eq. \ref{eq:sqrt-RSS}) are obtained for each simulated dataset and a histogram of the \(\tilde{\beta}\) and the \(\hat{\beta}\) are built to estimate the sampling distribution of each estimator.
</p>
</div>

<div id="outline-container-orga989af8" class="outline-5">
<h5 id="orga989af8"><span class="section-number-5">4.2.3.1</span> <code>&lt;&lt;beta_samp_dist&gt;&gt;</code> code skeleton</h5>
<div class="outline-text-5" id="text-4-2-3-1">
<p>
The first major difference with the previous code is the loop (appearing explicitly) through which the different bootstrap replicates are generated and fitted. Array have to be allocated and later freed for storing the estimates \(\beta\). The last part of the code between code block <code>&lt;&lt;beta_samp_dist-beta-range&gt;&gt;</code> and <code>&lt;&lt;beta_samp_dist-write-hist&gt;&gt;</code> generates the histograms.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org363b39c">&lt;&lt;beta_samp_dist-include&gt;&gt;
&lt;&lt;expl_beta_est-data-structure&gt;&gt;
&lt;&lt;expl_beta_est-tilde_f&gt;&gt;
&lt;&lt;expl_beta_est-tilde_df&gt;&gt;
&lt;&lt;expl_beta_est-hat_f&gt;&gt;
&lt;&lt;expl_beta_est-hat_df&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
    &lt;&lt;beta_samp_dist-usage&gt;&gt;
    &lt;&lt;beta_samp_dist-args&gt;&gt;
    &lt;&lt;sim_mono_exp-setup-rng&gt;&gt;
    &lt;&lt;expl_beta_est-set-tolerance&gt;&gt;
    &lt;&lt;beta_samp_dist-fdf-tilde&gt;&gt;
    &lt;&lt;beta_samp_dist-setup-tilde-solver&gt;&gt;
    &lt;&lt;beta_samp_dist-fdf-hat&gt;&gt;
    &lt;&lt;beta_samp_dist-setup-hat-solver&gt;&gt;
    &lt;&lt;beta_samp_dist-allocate-beta-vectors&gt;&gt;
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">rep_idx</span>=0; rep_idx&lt;n_rep; rep_idx++) {
      &lt;&lt;expl_beta_est-simulate&gt;&gt;
      &lt;&lt;beta_samp_dist-get-beta-tilde&gt;&gt;
      &lt;&lt;beta_samp_dist-get-beta-hat&gt;&gt;
      &lt;&lt;beta_samp_dist-store-results&gt;&gt;
    }
    &lt;&lt;beta_samp_dist-beta-range&gt;&gt;
    &lt;&lt;beta_samp_dist-allocate-hist&gt;&gt;
    &lt;&lt;beta_samp_dist-fill-hist&gt;&gt;
    &lt;&lt;beta_samp_dist-write-hist&gt;&gt;
    &lt;&lt;beta_samp_dist-free-beta-vectors&gt;&gt;
    &lt;&lt;beta_samp_dist-free-hist&gt;&gt;
    &lt;&lt;sim_mono_exp-free-rng&gt;&gt;
    &lt;&lt;expl_beta_est-free-solver&gt;&gt;
    <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f66576" class="outline-5">
<h5 id="org1f66576"><span class="section-number-5">4.2.3.2</span> <code>&lt;&lt;beta_samp_dist-include&gt;&gt;</code> header</h5>
<div class="outline-text-5" id="text-4-2-3-2">
<p>
We need to had <code>#include &lt;gsl/gsl_histogram.h&gt;</code> compared to our last header so that we get access to the <code>gsl</code> functions and structures dealing with histograms:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org2a42f2b"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_rng.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_randist.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_matrix.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_vector.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_blas.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_multifit_nlinear.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_histogram.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3691d22" class="outline-5">
<h5 id="org3691d22"><span class="section-number-5">4.2.3.3</span> <code>&lt;&lt;beta_samp_dist-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-3">
<p>
Our new code takes three additional formal parameters: <code>n_rep</code>, <code>n_bin</code> and <code>max_iter</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgab2e3e4"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--F_inf=real] [--Delta=real] [--beta=real] [--t_onset=real] ...\n"</span> \
  <span style="color: #ad7fa8; font-style: italic;">"          ... [--t_0=real] [--delta_t=real] [--n_obs=int] [--n_rep=int] ...\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"          ... [--n_bin=int] [--max_iter=int]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --F_inf &lt;positive real&gt;: asymptotic value (default 800)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --Delta &lt;positive real&gt;: signal jump amplitude (default 150)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --beta &lt;positive real&gt;: inverse time constant (default 0.1)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --t_onset &lt;real&gt;: the stimulus onset time (default 5)\n"</span>      \
  <span style="color: #ad7fa8; font-style: italic;">"  --t_0 &lt;real&gt;: observations start time (default 0)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --delta_t &lt;positive real&gt;: sampling period (default 0.15)\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --n_obs &lt;positive integer&gt;: number of observations (default 168)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --n_rep &lt;positive integer&gt;: number of Monte Carlo replicates (default 10000)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --n_bin &lt;positive integer&gt;: number of bins for the histograms (default 50)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --max_iter &lt;positive integer&gt;: maximal number of optimization iterations (default 500)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program write to the stdout two gsl histograms containing the (estimated) sampling\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" distribution of the two beta estimators separated by two blank lines\n\n"</span>;  
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff5e4d9" class="outline-5">
<h5 id="orgff5e4d9"><span class="section-number-5">4.2.3.4</span> <code>&lt;&lt;beta_samp_dist-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-4">
<p>
The formal parameters reading part is modified in order to deal with the three new parameters:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org9ba0a2b"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">F_inf</span> = 800;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">Delta</span> = 150;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta</span> = 0.1;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_onset</span> = 5;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">t_0</span> = 0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">delta_t</span> = 0.15;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_obs</span> = 168;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_rep</span> = 10000;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_bin</span> = 50;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">max_iter</span> = 500;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"F_inf"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"Delta"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'d'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"beta"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'b'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"t_onset"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'o'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"t_0"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'s'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"delta_t"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'t'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"n_obs"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'n'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"n_rep"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'r'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"n_bin"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'e'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"max_iter"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'m'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:d:b:o:s:t:n:r:e:m:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      F_inf = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (F_inf &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"The asymptotic value should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'d'</span>:
    {
      Delta = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (Delta &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Delta should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'b'</span>:
    {
      beta = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (beta &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"beta should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      } 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'o'</span>:
    {
      t_onset = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg); 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'s'</span>:
    {
      t_0 = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg); 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'t'</span>:
    {
      delta_t = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (delta_t &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"delta_t should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      } 
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'n'</span>:
    {
      n_obs = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (n_obs &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"n_obs should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'r'</span>:
    {
      n_rep = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (n_rep &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"n_rep should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'e'</span>:
    {
      n_bin = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (n_bin &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"n_bin should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'m'</span>:
    {
      max_iter = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (max_iter &lt;= 0)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"max_iter should be &gt; 0.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec5bbee" class="outline-5">
<h5 id="orgec5bbee"><span class="section-number-5">4.2.3.5</span> <code>&lt;&lt;beta_samp_dist-fdf-tilde&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-5">
<p>
The code block is almost identical to <code>&lt;&lt;expl_beta_est-fdf-tilde&gt;&gt;</code>, the only difference is the last assignment of the latter, <code>fdf_tilde.params = &amp;d;</code>, that occurs now within the loop since we want to fit new simulated data at each iteration.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgdd92860"><span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_fdf</span> <span style="color: #ff6347;">fdf_tilde</span>;
fdf_tilde.f = tilde_f;
fdf_tilde.df = tilde_df;   <span style="color: #2c5115;">/* </span><span style="color: #888a85;">set to NULL for finite-difference Jacobian </span><span style="color: #2c5115;">*/</span>
fdf_tilde.fvv = <span style="color: #8ae234;">NULL</span>;     <span style="color: #2c5115;">/* </span><span style="color: #888a85;">not using geodesic acceleration </span><span style="color: #2c5115;">*/</span>
fdf_tilde.n = n_obs;
fdf_tilde.p = 1;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc8adb1" class="outline-5">
<h5 id="orgcc8adb1"><span class="section-number-5">4.2.3.6</span> <code>&lt;&lt;beta_samp_dist-fdf-hat&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-6">
<p>
The corresponding comment to the one of the previous code block applies here also.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org7ebc96f"><span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_fdf</span> <span style="color: #ff6347;">fdf_hat</span>;
fdf_hat.f = hat_f;
fdf_hat.df = hat_df;   <span style="color: #2c5115;">/* </span><span style="color: #888a85;">set to NULL for finite-difference Jacobian </span><span style="color: #2c5115;">*/</span>
fdf_hat.fvv = <span style="color: #8ae234;">NULL</span>;     <span style="color: #2c5115;">/* </span><span style="color: #888a85;">not using geodesic acceleration </span><span style="color: #2c5115;">*/</span>
fdf_hat.n = n_obs;
fdf_hat.p = 1;
</pre>
</div>
</div>
</div>

<div id="outline-container-org869d638" class="outline-5">
<h5 id="org869d638"><span class="section-number-5">4.2.3.7</span> <code>&lt;&lt;beta_samp_dist-setup-tilde-solver&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-7">
<p>
Again, a code block almost identical to <code>&lt;&lt;expl_beta_est-setup-tilde-solver&gt;&gt;</code>. The last statement has been removed since it must be renewed at each iteration:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgc9b776b"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_type</span> *<span style="color: #ff6347;">T_tilde</span> = gsl_multifit_nlinear_trust;
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_parameters</span> <span style="color: #ff6347;">fdf_params_tilde</span> =
  gsl_multifit_nlinear_default_parameters();
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">allocate workspace with default parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w_tilde</span> = gsl_multifit_nlinear_alloc (T_tilde,
                                                                      &amp;fdf_params_tilde,
                                                                      n_obs, 1);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc08d147" class="outline-5">
<h5 id="orgc08d147"><span class="section-number-5">4.2.3.8</span> <code>&lt;&lt;beta_samp_dist-setup-hat-solver&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-8">
<p>
See previous point.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org90d30c9"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_type</span> *<span style="color: #ff6347;">T_hat</span> = gsl_multifit_nlinear_trust;
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_parameters</span> <span style="color: #ff6347;">fdf_params_hat</span> =
  gsl_multifit_nlinear_default_parameters();
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">allocate workspace with default parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w_hat</span> = gsl_multifit_nlinear_alloc (T_hat,
                                                                      &amp;fdf_params_hat,
                                                                      n_obs, 1);
</pre>
</div>
</div>
</div>


<div id="outline-container-org98c96ca" class="outline-5">
<h5 id="org98c96ca"><span class="section-number-5">4.2.3.9</span> <code>&lt;&lt;beta_samp_dist-allocate-beta-vectors&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-9">
<p>
We just allocate heap space to store the \(\beta\) estimates obtained at each iteration:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org65c3017"><span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">beta_tilde</span> = malloc(<span style="color: #8ae234; font-weight: bold;">n_rep</span>*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">double</span>));
<span style="color: #8ae234; font-weight: bold;">double</span> *<span style="color: #ff6347;">beta_hat</span> = malloc(<span style="color: #8ae234; font-weight: bold;">n_rep</span>*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">double</span>));
</pre>
</div>
</div>
</div>

<div id="outline-container-org92d47f7" class="outline-5">
<h5 id="org92d47f7"><span class="section-number-5">4.2.3.10</span> <code>&lt;&lt;beta_samp_dist-free-beta-vectors&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-10">
<p>
We free the heap memory taken by our <code>beta</code> arrays:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgf4bf8ee">free(beta_tilde);
free(beta_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org3004551" class="outline-5">
<h5 id="org3004551"><span class="section-number-5">4.2.3.11</span> <code>&lt;&lt;beta_samp_dist-get-beta-tilde&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-11">
<p>
This is the "workhorse" of the program for the first estimator. The new data are "assigned" to the <code>fdf_tilde</code> structure, the <code>w_tilde</code> solver is reinitialized and the optimization is performed. This time the maximal number of iterations is a user controlled parameter and no <code>callback</code> function is called (we are going to generate \(10^5\) replicates!):
</p>

<div class="org-src-container">
<pre class="src src-C" id="org52b264d">fdf_tilde.params = &amp;d;
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">initialize solver with starting point and weights </span><span style="color: #2c5115;">*/</span>
gsl_multifit_nlinear_init (&amp;x.vector, &amp;fdf_tilde, w_tilde);
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">solve the system with a maximum of max_iter iterations </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">info_tilde</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">status_tilde</span> = gsl_multifit_nlinear_driver(max_iter, xtol, gtol, ftol,
                                               <span style="color: #8ae234;">NULL</span>, <span style="color: #8ae234;">NULL</span>, &amp;info_tilde,
                                               w_tilde);
</pre>
</div>
</div>
</div>

<div id="outline-container-org84e1ef3" class="outline-5">
<h5 id="org84e1ef3"><span class="section-number-5">4.2.3.12</span> <code>&lt;&lt;beta_samp_dist-get-beta-hat&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-12">
<p>
See the previous point.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgafa3f34">fdf_hat.params = &amp;d;
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">initialize solver with starting point and weights </span><span style="color: #2c5115;">*/</span>
gsl_multifit_nlinear_init (&amp;x.vector, &amp;fdf_hat, w_hat);
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">solve the system with a maximum of max_iter iterations </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">info_hat</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">status_hat</span> = gsl_multifit_nlinear_driver(max_iter, xtol, gtol, ftol,
                                             <span style="color: #8ae234;">NULL</span>, <span style="color: #8ae234;">NULL</span>, &amp;info_hat,
                                             w_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org570d9b0" class="outline-5">
<h5 id="org570d9b0"><span class="section-number-5">4.2.3.13</span> <code>&lt;&lt;beta_samp_dist-store-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-13">
<p>
For each replicate (that is, each iteration of the loop), we check that convergence has been achieved and we store the estimated <code>beta</code> at the proper place:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgbf9c5aa"><span style="color: #729fcf; font-weight: bold;">if</span> (info_tilde == 0) {
  fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"On replicate %d the beta_tilde estimator did not converge.\n"</span>,rep_idx);
  beta_tilde[rep_idx] = NAN;
} <span style="color: #729fcf; font-weight: bold;">else</span> {
  beta_tilde[rep_idx] = gsl_vector_get(w_tilde-&gt;x, 0);
}
<span style="color: #729fcf; font-weight: bold;">if</span> (info_hat == 0) {
  fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"On replicate %d the beta_hat estimator did not converge.\n"</span>,rep_idx);
  beta_hat[rep_idx] = NAN;
} <span style="color: #729fcf; font-weight: bold;">else</span> {
  beta_hat[rep_idx] = gsl_vector_get(w_hat-&gt;x, 0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org886ace6" class="outline-5">
<h5 id="org886ace6"><span class="section-number-5">4.2.3.14</span> <code>&lt;&lt;beta_samp_dist-beta-range&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-14">
<p>
We get the range of the estimated <code>beta</code> in order to define properly the limits of our histograms:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org533b48e"><span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">beta_tilde_v</span> = gsl_vector_view_array (beta_tilde, n_rep);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">beta_max</span>, <span style="color: #ff6347;">beta_min</span>;
gsl_vector_minmax(&amp;beta_tilde_v.vector,&amp;beta_min,&amp;beta_max);
<span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">beta_hat_v</span> = gsl_vector_view_array (beta_hat, n_rep);
<span style="color: #729fcf; font-weight: bold;">if</span> (gsl_vector_max(&amp;beta_hat_v.vector) &gt; beta_max)
  beta_max = gsl_vector_max(&amp;beta_hat_v.vector);
<span style="color: #729fcf; font-weight: bold;">if</span> (gsl_vector_min(&amp;beta_hat_v.vector) &lt; beta_min)
  beta_min = gsl_vector_min(&amp;beta_hat_v.vector);
</pre>
</div>
</div>
</div>

<div id="outline-container-orge6f1161" class="outline-5">
<h5 id="orge6f1161"><span class="section-number-5">4.2.3.15</span> <code>&lt;&lt;beta_samp_dist-allocate-hist&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-15">
<p>
We allocate two histograms covering the same range with the same number of bins (controlled by the user):
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgcde2ed1"><span style="color: #8ae234; font-weight: bold;">gsl_histogram</span> * <span style="color: #ff6347;">h_tilde</span> = gsl_histogram_alloc (n_bin);
gsl_histogram_set_ranges_uniform (h_tilde, beta_min, beta_max);
<span style="color: #8ae234; font-weight: bold;">gsl_histogram</span> * <span style="color: #ff6347;">h_hat</span> = gsl_histogram_alloc (n_bin);
gsl_histogram_set_ranges_uniform (h_hat, beta_min, beta_max);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0554bfa" class="outline-5">
<h5 id="org0554bfa"><span class="section-number-5">4.2.3.16</span> <code>&lt;&lt;beta_samp_dist-free-hist&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-16">
<p>
The histograms are freed once we are done with them:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org0fca313">gsl_histogram_free (h_tilde);
gsl_histogram_free (h_hat);
</pre>
</div>
</div>
</div>

<div id="outline-container-org52cb350" class="outline-5">
<h5 id="org52cb350"><span class="section-number-5">4.2.3.17</span> <code>&lt;&lt;beta_samp_dist-fill-hist&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-17">
<p>
The histograms are "updated" for each estimated <code>beta</code>. Once all the <code>beta</code> have been considered, the histograms are scaled in order to yield a proper density estimation:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orga06bc9e"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">rep_idx</span>=0; rep_idx&lt;n_rep; rep_idx++) {
  gsl_histogram_increment (h_tilde, beta_tilde[rep_idx]);
  gsl_histogram_increment (h_hat, beta_hat[rep_idx]);
}
gsl_histogram_scale (h_tilde,(<span style="color: #8ae234; font-weight: bold;">double</span>)n_bin/(n_rep*(beta_max-beta_min)));
gsl_histogram_scale (h_hat,(<span style="color: #8ae234; font-weight: bold;">double</span>) n_bin/(n_rep*(beta_max-beta_min)));
</pre>
</div>
</div>
</div>

<div id="outline-container-org6dba715" class="outline-5">
<h5 id="org6dba715"><span class="section-number-5">4.2.3.18</span> <code>&lt;&lt;beta_samp_dist-write-hist&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-4-2-3-18">
<p>
Results are written to the standard output with the histogram containing the (estimated) sampling distribution of the first estimator first and, after <i>two blank lines</i> as required by <code>gnuplot</code>, the (estimated) sampling distribution of the second estimator:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org81a5e41">gsl_histogram_fprintf(stdout,h_tilde,<span style="color: #ad7fa8; font-style: italic;">"%g"</span>,<span style="color: #ad7fa8; font-style: italic;">"%g"</span>);
fprintf(stdout,<span style="color: #ad7fa8; font-style: italic;">"\n\n"</span>);
gsl_histogram_fprintf(stdout,h_hat,<span style="color: #ad7fa8; font-style: italic;">"%g"</span>,<span style="color: #ad7fa8; font-style: italic;">"%g"</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb92a145" class="outline-5">
<h5 id="orgb92a145"><span class="section-number-5">4.2.3.19</span> Code compilation</h5>
<div class="outline-text-5" id="text-4-2-3-19">
<p>
Once the code has been properly "tangled" and stored in a file named <code>beta_samp_dist.c</code> (in the <code>code</code> sub-directory) we compile it with <a href="https://gcc.gnu.org/">gcc</a> (we could also do it with another compiler):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org7350569">gcc -W -g -o code/beta_samp_dist code/beta_samp_dist.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b40438" class="outline-5">
<h5 id="org3b40438"><span class="section-number-5">4.2.3.20</span> Code use</h5>
<div class="outline-text-5" id="text-4-2-3-20">
<p>
We can now run our computation on 100,000 replicates checking also the execution time with the POSIX <code>time</code> function (this run-time is measured on a ThinkPad L530 with an Intel i3 CPU at 2.5 GHz): 
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org3aa74b7"><span style="color: #729fcf; font-weight: bold;">time</span> ./code/beta_samp_dist  --F_inf=100 <span style="color: #ad7fa8; font-style: italic;">\</span>
     --Delta=900 --beta=1 --t_onset=0 <span style="color: #ad7fa8; font-style: italic;">\</span>
     --t_0=0.3 --delta_t=2.7 --n_obs=2<span style="color: #ad7fa8; font-style: italic;">\</span>
     --n_rep=100000 --n_bin=100 &gt; beta_samp_dist.txt
</pre>
</div>

<pre class="example">

real	0m1,360s
user	0m1,360s
sys	0m0,000s

</pre>

<p>
We can make a quick valgrind check with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org7ba9955">valgrind ./code/beta_samp_dist  --F_inf=100 --Delta=900 --beta=1<span style="color: #ad7fa8; font-style: italic;">\</span>
         --t_onset=0 --t_0=0.3 --delta_t=2.7 --n_obs=2 --n_rep=100<span style="color: #ad7fa8; font-style: italic;">\</span>
         --n_bin=100 &gt; dump
</pre>
</div>

<pre class="example">
==5216== Memcheck, a memory error detector
==5216== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==5216== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==5216== Command: ./code/beta_samp_dist --F_inf=100 --Delta=900 --beta=1 --t_onset=0 --t_0=0.3 --delta_t=2.7 --n_obs=2 --n_rep=100 --n_bin=100
==5216== 
==5216== 
==5216== HEAP SUMMARY:
==5216==     in use at exit: 0 bytes in 0 blocks
==5216==   total heap usage: 167 allocs, 167 frees, 18,488 bytes allocated
==5216== 
==5216== All heap blocks were freed -- no leaks are possible
==5216== 
==5216== For counts of detected and suppressed errors, rerun with: -v
==5216== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>


<div id="outline-container-org7418b3f" class="outline-5">
<h5 id="org7418b3f"><span class="section-number-5">4.2.3.21</span> Figure construction</h5>
<div class="outline-text-5" id="text-4-2-3-21">
<p>
We now use gnuplot as follows:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="org92b6b51"><span style="color: #ff6347;">t1 =</span> 0.3
<span style="color: #ff6347;">t2 =</span> 3
<span style="color: #ff6347;">F(t) =</span> 100 + 900*<span style="color: #edd400; font-weight: bold;">exp</span>(-t)
<span style="color: #ff6347;">dF(t) =</span> -t*900*<span style="color: #edd400; font-weight: bold;">exp</span>(-t)
<span style="color: #ff6347;">var0 =</span> (dF(t1)**2*F(t1)+dF(t2)**2*F(t2))/(dF(t1)**2+dF(t2)**2)**2
<span style="color: #ff6347;">var1 =</span> 1.0/(dF(t1)**2/F(t1)+dF(t2)**2/F(t2))
<span style="color: #ff6347;">gogo0(x) =</span> <span style="color: #edd400; font-weight: bold;">exp</span>(-0.5*(x-1.0)**2/var0)/<span style="color: #edd400; font-weight: bold;">sqrt</span>(2*pi*var0)
<span style="color: #ff6347;">gogo1(x) =</span> <span style="color: #edd400; font-weight: bold;">exp</span>(-0.5*(x-1.0)**2/var1)/<span style="color: #edd400; font-weight: bold;">sqrt</span>(2*pi*var1)
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"&#946;"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Densities"</span>
<span style="color: #8ae234;">set</span> key
<span style="color: #729fcf; font-weight: bold;">plot</span> gogo0(x) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> \
     <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"asymp. &#946; tilde"</span>,\
     gogo1(x) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"grey"</span> \
     <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"asymp. &#946; hat"</span>,\
     <span style="color: #ad7fa8; font-style: italic;">"beta_samp_dist.txt"</span> <span style="color: #8ae234; font-weight: bold;">index</span> 0 <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">steps</span> \
     <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span> <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"&#946; tilde"</span>,\
     <span style="color: #ad7fa8; font-style: italic;">""</span> <span style="color: #8ae234; font-weight: bold;">index</span> 1 <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">steps</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2\
     <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"orange"</span> <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"&#946; hat"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/beta_samp_dist_fig.svg" class="org-svg" alt="Monte Carlo estimates of the sampling distributions of the two beta estimators" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 4: </span><a id="org16efa2d"></a> Monte Carlo estimates of the sampling distributions of the two estimators defined by Eq. \ref{eq:classical-RSS} (blue) and \ref{eq:sqrt-RSS} (orange). 100,000 replicates were used. The continous lines show the asymptotic densities (see <a href="http://jn.physiology.org/content/103/2/1130">Joucla et al (2010)</a> for details).</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org1bea4e4" class="outline-2">
<h2 id="org1bea4e4"><span class="section-number-2">5</span> Convergence in law of a Poisson random variable towards a normal one</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org9047df9" class="outline-3">
<h3 id="org9047df9"><span class="section-number-3">5.1</span> Scaled Poisson CDF</h3>
<div class="outline-text-3" id="text-5-1">
<p>
We write now a program that returns the Cumulative Distribution Function (CDF) of a scaled Poisson random variable:
</p>
\begin{equation}\label{eq:scaled-Poisson}
Y_n = \frac{X_n-n}{\sqrt{n}}\, ,
\end{equation}
<p>
where \(X_n\) is a Poisson random variable with parameter \(n\). We will write a program that return the CDF of \(Y_n\) for user defined values of \(n\) and that returns to the <code>stdout</code> a two columns text file where the first column contains the number numbers \(0,1,\ldots,n\) and the second column contains the corresponding CDF. When several values of \(n\) are requested, the different datasets will be separated by two blank lines as requested by <code>gnuplot</code>. The only "tricky" part of the code will be the user supplied parameters reading; we will allow users to pass the series of Poisson distribution parameters they want to explore like &#x2013;n=5,50,500,5000 that is, several comma separated values can be given.
</p>
</div>

<div id="outline-container-orgd233086" class="outline-5">
<h5 id="orgd233086"><span class="section-number-5">5.1.0.1</span> <code>&lt;&lt;scaled_poisson&gt;&gt;</code> skeleton</h5>
<div class="outline-text-5" id="text-5-1-0-1">
<p>
The skeleton of our program looks like:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org64131ab">&lt;&lt;scaled_poisson-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;scaled_poisson-usage&gt;&gt;
  &lt;&lt;scaled_poisson-args&gt;&gt;
  &lt;&lt;scaled_poisson-print-header&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nb_n; i++) {
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">Loop over the Poisson parameters</span>
    &lt;&lt;scaled_poisson-get-and-print-CDF&gt;&gt;  
  }
  &lt;&lt;scaled_poisson-free-n_seq&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org837dbf5" class="outline-5">
<h5 id="org837dbf5"><span class="section-number-5">5.1.0.2</span> <code>&lt;&lt;scaled_poisson-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-2">
<div class="org-src-container">
<pre class="src src-C" id="org928abcc"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_randist.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_cdf.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org67a38a1" class="outline-5">
<h5 id="org67a38a1"><span class="section-number-5">5.1.0.3</span> <code>&lt;&lt;scaled_poisson-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-3">
<div class="org-src-container">
<pre class="src src-C" id="org80803c2"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--n=int,int,int,...]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --n &lt;positive integers&gt;: Poisson parameters separated by ','\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program writes to the stdout the CDF of a scaled Poisson random variable\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" that is, if X_n is Poisson with parameter n, the first column of the output\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" contains integers from 0 to n and the second column contains the corresponding\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" value of the CFD of Y_n = (X_n-n)/sqrt(n)\n\n"</span>; 
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a028f3" class="outline-5">
<h5 id="org0a028f3"><span class="section-number-5">5.1.0.4</span> <code>&lt;&lt;scaled_poisson-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-4">
<p>
Code block <code>&lt;&lt;scaled_poisson-args&gt;&gt;</code> assigned to variable <code>nb_n</code> the number of Poisson distributions the user wants to consider, it allocates the heap memory required to store the <code>nb_n</code> parameters and makes this memory accessible through the pointer <code>n_seq</code>. <i>The allocated memory must be freed before the program returns.</i>
</p>
<div class="org-src-container">
<pre class="src src-C" id="orga8fc744"><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">n_seq</span>;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nb_n</span>=0;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"n"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'n'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hn:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'n'</span>:
    {
      <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">start</span> = strdup(optarg); <span style="color: #2c5115;">// </span><span style="color: #888a85;">duplicate optarg content</span>
      <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">running</span>;
      running = start;
      <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">token</span>  = strsep(&amp;running, <span style="color: #ad7fa8; font-style: italic;">","</span>);
      <span style="color: #729fcf; font-weight: bold;">while</span> (token != <span style="color: #8ae234;">NULL</span>) {
        token = strsep (&amp;running, <span style="color: #ad7fa8; font-style: italic;">","</span>); <span style="color: #2c5115;">// </span><span style="color: #888a85;">split d_name at each ","</span>
        nb_n++;
      }
      free(start);
      n_seq = malloc(<span style="color: #8ae234; font-weight: bold;">nb_n</span>*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
      start = strdup(optarg); <span style="color: #2c5115;">// </span><span style="color: #888a85;">duplicate optarg content again</span>
      running = start;
      <span style="color: #2c5115;">// </span><span style="color: #888a85;">Get the parameter of each Poisson distribution</span>
      <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nb_n; i++) {
        token = strsep (&amp;running, <span style="color: #ad7fa8; font-style: italic;">","</span>);
        <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">para</span> = atoi(token);
        <span style="color: #729fcf; font-weight: bold;">if</span> (para &lt;= 0) {
          fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"A Poisson parameter should be &gt; 0.\n"</span>);
          free(start);
          free(n_seq);
          <span style="color: #729fcf; font-weight: bold;">return</span> -1;
        } <span style="color: #729fcf; font-weight: bold;">else</span> {
          n_seq[i] = para;
        }
      }
      free(start);
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3ceeda" class="outline-5">
<h5 id="orgb3ceeda"><span class="section-number-5">5.1.0.5</span> <code>&lt;&lt;scaled_poisson-free-n_seq&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-5">
<div class="org-src-container">
<pre class="src src-C" id="org377c38a">free(n_seq);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgae781ab" class="outline-5">
<h5 id="orgae781ab"><span class="section-number-5">5.1.0.6</span> <code>&lt;&lt;scaled_poisson-print-header&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-6">
<div class="org-src-container">
<pre class="src src-C" id="org8c373fe">printf(<span style="color: #ad7fa8; font-style: italic;">"# %d Scaled Poisson distributions "</span>
       <span style="color: #ad7fa8; font-style: italic;">"with parameters:\n#  %d"</span>,(<span style="color: #8ae234; font-weight: bold;">int</span>) nb_n, n_seq[0]);
<span style="color: #729fcf; font-weight: bold;">if</span> (nb_n &gt; 1) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=1; i&lt;nb_n; i++)
    printf(<span style="color: #ad7fa8; font-style: italic;">", %d"</span>,n_seq[i]);
}
printf(<span style="color: #ad7fa8; font-style: italic;">"\n#\n#\n"</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org2cd3de6" class="outline-5">
<h5 id="org2cd3de6"><span class="section-number-5">5.1.0.7</span> <code>&lt;&lt;scaled_poisson-get-and-print-CDF&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-5-1-0-7">
<div class="org-src-container">
<pre class="src src-C" id="orgc71d094"><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">n</span> = n_seq[i];
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">sn</span> = sqrt(n);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">inv_sn</span> = 1.0/sn;
<span style="color: #8ae234; font-weight: bold;">unsigned</span> <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">from</span> = n-4*sn &gt; 0 ? n-4*sn : 0;
<span style="color: #8ae234; font-weight: bold;">unsigned</span> <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">to</span> = n+5*sn;
printf(<span style="color: #ad7fa8; font-style: italic;">"# Scaled Poisson CDF with parameter: %d\n"</span>,n);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">unsigned</span> <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">k</span>=from; k &lt;= to; k++) {
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g\n"</span>, ((<span style="color: #8ae234; font-weight: bold;">double</span>) k-n)*inv_sn, gsl_cdf_poisson_P(k,n)); 
}
printf(<span style="color: #ad7fa8; font-style: italic;">"\n\n"</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e33a01" class="outline-5">
<h5 id="org6e33a01"><span class="section-number-5">5.1.0.8</span> Code compilation</h5>
<div class="outline-text-5" id="text-5-1-0-8">
<p>
Once the code has been properly "tangled" and stored in a file named <code>scaled_poisson.c</code> (in the <code>code</code> sub-directory) we compile it with <a href="https://gcc.gnu.org/">gcc</a> (we could also do it with another compiler):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgce263b4">gcc -W -g -o code/scaled_poisson code/scaled_poisson.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-org6be3504" class="outline-5">
<h5 id="org6be3504"><span class="section-number-5">5.1.0.9</span> Code use</h5>
<div class="outline-text-5" id="text-5-1-0-9">
<p>
We test our code with a single parameter (5) and we don't save the result in a file:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org938bee4">./code/scaled_poisson --n=5
</pre>
</div>

<pre class="example">
# 1 Scaled Poisson distributions with parameters:
#  5
#
#
# Scaled Poisson CDF with parameter: 5
-2.23607 0.00673795
-1.78885 0.0404277
-1.34164 0.124652
-0.894427 0.265026
-0.447214 0.440493
0 0.615961
0.447214 0.762183
0.894427 0.866628
1.34164 0.931906
1.78885 0.968172
2.23607 0.986305
2.68328 0.994547
3.1305 0.997981
3.57771 0.999302
4.02492 0.999774
4.47214 0.999931
4.91935 0.99998


</pre>

<p>
We can use valgrind on it:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org95939d3">valgrind ./code/scaled_poisson --n=5 &gt; dump
</pre>
</div>

<pre class="example">
==4495== Memcheck, a memory error detector
==4495== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==4495== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==4495== Command: ./code/scaled_poisson --n=5
==4495== 
==4495== 
==4495== HEAP SUMMARY:
==4495==     in use at exit: 0 bytes in 0 blocks
==4495==   total heap usage: 4 allocs, 4 frees, 4,104 bytes allocated
==4495== 
==4495== All heap blocks were freed -- no leaks are possible
==4495== 
==4495== For counts of detected and suppressed errors, rerun with: -v
==4495== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>

<p>
Now we get the 4 values of interest and store the results into file <code>scaled_poisson_cdf.txt</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgdeddd45">./code/scaled_poisson --n=5,50,500,5000 &gt; scaled_poisson_cdf.txt
</pre>
</div>
</div>
</div>

<div id="outline-container-org93d55fd" class="outline-5">
<h5 id="org93d55fd"><span class="section-number-5">5.1.0.10</span> Figures construction</h5>
<div class="outline-text-5" id="text-5-1-0-10">
<p>
We define a general code block <code>&lt;&lt;scaled_poisson_cdf_gnuplot&gt;&gt;</code> that contains an unspecified variable <code>idx</code> that we can set (to 0,1,2,3) to generate the plots with the different parameters of the scaled Poisson distributions:
</p>


<div class="figure">
<p><object type="image/svg+xml" data="figs/scaled_poisson_cdf_n_5.svg" class="org-svg" alt="Scaled Poisson CDF with parameter 5" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 5: </span><a id="org1ed572b"></a> Scaled Poisson CDF with parameter 5 (black) and standard normal CDF (red).</p>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/scaled_poisson_cdf_n_50.svg" class="org-svg" alt="Scaled Poisson CDF with parameter 50" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 6: </span><a id="org6831cba"></a> Scaled Poisson CDF with parameter 50 (black) and standard normal CDF (red).</p>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/scaled_poisson_cdf_n_500.svg" class="org-svg" alt="Scaled Poisson CDF with parameter 500" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 7: </span><a id="orgb51fc2f"></a> Scaled Poisson CDF with parameter 500 (black) and standard normal CDF (red).</p>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/scaled_poisson_cdf_n_5000.svg" class="org-svg" alt="Scaled Poisson CDF with parameter 5000" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 8: </span><a id="org63a1685"></a> Scaled Poisson CDF with parameter 5000 (black) and standard normal CDF (red).</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf4d5f6b" class="outline-2">
<h2 id="orgf4d5f6b"><span class="section-number-2">6</span> Calibration data analysis</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-org5e236b1" class="outline-3">
<h3 id="org5e236b1"><span class="section-number-3">6.1</span> Getting the data</h3>
<div class="outline-text-3" id="text-6-1">
<p>
The calibration data are located at the following address: <code>http://xtof.disque.math.cnrs.fr/data/CCD_calibration.hdf5</code>. 
</p>
</div>
<div id="outline-container-org6ae1720" class="outline-4">
<h4 id="org6ae1720"><span class="section-number-4">6.1.1</span> Donwlading the calibration data</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
They can be downloaded with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orga05fec2">wget http://xtof.disque.math.cnrs.fr/data/CCD_calibration.hdf5
</pre>
</div>
</div>
</div>

<div id="outline-container-org65361c2" class="outline-4">
<h4 id="org65361c2"><span class="section-number-4">6.1.2</span> Overview of the file content</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
We get a quick outline of the file content with the <code>h5ls</code> program:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org4725795">h5ls -r CCD_calibration.hdf5
</pre>
</div>

<pre class="example">
/                        Group
/100ms                   Group
/100ms/stack             Dataset {60, 80, 100}
/100ms/time              Dataset {100}
/10ms                    Group
/10ms/stack              Dataset {60, 80, 100}
/10ms/time               Dataset {100}
/20ms                    Group
/20ms/stack              Dataset {60, 80, 100}
/20ms/time               Dataset {100}
/30ms                    Group
/30ms/stack              Dataset {60, 80, 100}
/30ms/time               Dataset {100}
/40ms                    Group
/40ms/stack              Dataset {60, 80, 100}
/40ms/time               Dataset {100}
/50ms                    Group
/50ms/stack              Dataset {60, 80, 100}
/50ms/time               Dataset {100}
/60ms                    Group
/60ms/stack              Dataset {60, 80, 100}
/60ms/time               Dataset {100}
/70ms                    Group
/70ms/stack              Dataset {60, 80, 100}
/70ms/time               Dataset {100}
/80ms                    Group
/80ms/stack              Dataset {60, 80, 100}
/80ms/time               Dataset {100}
/90ms                    Group
/90ms/stack              Dataset {60, 80, 100}
/90ms/time               Dataset {100}
</pre>

<p>
We see that the file contains 10 Groups (10ms, 20ms,&#x2026;,100ms) and that each group contains 2 DataSets "stack" and "time". The "stack" data set is a cube (3D object 60x80x100) containing the data. We can get details by looking at the "README" attribute of the file with (result not shown):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orge61ef48">h5dump -N <span style="color: #ad7fa8; font-style: italic;">"README"</span> CCD_calibration.hdf5
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1581cb5" class="outline-3">
<h3 id="org1581cb5"><span class="section-number-3">6.2</span> Dumping and plotting an image</h3>
<div class="outline-text-3" id="text-6-2">
<p>
We now want to write a short <code>C</code> code that takes a group name (like <code>10ms</code>) an image index in the stack and that prints to the <code>stdout</code> the matrix (the image or exposure) containing the data so that it can be used by <code>gnuplot</code>.
</p>
</div>

<div id="outline-container-orgd5d421b" class="outline-5">
<h5 id="orgd5d421b"><span class="section-number-5">6.2.0.1</span> <code>print-exposure</code> skeleton</h5>
<div class="outline-text-5" id="text-6-2-0-1">
<div class="org-src-container">
<pre class="src src-C" id="org286c297">&lt;&lt;print-exposure-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;print-exposure-usage&gt;&gt;
  &lt;&lt;print-exposure-args&gt;&gt;
  &lt;&lt;print-exposure-open-FILE-and-read-DSET&gt;&gt;
  &lt;&lt;print-exposure-print-results&gt;&gt;
  &lt;&lt;print-exposure-close-file-free-data&gt;&gt; 
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8553354" class="outline-5">
<h5 id="org8553354"><span class="section-number-5">6.2.0.2</span> <code>&lt;&lt;print-exposure-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-2">
<div class="org-src-container">
<pre class="src src-C" id="orgddcb2b1"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org23be834" class="outline-5">
<h5 id="org23be834"><span class="section-number-5">6.2.0.3</span> <code>&lt;&lt;print-exposure-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-3">
<div class="org-src-container">
<pre class="src src-C" id="org90e017e"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--group=string] [--frame=idx] [--file=string]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --group &lt;character string&gt;: the name of the group (eg, 10ms the default)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --frame &lt;positive integer&gt;: the frame index (from 0 to 99, default at 0)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --file &lt;character string&gt;: data file name (default CCD_calibration.hdf5)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file', gets to dataset 'group/stack' and prints to\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" the stdout the exposure whose index is given by frame.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd24fbb9" class="outline-5">
<h5 id="orgd24fbb9"><span class="section-number-5">6.2.0.4</span> <code>&lt;&lt;print-exposure-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-4">
<p>
This code block is probably more sophisticated than necessary given what we want to do with this program. It assigns the frame index to the <code>frame</code> variable, the complete dataset name to <code>dset</code> and makes <code>filename</code> point to a string containing the filename. It moreover checks that the Group name is among the known group names. 
</p>

<div class="org-src-container">
<pre class="src src-C" id="org157f3d5"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">frame</span> = 0;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">default_file_name</span>[] = <span style="color: #ad7fa8; font-style: italic;">"CCD_calibration.hdf5"</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">filename</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">dset</span>[25];
dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_groups</span> = 10;
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groups</span>[] = {<span style="color: #ad7fa8; font-style: italic;">"10ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"20ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"30ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"40ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"50ms"</span>,
                    <span style="color: #ad7fa8; font-style: italic;">"60ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"70ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"80ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"90ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"100ms"</span>};
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groupname</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"group"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'g'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"file"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"frame"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'i'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">file_name_set</span> = 0, <span style="color: #ff6347;">group_name_set</span> = 0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:g:i:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'i'</span>:
    {
      frame = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (frame &gt; 99)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"frame should between 0 and 99 inclusive.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }  
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      filename = optarg;
      file_name_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'g'</span>:
    {
      groupname = optarg;
      <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>;
      <span style="color: #729fcf; font-weight: bold;">for</span> (j=0; j&lt;n_groups; j++)
        <span style="color: #729fcf; font-weight: bold;">if</span> (strcmp(groupname,groups[j])==0)
          <span style="color: #729fcf; font-weight: bold;">break</span>;
      <span style="color: #729fcf; font-weight: bold;">if</span> (j == n_groups) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Unknown group\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
      group_name_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (group_name_set == 0) groupname =  groups[0];
  <span style="color: #729fcf; font-weight: bold;">if</span> (file_name_set == 0) filename =  default_file_name;
  strcat(dset,groupname);
  strcat(dset,<span style="color: #ad7fa8; font-style: italic;">"/stack"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb71925" class="outline-5">
<h5 id="orgbb71925"><span class="section-number-5">6.2.0.5</span> <code>&lt;&lt;print-exposure-open-FILE-and-read-DSET&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-5">
<p>
In this case we are using the more general way of allocating space to store the data. We use an explicit <code>malloc</code> with <code>int *data = malloc(nrow*ncol*nsamp*sizeof(int));</code> that allocates memory in the heap (that <i>we must</i> free later on) instead of the <code>int data[nrow][ncol][nsamp];</code> that we used in our first HDF5 reading code (that allocates memory in the stack, meaning we do not have to free it ourselves).
</p>

<div class="org-src-container">
<pre class="src src-C" id="org2011164"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Open FILE</span>
<span style="color: #8ae234; font-weight: bold;">hid_t</span> <span style="color: #ff6347;">file_id</span> = H5Fopen (filename, H5F_ACC_RDONLY, H5P_DEFAULT);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Get dimensions of 3D object contained in DSET</span>
<span style="color: #8ae234; font-weight: bold;">hsize_t</span> <span style="color: #ff6347;">dims</span>[3];
H5LTget_dataset_info(file_id,dset,dims,<span style="color: #8ae234;">NULL</span>,<span style="color: #8ae234;">NULL</span>);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nrow</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[0];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">ncol</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[1];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nsamp</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[2];
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Read dset in data</span>
<span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">data</span> = malloc(nrow*ncol*nsamp*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
H5LTread_dataset_int(file_id,dset,data);
</pre>
</div>
</div>
</div>

<div id="outline-container-org82ab8ba" class="outline-5">
<h5 id="org82ab8ba"><span class="section-number-5">6.2.0.6</span> <code>&lt;&lt;print-exposure-close-file-free-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-6">
<p>
Here we close the HDF5 file and we free the memory space taken up by <code>data</code>.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org746608b">free(data);
H5Fclose (file_id);
</pre>
</div>
</div>
</div>

<div id="outline-container-org95330fa" class="outline-5">
<h5 id="org95330fa"><span class="section-number-5">6.2.0.7</span> <code>&lt;&lt;print-exposure-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-2-0-7">
<p>
The only tricky part here is due to the way we allocated the memory space taken by <code>data</code>, we cannot use <code>data[i][j][frame]</code> as we would have done previously, we must use <code>data[(i*ncol+j)*nsamp+frame]</code> instead:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org3366969"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=0; j&lt;ncol; j++)
    printf(<span style="color: #ad7fa8; font-style: italic;">"%d "</span>,data[(i*ncol+j)*nsamp+frame]);
  printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org20870d6" class="outline-5">
<h5 id="org20870d6"><span class="section-number-5">6.2.0.8</span> Compile <code>print-exposure</code></h5>
<div class="outline-text-5" id="text-6-2-0-8">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org224713f">gcc -W -g -o code/print-exposure code/print-exposure.c -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-orga57f304" class="outline-5">
<h5 id="orga57f304"><span class="section-number-5">6.2.0.9</span> Use and test</h5>
<div class="outline-text-5" id="text-6-2-0-9">
<p>
We use the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org33bcd04">./code/print-exposure &gt; toto
</pre>
</div>

<p>
We use valgrind on it with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org56abdd0">valgrind ./code/print-exposure &gt; toto
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbafb54c" class="outline-5">
<h5 id="orgbafb54c"><span class="section-number-5">6.2.0.10</span> Do the figure</h5>
<div class="outline-text-5" id="text-6-2-0-10">
<div class="org-src-container">
<pre class="src src-gnuplot" id="orga84a5b1"><span style="color: #8ae234;">set</span> palette grey
<span style="color: #8ae234;">set</span> cblabel <span style="color: #ad7fa8; font-style: italic;">"ADU"</span>

<span style="color: #8ae234;">set</span> xrange [<span style="color: #8ae234;">0:79</span>]
<span style="color: #8ae234;">set</span> yrange [<span style="color: #8ae234;">0:59</span>]
<span style="color: #8ae234;">set</span> view map
<span style="color: #729fcf; font-weight: bold;">splot</span> [<span style="color: #8ae234;">0:79</span>][<span style="color: #8ae234;">0:59</span>] <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/print-exposure"</span> <span style="color: #8ae234; font-weight: bold;">matrix</span> <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">image</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/first_exposure.svg" class="org-svg" alt="First exposure at 10 ms of the CCD chip" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 9: </span><a id="org47a5de9"></a> First exposure at 10 ms of the CCD chip.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org3d3d56b" class="outline-3">
<h3 id="org3d3d56b"><span class="section-number-3">6.3</span> Dumping and plotting ADU sequences</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-org5f68e85" class="outline-4">
<h4 id="org5f68e85"><span class="section-number-4">6.3.1</span> Definition and use of a shell function to dump the data</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
If we just want to plot a few ADU sequences, we can make use of the options of <code>h5dump</code> that allow us to print to the <code>stdout</code> part of an HDF5 file, like here if we want to look at the ADU sequence of row 31, column 41 (starting counting at 0) for the 10ms Group:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgbbae453">h5dump -d <span style="color: #ad7fa8; font-style: italic;">"/10ms/stack[31,41,0;;1,1,100;]"</span> -A 0 CCD_calibration.hdf5
</pre>
</div>

<pre class="example">
HDF5 "CCD_calibration.hdf5" {
DATASET "/10ms/stack" {
   DATATYPE  H5T_STD_I32LE
   DATASPACE  SIMPLE { ( 60, 80, 100 ) / ( 60, 80, 100 ) }
   SUBSET {
      START ( 31, 41, 0 );
      STRIDE ( 1, 1, 1 );
      COUNT ( 1, 1, 100 );
      BLOCK ( 1, 1, 1 );
      DATA {
      (31,41,0): 419, 423, 422, 411, 412, 412, 407, 423, 424, 427, 419, 409,
      (31,41,12): 409, 410, 413, 420, 412, 440, 413, 416, 413, 416, 408, 417,
      (31,41,24): 410, 418, 405, 420, 415, 424, 417, 422, 405, 397, 412, 413,
      (31,41,36): 409, 408, 412, 421, 420, 416, 400, 425, 408, 405, 408, 419,
      (31,41,48): 405, 406, 416, 418, 413, 412, 421, 418, 422, 414, 426, 414,
      (31,41,60): 403, 418, 406, 414, 395, 400, 416, 411, 408, 414, 412, 425,
      (31,41,72): 415, 418, 414, 415, 401, 409, 421, 412, 415, 417, 424, 426,
      (31,41,84): 422, 412, 411, 420, 413, 431, 420, 426, 411, 416, 408, 398,
      (31,41,96): 411, 412, 417, 413
      }
   }
}
}
</pre>

<p>
Now we are just interested in the data part so we extract everything that comes of a regular expression looking like the following pattern: <code>(number,number,number):</code> using  the <code>sed</code> program (this command sequence was built interactively from the shell):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgb6e0d8a">h5dump -d <span style="color: #ad7fa8; font-style: italic;">"/10ms/stack[31,41,0;;1,1,100;]"</span> -A 0 CCD_calibration.hdf5 | <span style="color: #ad7fa8; font-style: italic;">\</span>
    grep <span style="color: #ad7fa8; font-style: italic;">"([0-9][0-9],[0-9][0-9],\(0\|[0-9][0-9]\)):"</span> | <span style="color: #ad7fa8; font-style: italic;">\</span>
    sed -e <span style="color: #ad7fa8; font-style: italic;">"s/[[:space:]]*([0-9][0-9],[0-9][0-9],\(0\|[0-9][0-9]\)):[[:space:]]*//g"</span> |<span style="color: #ad7fa8; font-style: italic;">\</span>
    sed -e <span style="color: #ad7fa8; font-style: italic;">"s/,$//g"</span> | sed -e <span style="color: #ad7fa8; font-style: italic;">"s/,[[:space:]]*/\n/g"</span>
</pre>
</div>

<pre class="example">
419
423
422
411
412
412
407
423
424
427
419
409
409
410
413
420
412
440
413
416
413
416
408
417
410
418
405
420
415
424
417
422
405
397
412
413
409
408
412
421
420
416
400
425
408
405
408
419
405
406
416
418
413
412
421
418
422
414
426
414
403
418
406
414
395
400
416
411
408
414
412
425
415
418
414
415
401
409
421
412
415
417
424
426
422
412
411
420
413
431
420
426
411
416
408
398
411
412
417
413
</pre>

<p>
We can then write a short shell script taking parameters and dumping the ADU sequence we are interested in:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgaade3de"><span style="color: #2c5115;">#</span><span style="color: #888a85;">!/bin/</span><span style="color: #729fcf; font-weight: bold;">bash</span>
<span style="color: #2c5115;"># </span><span style="color: #888a85;">Usage:     adu_sequence row column</span>
<span style="color: #2c5115;"># </span><span style="color: #888a85;">Dumps the corresponding adu sequence </span>

h5dump -d <span style="color: #ad7fa8; font-style: italic;">"/10ms/stack[$1,$2,0;;1,1,100;]"</span> -A 0 CCD_calibration.hdf5 | <span style="color: #ad7fa8; font-style: italic;">\</span>
    grep <span style="color: #ad7fa8; font-style: italic;">"([0-9][0-9],[0-9][0-9],\(0\|[0-9][0-9]\)):"</span> | <span style="color: #ad7fa8; font-style: italic;">\</span>
    sed -e <span style="color: #ad7fa8; font-style: italic;">"s/[[:space:]]*([0-9][0-9],[0-9][0-9],\(0\|[0-9][0-9]\)):[[:space:]]*//g"</span> |<span style="color: #ad7fa8; font-style: italic;">\</span>
    sed -e <span style="color: #ad7fa8; font-style: italic;">"s/,$//g"</span> | sed -e <span style="color: #ad7fa8; font-style: italic;">"s/,[[:space:]]*/\n/g"</span>
</pre>
</div>

<p>
We have to change the mode of our script to be able to use it with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org9a4eeee">chmod u+x code/adu_sequence.sh
</pre>
</div>

<p>
We can then use our code with (result not shown):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org99ba3e0">./code/adu_sequence.sh 31 41
</pre>
</div>
</div>
</div>

<div id="outline-container-org3cab1ea" class="outline-4">
<h4 id="org3cab1ea"><span class="section-number-4">6.3.2</span> Making the figure</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
We can now make our figure using the <a href="http://www.gnuplotting.org/multiplot-placing-graphs-next-to-each-other/"><code>multiplot</code></a> feature of <code>gnuplot</code>:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="org31ac493"><span style="color: #8ae234;">unset</span> key
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> multiplot layout 3,1 margins 0.1,0.9,0.1,0.95 spacing 0,0
<span style="color: #8ae234;">set</span> xtics 20 format <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"ADU"</span>
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">1:100</span>][<span style="color: #8ae234;">390:440</span>] <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 41"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 0:1\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>
<span style="color: #8ae234;">set</span> xtics 20 format <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"ADU"</span>
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">1:100</span>][<span style="color: #8ae234;">390:440</span>] <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 40"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 0:1\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>
<span style="color: #8ae234;">set</span> format x <span style="color: #ad7fa8; font-style: italic;">"%g"</span>
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Frame index"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"ADU"</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">1:100</span>][<span style="color: #8ae234;">390:440</span>] <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 39"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 0:1\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>
<span style="color: #8ae234;">unset</span> grid
<span style="color: #8ae234;">unset</span> multiplot
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/plot_adu_sequences.svg" class="org-svg" alt="3 ADU sequences" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 10: </span><a id="org9e36b9d"></a> 3 ADU sequences from the exposure at 10 ms of the CCD chip. They are all from row 31 and from bottom to to from column 39, 40 and 41.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf4c407a" class="outline-3">
<h3 id="orgf4c407a"><span class="section-number-3">6.4</span> Linear fit of a single sequence</h3>
<div class="outline-text-3" id="text-6-4">
<p>
We now fit a straight line to a single ADU sequence like the ones that are dumped to the <code>stdout</code> by our <code>adu_sequence.sh</code> function. We will write a program doing this job, <code>adu_sequence_fit</code>. This program will read the data from the <code>stdin</code> and will print to the <code>sdtout</code> a <code>gnuplot</code> compatible dataset with fitting results as comments followed by four columns containing the frame index, the fitted ADU value, its 95% lower bound and its 95% upper bound.
</p>
</div>

<div id="outline-container-org571a808" class="outline-5">
<h5 id="org571a808"><span class="section-number-5">6.4.0.1</span> <code>adu_sequence_fit</code> skeleton</h5>
<div class="outline-text-5" id="text-6-4-0-1">
<div class="org-src-container">
<pre class="src src-C" id="org8de3b73">&lt;&lt;adu_sequence_fit-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;adu_sequence_fit-usage&gt;&gt;
  &lt;&lt;adu_sequence_fit-args&gt;&gt;
  &lt;&lt;adu_sequence_fit-read-data&gt;&gt;
  &lt;&lt;adu_sequence_fit-fit&gt;&gt;
  &lt;&lt;adu_sequence_fit-print-results&gt;&gt;  
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org13b9c18" class="outline-5">
<h5 id="org13b9c18"><span class="section-number-5">6.4.0.2</span> <code>&lt;&lt;adu_sequence_fit-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-2">
<div class="org-src-container">
<pre class="src src-C" id="orgfc83966"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_fit.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_cdf.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b6c89c" class="outline-5">
<h5 id="org7b6c89c"><span class="section-number-5">6.4.0.3</span> <code>&lt;&lt;adu_sequence_fit-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-3">
<div class="org-src-container">
<pre class="src src-C" id="org5a6f7ba"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--nb_frames=integer] [--conf_level=real]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --nb_frames &lt;positive integer&gt;: the number of frames (default at 100)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --conf_level &lt;positive real&gt;: confidence level (between 0 and 1, default 0.95)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program reads data from the stdin and performs a linear fit.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" It prints to the stdout data compatible with gnuplot with the\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" fitting results as comments followed by 4 columns:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   - the frame index\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   - the fitted ADU\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   - the lower bound of the fitted ADU\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   - the upper bound of the fitted ADU.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org7979bcf" class="outline-5">
<h5 id="org7979bcf"><span class="section-number-5">6.4.0.4</span> <code>&lt;&lt;adu_sequence_fit-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-4">
<p>
This code block initializes two variables: <code>n</code> (size_t) that contains the number of ADU in the sequence and <code>cl</code> (a double) that contains the requested confidence level.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org1abff0d"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n</span> = 100;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">cl</span> = 0.95;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"nb_frames"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'n'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"conf_level"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'c'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hn:c:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'n'</span>:
    {
      n = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'c'</span>:
    {
      cl = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (cl &lt;= 0 | cl &gt;= 1)
      {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"A confidence interval should be between 0 and 1.\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge492621" class="outline-5">
<h5 id="orge492621"><span class="section-number-5">6.4.0.5</span> <code>&lt;&lt;adu_sequence_fit-read-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-5">
<div class="org-src-container">
<pre class="src src-C" id="org95e0fc3"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span>[n];
{
  <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">input</span>[256];
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0;
  <span style="color: #729fcf; font-weight: bold;">while</span> (fgets(input,<span style="color: #729fcf; font-weight: bold;">sizeof</span>(input),stdin) != <span style="color: #8ae234;">NULL</span> &amp; i &lt; n) {
    adu[i] = (<span style="color: #8ae234; font-weight: bold;">double</span>) atoi(input);
    i++;
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (i != n)
    fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Fewer ADU than planed.\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org41c37f6" class="outline-5">
<h5 id="org41c37f6"><span class="section-number-5">6.4.0.6</span> <code>&lt;&lt;adu_sequence_fit-fit&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-6">
<div class="org-src-container">
<pre class="src src-C" id="org43ea173"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">x</span>[n];
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;n; i++)
  x[i] = (<span style="color: #8ae234; font-weight: bold;">double</span>) i;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">c0</span>, <span style="color: #ff6347;">c1</span>, <span style="color: #ff6347;">cov00</span>, <span style="color: #ff6347;">cov01</span>, <span style="color: #ff6347;">cov11</span>, <span style="color: #ff6347;">sumsq</span>;
gsl_fit_linear (x, 1, adu, 1, n, &amp;c0, &amp;c1,
                &amp;cov00, &amp;cov01, &amp;cov11, 
                &amp;sumsq);
</pre>
</div>
</div>
</div>

<div id="outline-container-org79e915a" class="outline-5">
<h5 id="org79e915a"><span class="section-number-5">6.4.0.7</span> <code>&lt;&lt;adu_sequence_fit-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-4-0-7">
<div class="org-src-container">
<pre class="src src-C" id="orgfb28a89">printf (<span style="color: #ad7fa8; font-style: italic;">"# best fit: ADU = %g + %g F\n"</span>, c0, c1);
printf (<span style="color: #ad7fa8; font-style: italic;">"# covariance matrix:\n"</span>);
printf (<span style="color: #ad7fa8; font-style: italic;">"# [ %g, %g\n#   %g, %g]\n"</span>, 
        cov00, cov01, cov01, cov11);
printf (<span style="color: #ad7fa8; font-style: italic;">"# Residual sum of squares = %g\n"</span>, sumsq);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">slope_se</span> = sqrt(cov11)*gsl_cdf_tdist_Pinv(1.0-(1.0-cl)*0.5,(<span style="color: #8ae234; font-weight: bold;">double</span>)n-3.0);
printf (<span style="color: #ad7fa8; font-style: italic;">"# A %g confidence interval for the slope is (%g,%g)\n"</span>,
        cl,c1-slope_se,c1+slope_se);
printf (<span style="color: #ad7fa8; font-style: italic;">"#\n"</span>);
printf (<span style="color: #ad7fa8; font-style: italic;">"# Frame index  Fitted value  Lower bound  Upper bound\n"</span>); 
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">se_f</span> = gsl_cdf_gaussian_Pinv(1.0-(1-cl)*0.5,1.0);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;n; i++) {
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">aduf</span>, <span style="color: #ff6347;">aduf_err</span>;
  gsl_fit_linear_est(x[i],c0,c1,cov00, cov01,
                     cov11,&amp;aduf,&amp;aduf_err);
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g %g %g\n"</span>,
         x[i],aduf,aduf-se_f*aduf_err,
         aduf+se_f*aduf_err);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e43d02" class="outline-5">
<h5 id="org2e43d02"><span class="section-number-5">6.4.0.8</span> Compile <code>adu_sequence_fit</code></h5>
<div class="outline-text-5" id="text-6-4-0-8">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgb252278">gcc -W -g -o code/adu_sequence_fit code/adu_sequence_fit.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb72c5a" class="outline-5">
<h5 id="orgbb72c5a"><span class="section-number-5">6.4.0.9</span> Use and test <code>adu_sequence_fit</code></h5>
<div class="outline-text-5" id="text-6-4-0-9">
<p>
We use it piping the output of our shell function with:
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org5a517d6">./code/adu_sequence.sh 31 40 | ./code/adu_sequence_fit &gt; middle_adu_seq_fit
head middle_adu_seq_fit
</pre>
</div>

<pre class="example">
# best fit: ADU = 413.134 + 0.0320432 F
# covariance matrix:
# [ 2.07911, -0.0313433
#   -0.0313433, 0.000633199]
# Residual sum of squares = 5170.6
# A 0.95 confidence interval for the slope is (-0.0178928,0.0819792)
#
# Frame index  Fitted value  Lower bound  Upper bound
0 413.134 410.308 415.96
1 413.166 410.382 415.95
</pre>

<p>
We can check in two steps with valgrind as follows:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgb49330e">./code/adu_sequence.sh 31 40 &gt; middle_adu_seq
valgrind cat middle_adu_seq | ./code/adu_sequence_fit &gt; middle_adu_seq_fit
</pre>
</div>

<pre class="example">
==5596== Memcheck, a memory error detector
==5596== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==5596== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==5596== Command: cat middle_adu_seq
==5596== 
==5596== 
==5596== HEAP SUMMARY:
==5596==     in use at exit: 0 bytes in 0 blocks
==5596==   total heap usage: 31 allocs, 31 frees, 138,848 bytes allocated
==5596== 
==5596== All heap blocks were freed -- no leaks are possible
==5596== 
==5596== For counts of detected and suppressed errors, rerun with: -v
==5596== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>

<div id="outline-container-org2b1589d" class="outline-4">
<h4 id="org2b1589d"><span class="section-number-4">6.4.1</span> Making the figure</h4>
<div class="outline-text-4" id="text-6-4-1">
<div class="org-src-container">
<pre class="src src-gnuplot" id="orgb0e75d2"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Frame index"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"ADU"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">unset</span> key
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">1:100</span>][<span style="color: #8ae234;">395:435</span>] <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 40"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 0:1\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"blue"</span>, \
     <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 40 | ./code/adu_sequence_fit"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"red"</span>, \
     <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 40 | ./code/adu_sequence_fit"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:3\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"grey"</span>, \
     <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/adu_sequence.sh 31 40 | ./code/adu_sequence_fit"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:4\
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"grey"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/middle_adu_seq_fit_fig.svg" class="org-svg" alt="ADU sequences and fit" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 11: </span><a id="orgdc6aaf8"></a> ADU sequences from the exposure at 10 ms of the CCD chip at row 31 and column 40 (blue) with a linear fit (red). In grey: 95% confidence level for the regression line.</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd170c8c" class="outline-3">
<h3 id="orgd170c8c"><span class="section-number-3">6.5</span> Linear fit of all sequences in a given group</h3>
<div class="outline-text-3" id="text-6-5">
<p>
We now want to fit a straight line to the ADU sequence of each of the 60x80 pixels and to return the ratio of the slope to its standard error. The latter should be the realization of a random variable having a t distribution with 97 degrees of freedom (we have 100 observations in each sequence and we estimate three parameters: the intercept at the origin, the slope and the variance).  
</p>
</div>

<div id="outline-container-org264863f" class="outline-4">
<h4 id="org264863f"><span class="section-number-4">6.5.1</span> Program <code>adu_drift_test</code> definition</h4>
<div class="outline-text-4" id="text-6-5-1">
</div><div id="outline-container-org37191d5" class="outline-5">
<h5 id="org37191d5"><span class="section-number-5">6.5.1.1</span> <code>adu_drift_test</code> skeleton</h5>
<div class="outline-text-5" id="text-6-5-1-1">
<div class="org-src-container">
<pre class="src src-C" id="org9b80039">&lt;&lt;adu_drift_test-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;adu_drift_test-usage&gt;&gt;
  &lt;&lt;adu_drift_test-args&gt;&gt;
  &lt;&lt;adu_drift_test-read-data&gt;&gt;
  &lt;&lt;adu_drift_test-fit&gt;&gt;
  &lt;&lt;adu_drift_test-print-results&gt;&gt;
  &lt;&lt;adu_drift_test-close-file&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5115f10" class="outline-5">
<h5 id="org5115f10"><span class="section-number-5">6.5.1.2</span> <code>&lt;&lt;adu_drift_test-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-2">
<p>
This time, we are dealing with the HDF5 file so we need the corresponding headers:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org040aaa5"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_fit.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ca556d" class="outline-5">
<h5 id="org3ca556d"><span class="section-number-5">6.5.1.3</span> <code>&lt;&lt;adu_drift_test-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-3">
<div class="org-src-container">
<pre class="src src-C" id="org2a8cbb4"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--group=string] [--file=string]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --group &lt;character string&gt;: the name of the group (eg, 10ms the default)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --file &lt;character string&gt;: data file name (default CCD_calibration.hdf5)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file', gets to dataset 'group/stack', fits a straight\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" line to the ADU sequence of each pixel and prints to the stdout the slope\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" divided by its standard error (something that should follow a t distribution\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" with 97 degrees of freedom).\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbef8f84" class="outline-5">
<h5 id="orgbef8f84"><span class="section-number-5">6.5.1.4</span> <code>&lt;&lt;adu_drift_test-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-4">
<p>
Only a minor adaptation of <code>&lt;&lt;print-exposure-args&gt;&gt;</code> is required here (we do not pass the <code>frame</code>):
</p>

<div class="org-src-container">
<pre class="src src-C" id="org7d47520"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">frame</span> = 0;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">default_file_name</span>[] = <span style="color: #ad7fa8; font-style: italic;">"CCD_calibration.hdf5"</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">filename</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">dset</span>[25];
dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_groups</span> = 10;
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groups</span>[] = {<span style="color: #ad7fa8; font-style: italic;">"10ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"20ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"30ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"40ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"50ms"</span>,
                    <span style="color: #ad7fa8; font-style: italic;">"60ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"70ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"80ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"90ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"100ms"</span>};
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groupname</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"group"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'g'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"file"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">file_name_set</span> = 0, <span style="color: #ff6347;">group_name_set</span> = 0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:g:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      filename = optarg;
      file_name_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'g'</span>:
    {
      groupname = optarg;
      <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>;
      <span style="color: #729fcf; font-weight: bold;">for</span> (j=0; j&lt;n_groups; j++)
        <span style="color: #729fcf; font-weight: bold;">if</span> (strcmp(groupname,groups[j])==0)
          <span style="color: #729fcf; font-weight: bold;">break</span>;
      <span style="color: #729fcf; font-weight: bold;">if</span> (j == n_groups) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Unknown group\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
      group_name_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (group_name_set == 0) groupname =  groups[0];
  <span style="color: #729fcf; font-weight: bold;">if</span> (file_name_set == 0) filename =  default_file_name;
  strcat(dset,groupname);
  strcat(dset,<span style="color: #ad7fa8; font-style: italic;">"/stack"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org17e73eb" class="outline-5">
<h5 id="org17e73eb"><span class="section-number-5">6.5.1.5</span> <code>&lt;&lt;adu_drift_test-read-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-5">
<p>
We can directly reuse <code>&lt;&lt;print-exposure-open-FILE-and-read-DSET&gt;&gt;</code> here:
</p>

<div class="org-src-container">
<pre class="src src-C" id="org2666692">&lt;&lt;print-exposure-open-FILE-and-read-DSET&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orga77788a" class="outline-5">
<h5 id="orga77788a"><span class="section-number-5">6.5.1.6</span> <code>&lt;&lt;adu_drift_test-close-file&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-6">
<p>
Same as above&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgff5a7a8">&lt;&lt;print-exposure-close-file-free-data&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8ab9814" class="outline-5">
<h5 id="org8ab9814"><span class="section-number-5">6.5.1.7</span> <code>&lt;&lt;adu_drift_test-fit&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-7">
<div class="org-src-container">
<pre class="src src-C" id="org8a04d69"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">stat</span>[nrow*ncol];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">stat_idx</span>=0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">x</span>[nsamp];
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nsamp; i++)
  x[i] = (<span style="color: #8ae234; font-weight: bold;">double</span>) i;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">c0</span>, <span style="color: #ff6347;">c1</span>, <span style="color: #ff6347;">cov00</span>, <span style="color: #ff6347;">cov01</span>, <span style="color: #ff6347;">cov11</span>, <span style="color: #ff6347;">sumsq</span>;
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=0; j&lt;ncol; j++) {
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span>[nsamp];
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++)
      adu[k] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+k];
    gsl_fit_linear (x, 1, adu, 1, nsamp, &amp;c0,
                    &amp;c1, &amp;cov00, &amp;cov01, &amp;cov11, 
                    &amp;sumsq);
    stat[stat_idx] = c1/sqrt(cov11);
    stat_idx++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge73560d" class="outline-5">
<h5 id="orge73560d"><span class="section-number-5">6.5.1.8</span> <code>&lt;&lt;adu_drift_test-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-1-8">
<div class="org-src-container">
<pre class="src src-C" id="org5274b8e"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow*ncol; i++) 
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g\n"</span>,stat[i]);
</pre>
</div>
</div>
</div>

<div id="outline-container-org49cafae" class="outline-5">
<h5 id="org49cafae"><span class="section-number-5">6.5.1.9</span> Compile <code>adu_drift_test</code></h5>
<div class="outline-text-5" id="text-6-5-1-9">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgdffebf7">gcc -W -g -o code/adu_drift_test code/adu_drift_test.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-org151a8fe" class="outline-5">
<h5 id="org151a8fe"><span class="section-number-5">6.5.1.10</span> Use, test, etc of  <code>adu_drift_test</code></h5>
<div class="outline-text-5" id="text-6-5-1-10">
<p>
We use <code>adu_drift_test</code> on the first group with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org7c5ca00">./code/adu_drift_test --group=10ms &gt; adu_drift_test_10ms
head adu_drift_test_10ms
</pre>
</div>

<pre class="example">
0.218779
-1.93477
0.124839
-0.641004
0.976495
-1.53843
-0.366836
1.5394
-2.03652
0.0194629
</pre>

<p>
We can use valgrind on it with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgb51fef1">valgrind ./code/adu_drift_test --group=20ms &gt; adu_drift_test_20ms
</pre>
</div>

<pre class="example">
==7985== Memcheck, a memory error detector
==7985== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==7985== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==7985== Command: ./code/adu_drift_test --group=20ms
==7985== 
==7985== 
==7985== HEAP SUMMARY:
==7985==     in use at exit: 0 bytes in 0 blocks
==7985==   total heap usage: 6,560 allocs, 6,560 frees, 13,435,720 bytes allocated
==7985== 
==7985== All heap blocks were freed -- no leaks are possible
==7985== 
==7985== For counts of detected and suppressed errors, rerun with: -v
==7985== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>

<div id="outline-container-orgad04875" class="outline-5">
<h5 id="orgad04875"><span class="section-number-5">6.5.1.11</span> Computation of the drift statistic for all the groups</h5>
<div class="outline-text-5" id="text-6-5-1-11">
<p>
We are using a loop from the shell
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgfaee010">touch drift_for_all
<span style="color: #729fcf; font-weight: bold;">for</span> grp<span style="color: #729fcf; font-weight: bold;"> in</span> {10..100..10}ms ; <span style="color: #729fcf; font-weight: bold;">do</span>
  ./code/adu_drift_test --group=$<span style="color: #ff6347;">grp</span> &gt;&gt; drift_for_all
<span style="color: #729fcf; font-weight: bold;">done</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga48a23d" class="outline-4">
<h4 id="orga48a23d"><span class="section-number-4">6.5.2</span> Histogram building program</h4>
<div class="outline-text-4" id="text-6-5-2">
<p>
It is handy to have a program able to return an histogram if necessary, we now write one adapted from the <code>gsl-histogram</code> program (that comes with the <code>gsl</code> library and whose code is given in the <a href="https://www.gnu.org/software/gsl/manual/html_node/Example-programs-for-histograms.html#Example-programs-for-histograms">histogram examples</a>). The program reads data from the <code>stdin</code> and prints the resulting histogram to the <code>sdtout</code>.
</p>
</div>

<div id="outline-container-orgfb86f65" class="outline-5">
<h5 id="orgfb86f65"><span class="section-number-5">6.5.2.1</span> <code>mk_histogram</code> skeleton</h5>
<div class="outline-text-5" id="text-6-5-2-1">
<div class="org-src-container">
<pre class="src src-C" id="org8c3460c">&lt;&lt;mk_histogram-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;mk_histogram-usage&gt;&gt;
  &lt;&lt;mk_histogram-args&gt;&gt;
  &lt;&lt;mk_histogram-read-data&gt;&gt;
  &lt;&lt;mk_histogram-make-histo&gt;&gt;
  &lt;&lt;mk_histogram-print-results&gt;&gt;
  &lt;&lt;mk_histogram-free-memory&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff0ff65" class="outline-5">
<h5 id="orgff0ff65"><span class="section-number-5">6.5.2.2</span> <code>&lt;&lt;mk_histogram-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-2">
<div class="org-src-container">
<pre class="src src-C" id="org65953c5"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_vector.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_histogram.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffda559" class="outline-5">
<h5 id="orgffda559"><span class="section-number-5">6.5.2.3</span> <code>&lt;&lt;mk_histogram-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-3">
<div class="org-src-container">
<pre class="src src-C" id="orga45c226"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s --sample-size=integer [--min=real] [--max=real] ...\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"          ... [--n_bins=integer] [--unormalize]\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --sample-size &lt;positive integer&gt;: the sample size\n"</span>                                                                       
  <span style="color: #ad7fa8; font-style: italic;">"  --min &lt;double&gt;: the left boundary of the histogram (default: min value of the data)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --max &lt;double&gt;: the right boundary of the histogram (default: max value of the data)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --n_bins &lt;integer&gt;: the number of bins (default: max-min/sample size/10)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --unormalize: if set the histogram is not normalized\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program reads data from the stdin builts the histogram and prints it\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" to the stdout.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org95bff2d" class="outline-5">
<h5 id="org95bff2d"><span class="section-number-5">6.5.2.4</span> <code>&lt;&lt;mk_histogram-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-4">
<div class="org-src-container">
<pre class="src src-C" id="org9afd8ea"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">sample_size</span> = 0;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_bins</span>;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">min</span>,<span style="color: #ff6347;">max</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">normalize</span>=1,<span style="color: #ff6347;">min_set</span>=0,<span style="color: #ff6347;">max_set</span>=0,<span style="color: #ff6347;">bins_set</span>=0;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"sample_size"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'s'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"min"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'d'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"max"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'m'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"n_bins"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'b'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"unormalize"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'u'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hub:s:d:m:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'u'</span>:
    {
      normalize = 0;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'b'</span>:
    {
      n_bins = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
      bins_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'s'</span>:
    {
      sample_size = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'d'</span>:
    {
      min = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      min_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'m'</span>:
    {
      max = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      max_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (min_set &amp; max_set &amp; min&gt;max) {
    fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"min &gt; max! Not allowed.\n"</span>);
    <span style="color: #729fcf; font-weight: bold;">return</span> -1;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org80b64e3" class="outline-5">
<h5 id="org80b64e3"><span class="section-number-5">6.5.2.5</span> <code>&lt;&lt;mk_histogram-read-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-5">
<div class="org-src-container">
<pre class="src src-C" id="org1ff1d12"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">data</span>[sample_size];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">data_idx</span>=0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">x</span>;
<span style="color: #729fcf; font-weight: bold;">while</span> (fscanf(stdin, <span style="color: #ad7fa8; font-style: italic;">"%lg"</span>, &amp;x) == 1 &amp; \
       data_idx &lt; sample_size) {
  data[data_idx] = x;
  data_idx++;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf009103" class="outline-5">
<h5 id="orgf009103"><span class="section-number-5">6.5.2.6</span> <code>&lt;&lt;mk_histogram-make-histo&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-6">
<div class="org-src-container">
<pre class="src src-C" id="org74e05f4"><span style="color: #729fcf; font-weight: bold;">if</span> (<span style="color: #3b5998;">!</span>min_set | <span style="color: #3b5998;">!</span>max_set) {
  <span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">data_v</span> = gsl_vector_view_array (data, sample_size);
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">xmin</span>,<span style="color: #ff6347;">xmax</span>;
  gsl_vector_minmax(&amp;data_v.vector,&amp;xmin,&amp;xmax);
  <span style="color: #729fcf; font-weight: bold;">if</span> (<span style="color: #3b5998;">!</span>min_set)
    min = xmin;
  <span style="color: #729fcf; font-weight: bold;">if</span> (<span style="color: #3b5998;">!</span>max_set)
    max = xmax;
}
<span style="color: #729fcf; font-weight: bold;">if</span> (<span style="color: #3b5998;">!</span>bins_set)
  n_bins = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) ceil((max-min)*sample_size/10);
<span style="color: #8ae234; font-weight: bold;">gsl_histogram</span> *<span style="color: #ff6347;">h</span> = gsl_histogram_alloc (n_bins);
gsl_histogram_set_ranges_uniform (h, min, max);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;sample_size; i++)
  gsl_histogram_increment(h, data[i]);
<span style="color: #729fcf; font-weight: bold;">if</span> (normalize)
  gsl_histogram_scale (h,(<span style="color: #8ae234; font-weight: bold;">double</span>)n_bins/(sample_size*(max-min)));
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e3f7cd" class="outline-5">
<h5 id="org4e3f7cd"><span class="section-number-5">6.5.2.7</span> <code>&lt;&lt;mk_histogram-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-7">
<div class="org-src-container">
<pre class="src src-C" id="orga9c0c49">gsl_histogram_fprintf (stdout, h, <span style="color: #ad7fa8; font-style: italic;">"%g"</span>, <span style="color: #ad7fa8; font-style: italic;">"%g"</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7174e8" class="outline-5">
<h5 id="orgc7174e8"><span class="section-number-5">6.5.2.8</span> <code>&lt;&lt;mk_histogram-free-memory&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-5-2-8">
<div class="org-src-container">
<pre class="src src-C" id="org3dcfcc1">gsl_histogram_free (h);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0e0e285" class="outline-5">
<h5 id="org0e0e285"><span class="section-number-5">6.5.2.9</span> Compile <code>mk_histogram</code></h5>
<div class="outline-text-5" id="text-6-5-2-9">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6c64b3d">gcc -W -g -o code/mk_histogram code/mk_histogram.c -lgsl -lgslcblas -lm -std=gnu11
</pre>
</div>
</div>
</div>

<div id="outline-container-org974568d" class="outline-5">
<h5 id="org974568d"><span class="section-number-5">6.5.2.10</span> Check <code>mk_histogram</code></h5>
<div class="outline-text-5" id="text-6-5-2-10">
<p>
We pass the code through valgrind. We get the only required parameter, the number of lines in the file, through a call to <code>wc</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgbdc9502"><span style="color: #ff6347;">file_name</span>=drift_for_all
<span style="color: #ff6347;">samp_size</span>=<span style="color: #fa8072;">`wc -l $file_name | sed -e "s/ $file_name//g"`</span>
valgrind ./code/mk_histogram --sample_size=$<span style="color: #ff6347;">samp_size</span> <span style="color: #ad7fa8; font-style: italic;">\</span>
         &lt; $<span style="color: #ff6347;">file_name</span> &gt; dump
</pre>
</div>

<pre class="example">
==3372== Memcheck, a memory error detector
==3372== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==3372== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==3372== Command: ./code/mk_histogram --sample_size=48000
==3372== 
==3372== 
==3372== HEAP SUMMARY:
==3372==     in use at exit: 0 bytes in 0 blocks
==3372==   total heap usage: 5 allocs, 5 frees, 741,088 bytes allocated
==3372== 
==3372== All heap blocks were freed -- no leaks are possible
==3372== 
==3372== For counts of detected and suppressed errors, rerun with: -v
==3372== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>
</div>

<div id="outline-container-org80f8eaa" class="outline-4">
<h4 id="org80f8eaa"><span class="section-number-4">6.5.3</span> Making the figure</h4>
<div class="outline-text-4" id="text-6-5-3">
<p>
We make the figure comparing the histogram of scaled slope coefficients with the theoretical \(t_{97}\) density as shown next. One trick is that we have to define within <code>gnuplot</code> a function returning the <a href="https://en.wikipedia.org/wiki/Student's_t-distribution">t-distribution</a> probability density function. The number of bins is not the default one and was chosen after a few trials:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="orgcec62bd"><span style="color: #ff6347;">t_pdf(x,nu) =</span> <span style="color: #edd400; font-weight: bold;">gamma</span>(.5*(nu+1))*(1+x**2/nu)**(-.5*(nu+1))/<span style="color: #edd400; font-weight: bold;">sqrt</span>(pi*nu)/<span style="color: #edd400; font-weight: bold;">gamma</span>(.5*nu)
<span style="color: #8ae234;">unset</span> key
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Scaled slope coefficient"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Density"</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">-5:5</span>][<span style="color: #8ae234;">0:0.45</span>] t_pdf(x,97) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"orange"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 3,\
     <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/mk_histogram --sample_size=48000 --n_bins=200 &lt; drift_for_all"</span>\
     <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">steps</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/drift_for_all_hist.svg" class="org-svg" alt="histo of scaled slopes" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 12: </span><a id="org35b63fa"></a> Probability density estimation for the fitted slope coefficient divided by its standard error for every pixel and every exposure duation (histogram built from 48,000 obervations, black). In orange the theoretical \(t_{97}\) Student's probability density function.</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgbc5846f" class="outline-3">
<h3 id="orgbc5846f"><span class="section-number-3">6.6</span> Correlation coefficients between sequences of nearest neighbor pixels</h3>
<div class="outline-text-3" id="text-6-6">
<p>
The next global test we apply looks at correlation between the ADU sequences of pairs of pixels that are nearest neighbors.
</p>
</div>

<div id="outline-container-orga4c6d56" class="outline-4">
<h4 id="orga4c6d56"><span class="section-number-4">6.6.1</span> Program <code>adu_corr_test</code> definition</h4>
<div class="outline-text-4" id="text-6-6-1">
</div><div id="outline-container-org9368618" class="outline-5">
<h5 id="org9368618"><span class="section-number-5">6.6.1.1</span> <code>&lt;&lt;adu_corr_test&gt;&gt;</code> skeleton</h5>
<div class="outline-text-5" id="text-6-6-1-1">
<div class="org-src-container">
<pre class="src src-C" id="org85c4036">&lt;&lt;adu_corr_test-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;adu_corr_test-usage&gt;&gt;
  &lt;&lt;adu_drift_test-args&gt;&gt;
  &lt;&lt;adu_drift_test-read-data&gt;&gt;
  &lt;&lt;adu_corr_test-corr-and-print&gt;&gt;
  &lt;&lt;adu_drift_test-close-file&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org73481ac" class="outline-5">
<h5 id="org73481ac"><span class="section-number-5">6.6.1.2</span> <code>&lt;&lt;adu_corr_test-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-6-1-2">
<p>
We are dealing with the HDF5 file so we need the corresponding headers and the <code>gsl_stats_correlation</code> signature is in header <code>gsl_statistics_double.h</code>:
</p>

<div class="org-src-container">
<pre class="src src-C" id="orge1f9c4f"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_statistics_double.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga2db2a4" class="outline-5">
<h5 id="orga2db2a4"><span class="section-number-5">6.6.1.3</span> <code>&lt;&lt;adu_corr_test-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-6-1-3">
<div class="org-src-container">
<pre class="src src-C" id="org366f51c"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--group=string] [--file=string]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --group &lt;character string&gt;: the name of the group (eg, 10ms the default)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --file &lt;character string&gt;: data file name (default CCD_calibration.hdf5)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file', gets to dataset 'group/stack', gets the correlation\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" coefficient of every pair of nearest neighbor ADU sequences and prints them to\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" the stdout.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" Under the null hypothesis these correlation coefficients follow a Gaussian\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" distribution centered on 0 with a variance of 1/100.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeebb580" class="outline-5">
<h5 id="orgeebb580"><span class="section-number-5">6.6.1.4</span> <code>&lt;&lt;adu_corr_test-corr-and-print&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-6-1-4">
<div class="org-src-container">
<pre class="src src-C" id="orge04775f"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">corr</span>;
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=1; i&lt;(nrow-1); i+=2) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=1; j&lt;(ncol-1); j+=2) {
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu_ref</span>[nsamp];
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">idx</span>=0; idx&lt;nsamp; idx++)
      adu_ref[idx] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+idx];
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu_test</span>[nsamp];
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">idx</span>=0; idx&lt;nsamp; idx++) 
      adu_test[idx] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[((i-1)*ncol+j)*nsamp+idx];
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">look at pixel one row above</span>
    corr = gsl_stats_correlation(adu_ref, 1, adu_test, 1, nsamp);
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g\n"</span>,corr);
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">idx</span>=0; idx&lt;nsamp; idx++)
      adu_test[idx] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[((i+1)*ncol+j)*nsamp+idx];
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">look at pixel one row below</span>
    corr = gsl_stats_correlation(adu_ref, 1, adu_test, 1, nsamp);
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g\n"</span>,corr);
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">idx</span>=0; idx&lt;nsamp; idx++)
      adu_test[idx] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+(j-1))*nsamp+idx];
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">look at pixel one column to the left</span>
    corr = gsl_stats_correlation(adu_ref, 1, adu_test, 1, nsamp);
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g\n"</span>,corr);
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">idx</span>=0; idx&lt;nsamp; idx++)
      adu_test[idx] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+(j+1))*nsamp+idx];
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">look at pixel one column to the right</span>
    corr = gsl_stats_correlation(adu_ref, 1, adu_test, 1, nsamp);    
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g\n"</span>,corr);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org73d5cbb" class="outline-5">
<h5 id="org73d5cbb"><span class="section-number-5">6.6.1.5</span> Compile and check <code>adu_corr_test</code></h5>
<div class="outline-text-5" id="text-6-6-1-5">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org87f816f">gcc -W -g -o code/adu_corr_test code/adu_corr_test.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We check the code with valgrind as follows:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org9bbb257">valgrind ./code/adu_corr_test --group=10ms &gt; dump
</pre>
</div>

<pre class="example">
==4243== Memcheck, a memory error detector
==4243== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==4243== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==4243== Command: ./code/adu_corr_test --group=10ms
==4243== 
==4243== 
==4243== HEAP SUMMARY:
==4243==     in use at exit: 0 bytes in 0 blocks
==4243==   total heap usage: 6,603 allocs, 6,603 frees, 13,987,160 bytes allocated
==4243== 
==4243== All heap blocks were freed -- no leaks are possible
==4243== 
==4243== For counts of detected and suppressed errors, rerun with: -v
==4243== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>


<div id="outline-container-org3b35d74" class="outline-5">
<h5 id="org3b35d74"><span class="section-number-5">6.6.1.6</span> Computation of the correlation statistic for all the groups</h5>
<div class="outline-text-5" id="text-6-6-1-6">
<p>
We are using a loop from the shell
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org89d1eff">touch corr_for_all
<span style="color: #729fcf; font-weight: bold;">for</span> grp<span style="color: #729fcf; font-weight: bold;"> in</span> {10..100..10}ms ; <span style="color: #729fcf; font-weight: bold;">do</span>
  ./code/adu_corr_test --group=$<span style="color: #ff6347;">grp</span> &gt;&gt; corr_for_all
<span style="color: #729fcf; font-weight: bold;">done</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc852bb7" class="outline-4">
<h4 id="orgc852bb7"><span class="section-number-4">6.6.2</span> Making the figure</h4>
<div class="outline-text-4" id="text-6-6-2">
<p>
We make the figure comparing the histogram of correlation coefficients with the theoretical normal density centered on zero with a variance of 1/100 as shown next. One trick is that we have to define within <code>gnuplot</code> a function returning the normal probability density function. The number of bins is not the default one and was chosen after a few trials:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="org0d45b5e"><span style="color: #ff6347;">gogo(x,var) =</span> <span style="color: #edd400; font-weight: bold;">exp</span>(-0.5*x**2/var)/<span style="color: #edd400; font-weight: bold;">sqrt</span>(2*pi*var)
<span style="color: #8ae234;">unset</span> key
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Correlation coefficient between nearest neighbor pixels"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Density"</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">-0.5:0.5</span>][<span style="color: #8ae234;">0:4.5</span>] gogo(x,0.01) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"orange"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 3,\
     <span style="color: #ad7fa8; font-style: italic;">"&lt;./code/mk_histogram --sample_size=45240 --n_bins=200 &lt; corr_for_all"</span>\
     <span style="color: #8ae234; font-weight: bold;">using</span> 1:3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">steps</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/corr_for_all_hist.svg" class="org-svg" alt="histo of correlation" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 13: </span><a id="org8f7560a"></a> Probability density estimation for the correlation coefficient between the ADU sequences of every nearest neighbor pixels and every exposure duation (histogram built from 45,240 obervations, black). In orange the theoretical \(\mathcal{N}(\;,0.01)\) probability density function.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org0849ebe" class="outline-3">
<h3 id="org0849ebe"><span class="section-number-3">6.7</span> Getting the CCD parameters: G and \(\sigma^2_{ro}\)</h3>
<div class="outline-text-3" id="text-6-7">
</div><div id="outline-container-orge6d9c16" class="outline-4">
<h4 id="orge6d9c16"><span class="section-number-4">6.7.1</span> Obtaining the data for the regression analysis</h4>
<div class="outline-text-4" id="text-6-7-1">
<p>
Now that we are reasonably confident that our calibration data are usable, we write a program that returns the mean ADU and the ADU variance for each pixel and each exposure time. We make our program take as optional parameters the CCD gain and \(\sigma^2_{ro}\). If they are set then variance stabilization is performed.
</p>
</div>

<div id="outline-container-org77105ce" class="outline-5">
<h5 id="org77105ce"><span class="section-number-5">6.7.1.1</span> Program <code>adu_mu_s2</code> skeleton</h5>
<div class="outline-text-5" id="text-6-7-1-1">
<div class="org-src-container">
<pre class="src src-C" id="orga5b06b0">&lt;&lt;adu_mu_s2-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;adu_mu_s2-usage&gt;&gt;
  &lt;&lt;adu_mu_s2-args&gt;&gt;
  &lt;&lt;adu_mu_s2-open-file&gt;&gt;
  &lt;&lt;adu_mu_s2-get-mean-variance-and-print&gt;&gt;
  &lt;&lt;adu_mu_s2-close-file-free-data&gt;&gt;  
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9990919" class="outline-5">
<h5 id="org9990919"><span class="section-number-5">6.7.1.2</span> <code>&lt;&lt;adu_mu_s2-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-2">
<div class="org-src-container">
<pre class="src src-C" id="org84beaf7"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_statistics_double.h&gt;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org458160a" class="outline-5">
<h5 id="org458160a"><span class="section-number-5">6.7.1.3</span> <code>&lt;&lt;adu_mu_s2-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-3">
<div class="org-src-container">
<pre class="src src-C" id="orged7977d"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s [--file=string] [--gain=real] [--variance=real]\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --file &lt;character string&gt;: data file name (default CCD_calibration.hdf5)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --gain &lt;positive real&gt;: CCD gain (default 1)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  --variance &lt;positive or null real&gt;: CCD gain (default 0)\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file', and for each dataset, for each pixel\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" computes the mean ADU and the ADU variance. If 'gain' and 'variance'\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" are diffferent from 1 and 0 repectively then variance stabilization is\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" performed, that is, the program works with 2*sqrt(ADU/gain+variance)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" instead of working with the ADU directly.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program prints its results to the stdout with the mean on the first\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" column and the variance on the second.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e9f9c6" class="outline-5">
<h5 id="org5e9f9c6"><span class="section-number-5">6.7.1.4</span> <code>&lt;&lt;adu_mu_s2-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-4">
<div class="org-src-container">
<pre class="src src-C" id="orgde37dc2"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">frame</span> = 0;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">default_file_name</span>[] = <span style="color: #ad7fa8; font-style: italic;">"CCD_calibration.hdf5"</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">filename</span>;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gain</span> = 1.0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">read_out_var</span> = 0.0;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"file"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"gain"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'g'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"variance"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'v'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">file_name_set</span> = 0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:g:v:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      filename = optarg;
      file_name_set = 1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'g'</span>:
    {
      gain = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (gain &lt;= 0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"gain must be &gt; 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'v'</span>:
    {
      read_out_var = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (read_out_var &lt; 0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"variance must be &gt;= 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (file_name_set == 0) filename =  default_file_name;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9a859f5" class="outline-5">
<h5 id="org9a859f5"><span class="section-number-5">6.7.1.5</span> <code>&lt;&lt;adu_mu_s2-open-file&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-5">
<div class="org-src-container">
<pre class="src src-C" id="orgbe4c050"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Open FILE</span>
<span style="color: #8ae234; font-weight: bold;">hid_t</span> <span style="color: #ff6347;">file_id</span> = H5Fopen (filename, H5F_ACC_RDONLY, H5P_DEFAULT);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Get dimensions of 3D object contained in DSET</span>
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_groups</span> = 10;
<span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groups</span>[] = {<span style="color: #ad7fa8; font-style: italic;">"10ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"20ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"30ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"40ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"50ms"</span>,
                  <span style="color: #ad7fa8; font-style: italic;">"60ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"70ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"80ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"90ms"</span>,<span style="color: #ad7fa8; font-style: italic;">"100ms"</span>};
<span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groupname</span> = groups[0];
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">dset</span>[25];
dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
strcat(dset,groupname);
strcat(dset,<span style="color: #ad7fa8; font-style: italic;">"/stack"</span>);
<span style="color: #8ae234; font-weight: bold;">hsize_t</span> <span style="color: #ff6347;">dims</span>[3];
H5LTget_dataset_info(file_id,dset,dims,<span style="color: #8ae234;">NULL</span>,<span style="color: #8ae234;">NULL</span>);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nrow</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[0];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">ncol</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[1];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nsamp</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[2];
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Read dset in data</span>
<span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">data</span> = malloc(nrow*ncol*nsamp*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
</pre>
</div>
</div>
</div>

<div id="outline-container-org292f9c2" class="outline-5">
<h5 id="org292f9c2"><span class="section-number-5">6.7.1.6</span> <code>&lt;&lt;adu_mu_s2-get-mean-variance-and-print&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-6">
<div class="org-src-container">
<pre class="src src-C" id="org0eb8e2f"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">g_idx</span>=0; g_idx&lt;n_groups; g_idx++) {
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">groupname</span> = groups[g_idx];
  dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
  dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
  strcat(dset,groupname);
  strcat(dset,<span style="color: #ad7fa8; font-style: italic;">"/stack"</span>);
  H5LTread_dataset_int(file_id,dset,data);
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=0; j&lt;ncol; j++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">y</span>[nsamp];
      <span style="color: #729fcf; font-weight: bold;">if</span> (gain == 1.0 &amp; read_out_var == 0.0) {
        <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++)
          <span style="color: #2c5115;">// </span><span style="color: #888a85;">No variance stabilization</span>
          y[k] = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+k];
      } <span style="color: #729fcf; font-weight: bold;">else</span> {
        <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++)
          <span style="color: #2c5115;">// </span><span style="color: #888a85;">Do variance stabilization</span>
          y[k] = 2*sqrt(((<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+k])/gain+read_out_var);
      }
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">mean</span> = gsl_stats_mean(y, 1, nsamp);
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">variance</span> = gsl_stats_variance_m(y, 1, nsamp, mean);
      printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g\n"</span>,mean,variance);
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0795db7" class="outline-5">
<h5 id="org0795db7"><span class="section-number-5">6.7.1.7</span> <code>&lt;&lt;adu_mu_s2-close-file-free-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-1-7">
<div class="org-src-container">
<pre class="src src-C" id="org276047d">free(data);
H5Fclose (file_id);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddcc9eb" class="outline-5">
<h5 id="orgddcc9eb"><span class="section-number-5">6.7.1.8</span> Compile and test <code>adu_mu_s2</code></h5>
<div class="outline-text-5" id="text-6-7-1-8">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org98d5ac8">gcc -W -g -o code/adu_mu_s2 code/adu_mu_s2.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We test the memory usage of the program with valgrind:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgbffbb68">valgrind  ./code/adu_mu_s2 &gt; dump
</pre>
</div>

<pre class="example">
==6471== Memcheck, a memory error detector
==6471== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==6471== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==6471== Command: ./code/adu_mu_s2
==6471== 
==6471== 
==6471== HEAP SUMMARY:
==6471==     in use at exit: 0 bytes in 0 blocks
==6471==   total heap usage: 18,263 allocs, 18,263 frees, 114,336,201 bytes allocated
==6471== 
==6471== All heap blocks were freed -- no leaks are possible
==6471== 
==6471== For counts of detected and suppressed errors, rerun with: -v
==6471== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>
</div>
<div id="outline-container-org1cb2b98" class="outline-4">
<h4 id="org1cb2b98"><span class="section-number-4">6.7.2</span> Making the first figure</h4>
<div class="outline-text-4" id="text-6-7-2">
<div class="org-src-container">
<pre class="src src-gnuplot" id="org14368e8"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Mean(ADU)"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Variance(ADU)"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">unset</span> key
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">"&lt; ./code/adu_mu_s2"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> \
     <span style="color: #8ae234; font-weight: bold;">pointtype</span> 0 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/adu_mu_vs_s2.svg" class="org-svg" alt="ADU variance vs mean ADU" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 14: </span><a id="orgeadaa66"></a> ADU variance vs mean ADU.</p>
</div>
</div>
</div>

<div id="outline-container-org2709397" class="outline-4">
<h4 id="org2709397"><span class="section-number-4">6.7.3</span> Doing the weighted linear regression</h4>
<div class="outline-text-4" id="text-6-7-3">
<p>
We write a program reading from the <code>stdin</code> the output of <code>adu_mu_s2</code> and doing a weighted linear regression on these data.
</p>
</div>

<div id="outline-container-org14ed316" class="outline-5">
<h5 id="org14ed316"><span class="section-number-5">6.7.3.1</span> <code>adu_mu_s2_fit</code> skeleton</h5>
<div class="outline-text-5" id="text-6-7-3-1">
<div class="org-src-container">
<pre class="src src-C" id="org82e320f">&lt;&lt;adu_mu_s2_fit-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;adu_mu_s2_fit-usage&gt;&gt;
  &lt;&lt;adu_mu_s2_fit-args&gt;&gt;
  &lt;&lt;adu_mu_s2_fit-read-data&gt;&gt;
  &lt;&lt;adu_mu_s2_fit-fit&gt;&gt;
  &lt;&lt;adu_mu_s2_fit-print-results&gt;&gt;
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7afdc14" class="outline-5">
<h5 id="org7afdc14"><span class="section-number-5">6.7.3.2</span> <code>&lt;&lt;adu_mu_s2_fit-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-2">
<div class="org-src-container">
<pre class="src src-C" id="orgb4b8abb"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_fit.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_cdf.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6d061f" class="outline-5">
<h5 id="orgb6d061f"><span class="section-number-5">6.7.3.3</span> <code>&lt;&lt;adu_mu_s2_fit-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-3">
<div class="org-src-container">
<pre class="src src-C" id="orgae27a01"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s --sample_size=integer\n\n"</span>\
  <span style="color: #ad7fa8; font-style: italic;">"  --sample_size &lt;positive integer&gt;: the number of pixels times the number of exposures\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program reads data from the stdin and performs a weighter linear fit.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" It prints to the stdout the results\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orga60f924" class="outline-5">
<h5 id="orga60f924"><span class="section-number-5">6.7.3.4</span> <code>&lt;&lt;adu_mu_s2_fit-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-4">
<div class="org-src-container">
<pre class="src src-C" id="org28cc2d8"><span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">sample_size</span>;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"sample_size"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'s'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hs:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'s'</span>:
    {
      sample_size = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) atoi(optarg);
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d81b0f" class="outline-5">
<h5 id="org6d81b0f"><span class="section-number-5">6.7.3.5</span> <code>&lt;&lt;adu_mu_s2_fit-read-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-5">
<div class="org-src-container">
<pre class="src src-C" id="org76824f7"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">mean</span>[sample_size];
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">variance</span>[sample_size];
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">w</span>[sample_size];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">data_idx</span>=0;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">mu</span>,<span style="color: #ff6347;">s2</span>;
<span style="color: #729fcf; font-weight: bold;">while</span> (fscanf(stdin, <span style="color: #ad7fa8; font-style: italic;">"%lg %lg"</span>, &amp;mu, &amp;s2) == 2 &amp;        \
       data_idx &lt; sample_size) {
  mean[data_idx] = mu;
  variance[data_idx] = s2;
  w[data_idx] = 0.5*99.0/s2/s2;
  data_idx++;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dc4ec8" class="outline-5">
<h5 id="org8dc4ec8"><span class="section-number-5">6.7.3.6</span> <code>&lt;&lt;adu_mu_s2_fit-fit&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-6">
<div class="org-src-container">
<pre class="src src-C" id="org82bdbf1"><span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">c0</span>, <span style="color: #ff6347;">c1</span>, <span style="color: #ff6347;">cov00</span>, <span style="color: #ff6347;">cov01</span>, <span style="color: #ff6347;">cov11</span>, <span style="color: #ff6347;">chisq</span>;

gsl_fit_wlinear(mean, 1, w, 1, variance, 1, sample_size, 
                &amp;c0, &amp;c1, &amp;cov00, &amp;cov01, &amp;cov11, 
                &amp;chisq);
</pre>
</div>
</div>
</div>

<div id="outline-container-org6af5e60" class="outline-5">
<h5 id="org6af5e60"><span class="section-number-5">6.7.3.7</span> <code>&lt;&lt;adu_mu_s2_fit-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-6-7-3-7">
<div class="org-src-container">
<pre class="src src-C" id="orgfacd98b">printf (<span style="color: #ad7fa8; font-style: italic;">"Best fit: Variance(ADU) = %g + %g Mean(ADU)\n"</span>, c0, c1);
printf (<span style="color: #ad7fa8; font-style: italic;">"Covariance matrix:\n"</span>);
printf (<span style="color: #ad7fa8; font-style: italic;">"[ %g, %g\n  %g, %g]\n"</span>, 
        cov00, cov01, cov01, cov11);
printf (<span style="color: #ad7fa8; font-style: italic;">"Residual sum of squares = %g\n"</span>, chisq);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gain_se</span> = sqrt(cov11)*gsl_cdf_tdist_Pinv(0.975,(<span style="color: #8ae234; font-weight: bold;">double</span>)sample_size-3.0);
printf (<span style="color: #ad7fa8; font-style: italic;">"The estimated gain is: %g\n"</span>,c1);
printf (<span style="color: #ad7fa8; font-style: italic;">"A 0.95 confidence interval for the gain is:\n (%g,%g)\n"</span>,
        c1-gain_se,c1+gain_se);
s2 = c0/gsl_pow_2(c1);
printf (<span style="color: #ad7fa8; font-style: italic;">"The estimated read-out variance is: %g\n"</span>,s2);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">s2_se</span> = sqrt(cov00/gsl_pow_2(c1)+cov11*gsl_pow_2(2*c0/gsl_pow_3(c1)));
s2_se *= gsl_cdf_tdist_Pinv(0.975,(<span style="color: #8ae234; font-weight: bold;">double</span>)sample_size-3.0);
printf (<span style="color: #ad7fa8; font-style: italic;">"A 0.95 confidence interval for the read-out variance is:\n (%g,%g)\n"</span>,
        s2-s2_se,s2+s2_se);
</pre>
</div>
</div>
</div>

<div id="outline-container-org452bf4e" class="outline-5">
<h5 id="org452bf4e"><span class="section-number-5">6.7.3.8</span> Compile, run and test <code>adu_mu_s2_fit</code></h5>
<div class="outline-text-5" id="text-6-7-3-8">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgedb8324">gcc -W -g -o code/adu_mu_s2_fit code/adu_mu_s2_fit.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We run it with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org2b2f6e7">./code/adu_mu_s2 | ./code/adu_mu_s2_fit --sample_size=48000
</pre>
</div>

<pre class="example">
Best fit: Variance(ADU) = 5.61141 + 0.139838 Mean(ADU)
Covariance matrix:
[ 0.02125, -1.57125e-05
  -1.57125e-05, 2.05361e-08]
Residual sum of squares = 49764.5
The estimated gain is: 0.139838
A 0.95 confidence interval for the gain is:
 (0.139557,0.140119)
The estimated read-out variance is: 286.959
A 0.95 confidence interval for the read-out variance is:
 (284.613,289.305)
</pre>

<p>
We use valgrind with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgab863ac">./code/adu_mu_s2 &gt; dump 
valgrind ./code/adu_mu_s2_fit --sample_size=48000 &lt; dump &gt; toto
</pre>
</div>

<pre class="example">
==7471== Memcheck, a memory error detector
==7471== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==7471== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==7471== Command: ./code/adu_mu_s2_fit --sample_size=48000
==7471== 
==7471== 
==7471== HEAP SUMMARY:
==7471==     in use at exit: 0 bytes in 0 blocks
==7471==   total heap usage: 2 allocs, 2 frees, 8,192 bytes allocated
==7471== 
==7471== All heap blocks were freed -- no leaks are possible
==7471== 
==7471== For counts of detected and suppressed errors, rerun with: -v
==7471== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1320d80" class="outline-4">
<h4 id="org1320d80"><span class="section-number-4">6.7.4</span> Doing the fit figures</h4>
<div class="outline-text-4" id="text-6-7-4">
<div class="org-src-container">
<pre class="src src-gnuplot" id="org12e7bcc"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Mean(ADU)"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Variance(ADU)"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">unset</span> key
<span style="color: #ff6347;">g =</span> 0.14
<span style="color: #ff6347;">s2 =</span> 290
<span style="color: #ff6347;">pred(x) =</span> s2*g**2 + g*x
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">"&lt; ./code/adu_mu_s2"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> \
     <span style="color: #8ae234; font-weight: bold;">pointtype</span> 0 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>,\
     pred(x) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"red"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/adu_mu_vs_s2_fit.svg" class="org-svg" alt="ADU variance vs mean ADU" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 15: </span><a id="org065447b"></a> ADU variance vs mean ADU (black dots) and linear fit (red)</p>
</div>


<div class="org-src-container">
<pre class="src src-gnuplot" id="org23de53c"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Fitted Value"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Normalized residuals"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">unset</span> key
<span style="color: #ff6347;">g =</span> 0.14
<span style="color: #ff6347;">s2 =</span> 290
<span style="color: #ff6347;">pred(x) =</span> s2*g**2 + g*x
<span style="color: #ff6347;">zero(x) =</span> 0
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">"&lt; ./code/adu_mu_s2"</span> <span style="color: #8ae234; font-weight: bold;">using</span> (pred($1)):((pred($1)-$2)*<span style="color: #edd400; font-weight: bold;">sqrt</span>(99.0*0.5)/$2) \
     <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> <span style="color: #8ae234; font-weight: bold;">pointtype</span> 0 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>,\
     zero(x) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"red"</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/adu_resid_vs_fit.svg" class="org-svg" alt="Residual vs fitted value" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 16: </span><a id="org005b2f1"></a> Normalized residuals vs fitted value</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org583750e" class="outline-3">
<h3 id="org583750e"><span class="section-number-3">6.8</span> Variance stabilization</h3>
<div class="outline-text-3" id="text-6-8">
</div><div id="outline-container-org724667a" class="outline-4">
<h4 id="org724667a"><span class="section-number-4">6.8.1</span> Doing the figure</h4>
<div class="outline-text-4" id="text-6-8-1">
<div class="org-src-container">
<pre class="src src-gnuplot" id="org72d6d5f"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Mean of var. stab. ADU"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"Variance of var. stab. ADU"</span>
<span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">unset</span> key
<span style="color: #ff6347;">one(x) =</span> 1
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">"&lt; ./code/adu_mu_s2 --gain=0.14 --variance=290"</span> <span style="color: #8ae234; font-weight: bold;">using</span> 1:2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">points</span> \
     <span style="color: #8ae234; font-weight: bold;">pointtype</span> 0 <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"black"</span>,\
     one(x) <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span> <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">"red"</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/stab_adu_mu_vs_s2.svg" class="org-svg" alt="ADU variance vs mean ADU after stabilization" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 17: </span><a id="org9616287"></a>  variance of variance-stabilized-ADU vs mean of variance-stabilized-ADU.</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orga686c54" class="outline-2">
<h2 id="orga686c54"><span class="section-number-2">7</span> Automatic ROI detection</h2>
<div class="outline-text-2" id="text-7">
<p>
Now that we know how to stabilize the variance we can write a program that detects automatically the "Region Of Interest" (ROI), based on the simple idea that a ROI is a set of pixels whose fluorescence intensity is not constant in time ("something happens there").
</p>
</div>

<div id="outline-container-orgb98ee44" class="outline-3">
<h3 id="orgb98ee44"><span class="section-number-3">7.1</span> Program <code>roi</code></h3>
<div class="outline-text-3" id="text-7-1">
</div><div id="outline-container-orgb50b727" class="outline-5">
<h5 id="orgb50b727"><span class="section-number-5">7.1.0.1</span> <code>roi</code> skeleton</h5>
<div class="outline-text-5" id="text-7-1-0-1">
<div class="org-src-container">
<pre class="src src-C" id="orgb286fe6">&lt;&lt;roi-include&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;roi-usage&gt;&gt;
  &lt;&lt;roi-args&gt;&gt;
  &lt;&lt;roi-open-file-and-read-dset&gt;&gt;
  &lt;&lt;roi-stabilize-variance-and-get-pRSS&gt;&gt;
  &lt;&lt;roi-stabilize-print-results&gt;&gt;
  &lt;&lt;roi-close-file-free-memory&gt;&gt;  
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc788b07" class="outline-5">
<h5 id="orgc788b07"><span class="section-number-5">7.1.0.2</span> <code>&lt;&lt;roi-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-2">
<div class="org-src-container">
<pre class="src src-C" id="org35cc1d3"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_matrix.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_cdf.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_statistics_double.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf169887" class="outline-5">
<h5 id="orgf169887"><span class="section-number-5">7.1.0.3</span> <code>&lt;&lt;roi-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-3">
<div class="org-src-container">
<pre class="src src-C" id="orgb1790b3"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s -f --file=string -d --dset=string -g --CCD_gain=real ...\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"          ... -v --CCD_variance=real [-t --threshold=real] [-m --return_matrix]\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -f --file &lt;character string&gt;: data file name (e.g. Data_POMC.hdf5)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -d --dset &lt;character string&gt;: data set name (e.g. 'stack') shoud be a 3D object\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -g --CCD_gain &lt;positive real&gt;: CCD gain (e.g. 0.14)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -v --CCV_variance &lt;positive real&gt;: CCD read-out variance (e.g. 290)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -m --return_matrix if set a matrix whose values at pixel i,j are log(1-F(rss_i,j))\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"     where F is the CDF of a chi square distribution with nsamp-1 degrees of freedome\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"     nsamp being the number of measurements (exposures) made on each pixel. If unset\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"     (default) the list of pixel in the ROI is returned as (i1,j1),(i2,j2),... \n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -t --threshold &lt;negative real&gt;: real number (e.g. -300 default), the level\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"     under which the  log(1-F(rss_i,j)) is considered significant\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file' and gets dataset 'dset' (that should be a 3D array) containing\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" ADUs. For each pixel i,j at each time index k it stabilizes the variance:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   adu_i,j,k -&gt; z_i,j,k = 2*sqrt(adu_i,j,k/CCD_gain+CCD_variance)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" the variance of the z_i,j,k should then be UNIFORMLY 1. It then computes the mean value\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" along time for each pixel:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   z_i,j_m = (z_i,j,1 + ... + z_i,j,K)/K\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" and the residual sum of squares statistic:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   rss_i,j = ((z_i,j,1-z_i,j_m)^2+...+(z_i,j,K-z_i,j_m)^2))\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" under the null hypothesis (no signal in the pixel) this statistic should have a chi-square\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" distribution with K-1 degrees of freedom. A matrix whose element i,j is:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   log(1-F(rss_i,j))\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" where F is the CDF of a chi-square distribution with K-1 degrees of freedom is constructed.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" If parameter '--return_matrix' is set (not the default) this matrix is printed to the stdout,\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" otherwise the value of the F(rss_i,j) is compared to the Bonferroni corrected threshold set\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" by '--threshold' (default 0.99) and if the value is larger, 'i j' is printed to the stdout.\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" This is done for each pixel and the printed pairs are separated by '\n'.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge80b59f" class="outline-5">
<h5 id="orge80b59f"><span class="section-number-5">7.1.0.4</span> <code>&lt;&lt;roi-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-4">
<div class="org-src-container">
<pre class="src src-C" id="org97dd238"><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">filename</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">dset</span>[25];
dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">threshold</span> = -300.;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gain</span>,<span style="color: #ff6347;">variance</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">print_matrix</span>=0;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"file"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"dset"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'d'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"CCD_gain"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'g'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"CCD_variance"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'v'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"threshold"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'t'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"return_matrix"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'m'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">dset_name</span>;
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hmf:d:g:v:t:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      filename = optarg;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'d'</span>:
    {
      dset_name = optarg;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'g'</span>:
    {
      gain = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (gain &lt;= 0.0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"CCD gain must be &gt; 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'v'</span>:
    {
      variance = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (variance &lt; 0.0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"CCD variance must be &gt;= 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'t'</span>:
    {
      threshold = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (0.0 &lt;= threshold) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"threshold should be\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'m'</span>:
    {
      print_matrix=1;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  strcat(dset,dset_name);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c2f153" class="outline-5">
<h5 id="org6c2f153"><span class="section-number-5">7.1.0.5</span> <code>&lt;&lt;roi-open-file-and-read-dset&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-5">
<div class="org-src-container">
<pre class="src src-C" id="org2dd78d3"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Open FILE</span>
<span style="color: #8ae234; font-weight: bold;">hid_t</span> <span style="color: #ff6347;">file_id</span> = H5Fopen (filename, H5F_ACC_RDONLY, H5P_DEFAULT);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Get dimensions of 3D object contained in DSET</span>
<span style="color: #8ae234; font-weight: bold;">hsize_t</span> <span style="color: #ff6347;">dims</span>[3];
H5LTget_dataset_info(file_id,dset,dims,<span style="color: #8ae234;">NULL</span>,<span style="color: #8ae234;">NULL</span>);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nrow</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[0];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">ncol</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[1];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nsamp</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[2];
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Read dset in data</span>
<span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">data</span> = malloc(nrow*ncol*nsamp*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
H5LTread_dataset_int(file_id,dset,data);
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">pRSS</span> = gsl_matrix_alloc(nrow,ncol);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6ffd0c" class="outline-5">
<h5 id="orgc6ffd0c"><span class="section-number-5">7.1.0.6</span> <code>&lt;&lt;roi-close-file-free-memory&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-6">
<div class="org-src-container">
<pre class="src src-C" id="org9856992">free(data);
gsl_matrix_free(pRSS);
H5Fclose (file_id);
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d19645" class="outline-5">
<h5 id="org4d19645"><span class="section-number-5">7.1.0.7</span> <code>&lt;&lt;roi-stabilize-variance-and-get-pRSS&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-7">
<div class="org-src-container">
<pre class="src src-C" id="org25f7ac3"><span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=0; j&lt;ncol; j++) {
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">z</span>[nsamp];
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span> = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+k];
      z[k] = 2.0*sqrt(adu/gain+variance);
    }
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">rss</span> = gsl_stats_variance(z,1,nsamp)*((<span style="color: #8ae234; font-weight: bold;">double</span>)nsamp-1.0); 
    gsl_matrix_set(pRSS,i,j,log(gsl_cdf_chisq_Q(rss, (<span style="color: #8ae234; font-weight: bold;">double</span>)nsamp-1.0)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb4e759" class="outline-5">
<h5 id="orgfb4e759"><span class="section-number-5">7.1.0.8</span> <code>&lt;&lt;roi-stabilize-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-7-1-0-8">
<div class="org-src-container">
<pre class="src src-C" id="org8874827"><span style="color: #729fcf; font-weight: bold;">if</span> (print_matrix) {
  printf(<span style="color: #ad7fa8; font-style: italic;">"# Matrix with %d rows and %d columns\n"</span>,
         (<span style="color: #8ae234; font-weight: bold;">int</span>) nrow, (<span style="color: #8ae234; font-weight: bold;">int</span>) ncol);
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g"</span>,gsl_matrix_get(pRSS,i,0));
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=1; j&lt;ncol; j++)
      printf(<span style="color: #ad7fa8; font-style: italic;">", %g"</span>,gsl_matrix_get(pRSS,i,j));
    printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
  }
} <span style="color: #729fcf; font-weight: bold;">else</span> {
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_pixel</span>=0;
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span>=0; i&lt;nrow; i++) {
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span>=1; j&lt;ncol; j++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">stat</span> = gsl_matrix_get(pRSS,i,j);
      <span style="color: #729fcf; font-weight: bold;">if</span> (stat &lt;= threshold) {
        <span style="color: #2c5115;">// </span><span style="color: #888a85;">Pixel part of ROI</span>
        <span style="color: #729fcf; font-weight: bold;">if</span> (n_pixel==0)
          printf(<span style="color: #ad7fa8; font-style: italic;">"%d %d"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) i, (<span style="color: #8ae234; font-weight: bold;">int</span>) j);
        <span style="color: #729fcf; font-weight: bold;">else</span>
          printf(<span style="color: #ad7fa8; font-style: italic;">"\n%d %d"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) i, (<span style="color: #8ae234; font-weight: bold;">int</span>) j);
        n_pixel++;
      }
    }
  }
  <span style="color: #729fcf; font-weight: bold;">if</span> (n_pixel &gt; 0)
    printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
  fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"%d pixels in the ROI\n"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) n_pixel);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org91a737b" class="outline-5">
<h5 id="org91a737b"><span class="section-number-5">7.1.0.9</span> Compile, run and test <code>roi</code></h5>
<div class="outline-text-5" id="text-7-1-0-9">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orga632499">gcc -W -g -o code/roi code/roi.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We run it storing the output matrix in <code>rss_stat</code> with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org8909506">./code/roi --file=Data_POMC.hdf5 --dset=stack --CCD_gain=0.14 <span style="color: #ad7fa8; font-style: italic;">\</span>
           --CCD_variance=290 -m &gt; rss_stat
</pre>
</div>

<p>
We can also use valgrind (and the short version of the arguments):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org91c67ae">valgrind ./code/roi -f Data_POMC.hdf5 -d stack -g 0.14 <span style="color: #ad7fa8; font-style: italic;">\</span>
           -v 290 -m &gt; dump
</pre>
</div>

<pre class="example">
==7239== Memcheck, a memory error detector
==7239== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==7239== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==7239== Command: ./code/roi -f Data_POMC.hdf5 -d stack -g 0.14 -v 290 -m
==7239== 
==7239== 
==7239== HEAP SUMMARY:
==7239==     in use at exit: 0 bytes in 0 blocks
==7239==   total heap usage: 6,579 allocs, 6,579 frees, 20,302,218 bytes allocated
==7239== 
==7239== All heap blocks were freed -- no leaks are possible
==7239== 
==7239== For counts of detected and suppressed errors, rerun with: -v
==7239== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>


<p>
If instead of the matrix we want the indexes of the pixels making the ROI we use:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org4d6bd75">./code/roi -f Data_POMC.hdf5 -d stack -g 0.14 -v 290 &gt; roi_pxl
cat roi_pxl
</pre>
</div>

<pre class="example">
12 pixels in the ROI
26 36
26 37
26 38
26 39
27 36
27 37
27 38
27 39
28 36
28 37
28 38
28 39
</pre>
</div>
</div>
</div>


<div id="outline-container-org31a8dd7" class="outline-3">
<h3 id="org31a8dd7"><span class="section-number-3">7.2</span> Making the figure</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-gnuplot" id="org07f2b9e"><span style="color: #8ae234;">set</span> palette grey
<span style="color: #8ae234;">set</span> multiplot layout 1,2
<span style="color: #8ae234;">set</span> xrange [<span style="color: #8ae234;">0:79</span>]
<span style="color: #8ae234;">set</span> yrange [<span style="color: #8ae234;">0:59</span>]
<span style="color: #8ae234;">set</span> <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"Full field"</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">'rss_stat'</span> <span style="color: #8ae234; font-weight: bold;">matrix</span> <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">image</span>
<span style="color: #8ae234;">set</span> xrange [<span style="color: #8ae234;">33:43</span>]
<span style="color: #8ae234;">set</span> yrange [<span style="color: #8ae234;">23:33</span>]
<span style="color: #8ae234;">set</span> <span style="color: #8ae234; font-weight: bold;">title</span> <span style="color: #ad7fa8; font-style: italic;">"Cell body"</span>
<span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">'rss_stat'</span> <span style="color: #8ae234; font-weight: bold;">matrix</span> <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">image</span>
<span style="color: #8ae234;">unset</span> multiplot
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/roi_fig.svg" class="org-svg" alt="roi detection" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 18: </span><a id="org16b9361"></a> \(\log\left(1-\mathrm{F}_{\chi^2_{167}}(\mathrm{rss}_{i,j})\right)\) for the POMC data.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgde7e1cb" class="outline-2">
<h2 id="orgde7e1cb"><span class="section-number-2">8</span> Signal estimation</h2>
<div class="outline-text-2" id="text-8">
<p>
We reached the last task! Having identfied automatically the pixels of the ROI, we now estimate our model.
</p>
</div>

<div id="outline-container-orga90aac3" class="outline-3">
<h3 id="orga90aac3"><span class="section-number-3">8.1</span> The model: a piecewise constant function</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>We have been (very) conservative and have kept as our ROI the pixels having an \(\log\left(1 - F_{\chi_{K-1}^2}(RSS)\right) \le -300\).</li>
<li>We are left with 12 pixels.</li>
<li>We are going to model the fluorescence intensity of each of these pixels by: \[S_{i,j}(t) = \phi_{i,j} \, f(t) + b \; ,\] where \(f(t)\) is a signal time course to all pixels of the ROI, \(\phi_{i,j}\) is a pixel specific parameter and \(b\) is a background fluorescence assumed identical for each pixel.</li>
<li>The time \(t\) is in fact a discrete variable, \(t = \delta \, k\) (\(\delta\) = 150 ms) and we are seeking a pointwise estimation: \(\{f_1,f_2,\ldots,f_K\}\) (\(K\) = 168) where \(f_k = f(\delta \, k)\).</li>
<li>We end up with 12 (\(\phi_{i,j}\)) + 168 (\(f_k\)) + 1 (\(b\)) = 181 parameters for 12 x 168 = 2016 measurements.</li>
<li>We need to add a constraint since with our model specification: \[S_{i,j,k} = \phi_{i,j} \, f_k + b \; ,\] we can multiply all the \(\phi_{i,j}\) by 2 and divide all the \(f_k\) by 2 and get the same prediction.</li>
<li>We are going to set \(f_k=1\) for the first 5 time points (the stimulation comes at the 11th) and our pointwise estimation relates to what is usually done with this type of data, \(\Delta S(t) / S_0\) (where \(S_0\) is a baseline average) through: \[\Delta S(t) / S_0 = \frac{S(t) - S_0}{S_0} = f(t) - 1 + \mathrm{noise}\, .\]</li>
<li><b>Notice that no independent background measurement is used</b>.</li>
<li>With variance stabilization we end up minimizing: \[RSS\left(b,(\phi_{i,j}),(f_k)_{k=6,\ldots,168}\right) = \sum_{(i,j) \in \mathrm{ROI}} \sum_{k=1}^{168} \left(Z_{ijk}-F_{ijk}\right)^2 \, ,\] where \[Z_{ijk} = 2*\sqrt{ADU_{ijk}/\hat{G}+\hat{\sigma}_R^2}\] and \[F_{ijk} = 2*\sqrt{\phi_{i,j} \, f_k + b + \hat{\sigma}_R^2}\, .\]</li>
<li>If our model is correct we should have: \[RSS\left(\hat{b},(\hat{\phi}_{i,j}),(\hat{f}_k)_{k=6,\ldots,168}\right) \sim \chi^2_{12 \times 168 - 176}\, .\]</li>
<li>The method also generates confidence intervals for the estimated parameters.</li>
</ul>
</div>
</div>

<div id="outline-container-org44d395c" class="outline-3">
<h3 id="org44d395c"><span class="section-number-3">8.2</span> Parameters and data organization</h3>
<div class="outline-text-3" id="text-8-2">
<p>
We will be using the <code>gsl</code> <a href="https://www.gnu.org/software/gsl/manual/html_node/Nonlinear-Least_002dSquares-Fitting.html#Nonlinear-Least_002dSquares-Fitting">nonlinear least-squares functions</a>, we will have to define a residual returning function that takes as its first argument a <i>(gsl-)vector</i> of parameters. This was not an issue in Sec. <a href="#why-does-a-proper-noise-model-matter">Why does a proper noise model matter?</a> since only a single parameter model was considered. Now we will be dealing with a 175 parameters model. We must therefore decide how these parameters are laid out in the parameter vector. We must also decide how the data are organized.
</p>
</div>

<div id="outline-container-org51fd670" class="outline-4">
<h4 id="org51fd670"><span class="section-number-4">8.2.1</span> Data layout</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
We have P=12 pixels in our ROI and to each of those an ADU sequence with K=168 elements is associated. So we can represent these data as PxK (gsl-)matrix. 
</p>
</div>
</div>

<div id="outline-container-orgf78fcbb" class="outline-4">
<h4 id="orgf78fcbb"><span class="section-number-4">8.2.2</span> Going from the parameters to the model prediction</h4>
<div class="outline-text-4" id="text-8-2-2">
<p>
Our \((f_k)_{k=6,\ldots,168}\) sub-vector (a sub-vector of the parameter vector) can be seen as the long end of K=168 (gsl-)vector whose first five elements are one. The prediction can then be obtained by multiplying the column vector (Px1) of the \(\phi_{i,j}\) by the row vector (1x168) we just discussed before adding \(b\) to each element of the resulting matrix. 
</p>
</div>
</div>

<div id="outline-container-org38fc85d" class="outline-4">
<h4 id="org38fc85d"><span class="section-number-4">8.2.3</span> Getting initial guesses</h4>
<div class="outline-text-4" id="text-8-2-3">
<p>
We get the initial guess for \((f_k)_{k=6,\ldots,168}\) by taking the mean across all the pixels of the ROI for each value of the time index k and we divide these mean values by the mean of the first five elements. We set arbitrarily b to 100 and we get initial guesses for the \(\phi_{i,j}\) from the mean value of the first five observations of each pixel to which we subtract b. 
</p>
</div>
</div>
</div>

<div id="outline-container-org9e20852" class="outline-3">
<h3 id="org9e20852"><span class="section-number-3">8.3</span> The program</h3>
<div class="outline-text-3" id="text-8-3">
<p>
We now write program <code>fit_pwc_to_roi</code> where "pwc" is short for "piecewise constant".
</p>
</div>

<div id="outline-container-org30625ca" class="outline-4">
<h4 id="org30625ca"><span class="section-number-4">8.3.1</span> Code definition</h4>
<div class="outline-text-4" id="text-8-3-1">
</div><div id="outline-container-org98182f0" class="outline-5">
<h5 id="org98182f0"><span class="section-number-5">8.3.1.1</span> <code>fit_pwc_to_roi</code> skeleton</h5>
<div class="outline-text-5" id="text-8-3-1-1">
<div class="org-src-container">
<pre class="src src-C" id="org0739e5f">&lt;&lt;fit_pwc_to_roi-include&gt;&gt;
&lt;&lt;fit_pwc_to_roi-macro&gt;&gt;
&lt;&lt;fit_pwc_to_roi-data-structure&gt;&gt;
&lt;&lt;fit_pwc_to_roi-residual-fct&gt;&gt;
&lt;&lt;fit_pwc_to_roi-callback-fct&gt;&gt;
<span style="color: #8ae234; font-weight: bold;">int</span> main(<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">argv</span>[])
{
  &lt;&lt;fit_pwc_to_roi-usage&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-args&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-print-info&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-read-data&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-initial-guess&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-initialize-data-structure&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-initialize-gsl_multifit_nlinear_fdf&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-allocate-and-initialize-solver&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-inital-rss&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-<span style="color: #729fcf; font-weight: bold;">do</span>-nls&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-print-info-final&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-print-results&gt;&gt;
  &lt;&lt;fit_pwc_to_roi-free-memory&gt;&gt;  
  <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb0f3b2" class="outline-5">
<h5 id="orgcb0f3b2"><span class="section-number-5">8.3.1.2</span> <code>&lt;&lt;fit_pwc_to_roi-include&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-2">
<div class="org-src-container">
<pre class="src src-C" id="org20abcb5"><span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdio.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;stdlib.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;string.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;getopt.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;hdf5_hl.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_math.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_matrix.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_vector.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_blas.h&gt;</span>
<span style="color: #3B5998;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gsl/gsl_multifit_nlinear.h&gt;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org0743ba9" class="outline-5">
<h5 id="org0743ba9"><span class="section-number-5">8.3.1.3</span> <code>&lt;&lt;fit_pwc_to_roi-macro&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-3">
<p>
The baseline defined next is the duration (in sample points) during which the signal is assumed constant.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org76f21c8"><span style="color: #3B5998;">#define</span> <span style="color: #ff6347;">baseline</span> 5
</pre>
</div>
</div>
</div>

<div id="outline-container-orga905e59" class="outline-5">
<h5 id="orga905e59"><span class="section-number-5">8.3.1.4</span> <code>&lt;&lt;fit_pwc_to_roi-data-structure&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-4">
<p>
To compute the residuals (difference between observations and predictions) we need the data from the ROI. Member <code>stab_pxl</code> of the following structure will contain a pointer to the (variance stabilized) data organized as a matrix with as many rows as pixels in the ROI and as many columns as sample points (as discussed above). Member <code>variance</code> of the structure will contain the CCD variance.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org49b8411"><span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> {
  <span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> * <span style="color: #ff6347;">stab_pxl</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">matrix of stabilized observations from ROI</span>
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">variance</span>; <span style="color: #2c5115;">// </span><span style="color: #888a85;">the CCD variance</span>
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org8001cb8" class="outline-5">
<h5 id="org8001cb8"><span class="section-number-5">8.3.1.5</span> <code>&lt;&lt;fit_pwc_to_roi-usage&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-5">
<div class="org-src-container">
<pre class="src src-C" id="org994cdd9"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">usage</span>[] = \
  <span style="color: #ad7fa8; font-style: italic;">"usage: %s -f --file=string -d --dset=string -g --CCD_gain=real ...\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"          ... -v --CCD_variance=real -p --pixels=string \n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -f --file &lt;character string&gt;: data file name (e.g. Data_POMC.hdf5)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -d --dset &lt;character string&gt;: data set name (e.g. 'stack') shoud be a 3D object\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -g --CCD_gain &lt;positive real&gt;: CCD gain (e.g. 0.14)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -v --CCV_variance &lt;positive real&gt;: CCD read-out variance (e.g. 290)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"  -p --pixels &lt;character string&gt;: name of a file containing the row and column\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"       indexes of the pixels belonging to the ROI on two columns\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program opens 'file' and gets dataset 'dset' (that should be a 3D array) containing\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" ADUs. For each pixel i,j in the list specified by pixels at each time index k it\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" stabilizes the variance:\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">"   adu_i,j,k -&gt; z_i,j,k = 2*sqrt(adu_i,j,k/CCD_gain+CCD_variance)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" the variance of the z_i,j,k should then be UNIFORMLY 1. It then fits by nonlinear\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" least-squares a model where the piecewise constant time course of the 'signal'\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" of each pixel of the ROI is assumed to be the same. This 'signal' is then\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" multiplied by a pixel specific factor (giving a predicted calcium induced)\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" fluorescence and a common autofluorescence is added to each pixel.\n\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" The program prints to the stderr fit diagnostics. It also prints to the stdout\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" the 'signal' values together with the lower and upper limits of a 95% pointwise\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" confidence intervals. Two blanck lines\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" follow and, one as many columns as there are pixels in the ROI, the model\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" predictions for each pixels are printed (a header gives the row and column\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" index of each pixel). After two more blank lines the stabilized observations\n"</span>
  <span style="color: #ad7fa8; font-style: italic;">" are printed in the same format.\n\n"</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org088df75" class="outline-5">
<h5 id="org088df75"><span class="section-number-5">8.3.1.6</span> <code>&lt;&lt;fit_pwc_to_roi-args&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-6">
<p>
This code block reads the program parameters. It assigns (after allocating memory if necessary):
</p>
<dl class="org-dl">
<dt>filename</dt><dd>pointer to a character string with the name of the data file.</dd>
<dt>dset</dt><dd>pointer to a character string with the name of the data set.</dd>
<dt>gain, variance</dt><dd>values of the CCD gain and read-out variance.</dd>
<dt>pxl_row, pxl_row</dt><dd>1D arrays containing the row and column indexes of the pixels making the ROI.</dd>
<dt>nb_pxl</dt><dd>the number of pixels in the ROI.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-C" id="org14a1621"><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">filename</span>;
<span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">dset</span>[25];
dset[0] = <span style="color: #ad7fa8; font-style: italic;">'/'</span>;
dset[1] = <span style="color: #ad7fa8; font-style: italic;">'\0'</span>;
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gain</span>,<span style="color: #ff6347;">variance</span>;
<span style="color: #8ae234; font-weight: bold;">size_t</span> *<span style="color: #ff6347;">pxl_row</span>,*<span style="color: #ff6347;">pxl_col</span>;
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nb_pxl</span>=0;
{<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">opt</span>;
  <span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">option</span> <span style="color: #ff6347;">long_options</span>[] = {
    {<span style="color: #ad7fa8; font-style: italic;">"file"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'f'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"dset"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'d'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"CCD_gain"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'g'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"CCD_variance"</span>,required_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'v'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"pixels"</span>,optional_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'p'</span>},
    {<span style="color: #ad7fa8; font-style: italic;">"help"</span>,no_argument,<span style="color: #8ae234;">NULL</span>,<span style="color: #ad7fa8; font-style: italic;">'h'</span>},
    {<span style="color: #8ae234;">NULL</span>,0,<span style="color: #8ae234;">NULL</span>,0}
  };
  <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">dset_name</span>;
  <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">long_index</span> =0;
  <span style="color: #729fcf; font-weight: bold;">while</span> ((opt = getopt_long(argc,argv,
                            <span style="color: #ad7fa8; font-style: italic;">"hf:d:g:v:p:"</span>,
                            long_options,       
                            &amp;long_index)) != -1) {
    <span style="color: #729fcf; font-weight: bold;">switch</span>(opt) {
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'f'</span>:
    {
      filename = optarg;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'d'</span>:
    {
      dset_name = optarg;
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'g'</span>:
    {
      gain = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (gain &lt;= 0.0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"CCD gain must be &gt; 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'v'</span>:
    {
      variance = (<span style="color: #8ae234; font-weight: bold;">double</span>) atof(optarg);
      <span style="color: #729fcf; font-weight: bold;">if</span> (variance &lt; 0.0) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"CCD variance must be &gt;= 0\n"</span>);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'p'</span>:
    {
      <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ff6347;">fname</span> = optarg;
      <span style="color: #8ae234; font-weight: bold;">char</span> <span style="color: #ff6347;">line</span>[BUFSIZ];
      <span style="color: #8ae234; font-weight: bold;">FILE</span> *<span style="color: #ff6347;">fp</span>;
      <span style="color: #729fcf; font-weight: bold;">if</span> (<span style="color: #8ae234;">NULL</span> == (fp = fopen(fname,<span style="color: #ad7fa8; font-style: italic;">"r"</span>))) {
        fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Could not open file %s\n"</span>,fname);
        <span style="color: #729fcf; font-weight: bold;">return</span> -1;
      }
      <span style="color: #729fcf; font-weight: bold;">while</span> (fgets(line,BUFSIZ,fp))
        nb_pxl++;
      rewind(fp);
      pxl_row = malloc(<span style="color: #8ae234; font-weight: bold;">nb_pxl</span>*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(size_t));
      pxl_col = malloc(<span style="color: #8ae234; font-weight: bold;">nb_pxl</span>*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(size_t));
      <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">row_idx</span>,<span style="color: #ff6347;">col_idx</span>;
      <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0;
      <span style="color: #729fcf; font-weight: bold;">while</span> (fscanf(fp,<span style="color: #ad7fa8; font-style: italic;">"%d %d"</span>,&amp;row_idx,&amp;col_idx)==2) {
        pxl_row[pxl_idx] = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) row_idx;
        pxl_col[pxl_idx] = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) col_idx;
        pxl_idx++;
      }
      fclose(fp);
    }
    <span style="color: #729fcf; font-weight: bold;">break</span>;
    <span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'h'</span>: printf(usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    <span style="color: #729fcf; font-weight: bold;">default</span> : fprintf(stderr,usage,argv[0]);
      <span style="color: #729fcf; font-weight: bold;">return</span> -1;
    }
  }
  strcat(dset,dset_name);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga42b6ba" class="outline-5">
<h5 id="orga42b6ba"><span class="section-number-5">8.3.1.7</span> <code>&lt;&lt;fit_pwc_to_roi-free-memory&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-7">
<p>
As usual this code block frees the allocated memory.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org91cd5b2">free(pxl_row);
free(pxl_col);
gsl_matrix_free(pxl_data);
gsl_vector_free(f);
gsl_vector_free(phi);
gsl_vector_free(par);
gsl_multifit_nlinear_free (w);
gsl_matrix_free(covar);
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b39a07" class="outline-5">
<h5 id="org6b39a07"><span class="section-number-5">8.3.1.8</span> <code>&lt;&lt;fit_pwc_to_roi-print-info&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-8">
<p>
This code block prints to the <code>stderr</code> some general information concerning the fit that will be performed next.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org0023187">fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"Fitting now piecewise constant signal within ROI for\n"</span>
        <span style="color: #ad7fa8; font-style: italic;">"dataset %s from file %s\n"</span>,dset,filename);
fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"The row and column indexes of the pixels making the\n"</span>
        <span style="color: #ad7fa8; font-style: italic;">"ROI are:\n"</span>);
fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"  (%d,%d)"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_row[0],
          (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_col[0]);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=1; pxl_idx&lt;nb_pxl; pxl_idx++)
  <span style="color: #729fcf; font-weight: bold;">if</span> (pxl_row[pxl_idx] &gt; pxl_row[pxl_idx-1])
    fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"\n  (%d,%d)"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_row[pxl_idx],
            (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_col[pxl_idx]);
  <span style="color: #729fcf; font-weight: bold;">else</span>
    fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">" (%d,%d)"</span>, (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_row[pxl_idx],
            (<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_col[pxl_idx]);
fprintf(stderr,<span style="color: #ad7fa8; font-style: italic;">"\nThe CCD gain and read-out variance are:\n"</span>
        <span style="color: #ad7fa8; font-style: italic;">"  %g and %g\n\n"</span>,gain,variance);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f9f979" class="outline-5">
<h5 id="org0f9f979"><span class="section-number-5">8.3.1.9</span> <code>&lt;&lt;fit_pwc_to_roi-read-data&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-9">
<p>
This code block reads the data from the HDF5 file, allocates <code>pxl_data</code>, a <code>gsl_matrix</code>, and assigns ADU counts of the pixels making the ROI to it.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgf03cb67"><span style="color: #2c5115;">// </span><span style="color: #888a85;">Open FILE</span>
<span style="color: #8ae234; font-weight: bold;">hid_t</span> <span style="color: #ff6347;">file_id</span> = H5Fopen (filename, H5F_ACC_RDONLY, H5P_DEFAULT);
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Get dimensions of 3D object contained in DSET</span>
<span style="color: #8ae234; font-weight: bold;">hsize_t</span> <span style="color: #ff6347;">dims</span>[3];
H5LTget_dataset_info(file_id,dset,dims,<span style="color: #8ae234;">NULL</span>,<span style="color: #8ae234;">NULL</span>);
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nrow</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[0];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">ncol</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[1];
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">nsamp</span> = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) dims[2];
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Read dset in data</span>
<span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347;">data</span> = malloc(nrow*ncol*nsamp*<span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #8ae234; font-weight: bold;">int</span>));
H5LTread_dataset_int(file_id,dset,data);
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">pxl_data</span> = gsl_matrix_alloc(nb_pxl,nsamp);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++) {
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">i</span> = pxl_row[pxl_idx];
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">j</span> = pxl_col[pxl_idx];
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">adu</span> = (<span style="color: #8ae234; font-weight: bold;">double</span>) data[(i*ncol+j)*nsamp+k];
    gsl_matrix_set(pxl_data,pxl_idx,k,adu);
  }
}
free(data);
H5Fclose (file_id);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3f1cfe" class="outline-5">
<h5 id="orgc3f1cfe"><span class="section-number-5">8.3.1.10</span> <code>&lt;&lt;fit_pwc_to_roi-initialize-data-structure&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-10">
<p>
Initialization of a <code>data</code> structure.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgb4a786f"><span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> <span style="color: #ff6347;">d</span> = { .stab_pxl = pxl_data,
                  .variance = variance};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd525705" class="outline-5">
<h5 id="orgd525705"><span class="section-number-5">8.3.1.11</span> <code>&lt;&lt;fit_pwc_to_roi-initial-guess&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-11">
<p>
Initial guesses are obtained here. Notice the use of the <a href="https://www.gnu.org/software/gsl/manual/html_node/Vector-views.html#Vector-views"><code>vector_views</code></a>, <code>phiphi</code> and <code>ff</code>, they are very handy for making the match between "directly meaningful parameters" and their counter part on the parameter vector (<code>par</code> here). We are also working on a log scale since every model parameter is positive (that's a way of enforcing it). The two variables that are initialized here and are used later on are:
</p>
<dl class="org-dl">
<dt>n_par</dt><dd>the number of model parameters.</dd>
<dt>par</dt><dd>a pointer to a <code>gsl_vector</code> containing the (log of the) model parameters.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-C" id="orga14451e"><span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">f</span> = gsl_vector_calloc(nsamp);
<span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">phi</span> = gsl_vector_calloc(nb_pxl);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">b</span>=100;
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++) {
  <span style="color: #8ae234; font-weight: bold;">gsl_vector_const_view</span> <span style="color: #ff6347;">row</span> = gsl_matrix_const_row(pxl_data,pxl_idx);
  gsl_vector_add(f,&amp;row.vector);
}
gsl_vector_scale(f, 1.0/(<span style="color: #8ae234; font-weight: bold;">double</span>) nb_pxl);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">baseline_mean</span>=0;
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;baseline; k++)
  baseline_mean += gsl_vector_get(f,k);
baseline_mean /= (<span style="color: #8ae234; font-weight: bold;">double</span>) baseline;
gsl_vector_scale(f, 1.0/baseline_mean);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++) {
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">sum</span>=0;
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;baseline; k++)
    sum += gsl_matrix_get(pxl_data,pxl_idx,k);
  sum /= (<span style="color: #8ae234; font-weight: bold;">double</span>) baseline;
  gsl_vector_set(phi,pxl_idx,sum-b);
}
<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_par</span> = 1+nb_pxl+(nsamp-baseline);
<span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">par</span> = gsl_vector_alloc(n_par);
gsl_vector_set(par,0,log(b));
<span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">phiphi</span> = gsl_vector_subvector(par,1,nb_pxl);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
  gsl_vector_set(&amp;phiphi.vector,pxl_idx,log(gsl_vector_get(phi,pxl_idx)));
<span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">ff</span> = gsl_vector_subvector(par,1+nb_pxl,nsamp-baseline);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=baseline; k&lt;nsamp; k++)
  gsl_vector_set(&amp;ff.vector,k-baseline,log(gsl_vector_get(f,k)));
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Stabilize variance of observations</span>
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
    <span style="color: #2c5115;">// </span><span style="color: #888a85;">stabilize variance</span>
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">z</span> = 2*sqrt(gsl_matrix_get(pxl_data,pxl_idx,k)/gain+variance);
    gsl_matrix_set(pxl_data,pxl_idx,k,z);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce3a960" class="outline-5">
<h5 id="orgce3a960"><span class="section-number-5">8.3.1.12</span> <code>&lt;&lt;fit_pwc_to_roi-residual-fct&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-12">
<p>
Definition of the "workhorse" of this program, the function that returns the vector of residuals (<code>residual</code>) from the model parameters (<code>log_par</code>) and the data (<code>data</code>). Again, vector (and matrix) views are heavily used.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org4451dcf"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">residual_fct</span>(<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">log_par</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">data</span>, 
             <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> * <span style="color: #ff6347;">residual</span>)
{
  <span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">obs</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;stab_pxl;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">variance</span> = ((<span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">data</span> *)data)-&gt;variance;
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_pxl</span> = obs-&gt;size1;
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">n_obs</span> = obs-&gt;size2;
  <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">log_par_length</span> = log_par-&gt;size;
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">auto_fluo</span> = exp(gsl_vector_get(log_par,0));
  <span style="color: #8ae234; font-weight: bold;">gsl_vector_const_view</span> <span style="color: #ff6347;">phi</span> = gsl_vector_const_subvector(log_par, 1, n_pxl);
  <span style="color: #8ae234; font-weight: bold;">gsl_vector_const_view</span> <span style="color: #ff6347;">f</span> = gsl_vector_const_subvector(log_par, 1+n_pxl,n_obs-baseline);
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;n_pxl; pxl_idx++) {
    <span style="color: #8ae234; font-weight: bold;">gsl_vector_const_view</span> <span style="color: #ff6347;">row</span> = gsl_matrix_const_row(obs,pxl_idx);
    <span style="color: #8ae234; font-weight: bold;">gsl_vector_view</span> <span style="color: #ff6347;">resid</span> = gsl_vector_subvector(residual, pxl_idx*n_obs, n_obs);
    <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">phi_val</span> = exp(gsl_vector_get(&amp;phi.vector,pxl_idx));
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;baseline; k++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">z</span> = gsl_vector_get(&amp;row.vector,k);
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">sF</span> = 2*sqrt(auto_fluo+phi_val+variance);
      gsl_vector_set(&amp;resid.vector,k,z-sF);
    }
    <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=baseline; k&lt;n_obs; k++) {
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">z</span> = gsl_vector_get(&amp;row.vector,k);
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">s</span> = exp(gsl_vector_get(&amp;f.vector,k-baseline));
      <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">sF</span> = 2*sqrt(auto_fluo+phi_val*s+variance);
      gsl_vector_set(&amp;resid.vector,k,z-sF);
    }
  }
  <span style="color: #729fcf; font-weight: bold;">return</span> GSL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge593dd5" class="outline-5">
<h5 id="orge593dd5"><span class="section-number-5">8.3.1.13</span> <code>&lt;&lt;fit_pwc_to_roi-callback-fct&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-13">
<p>
A simple callback function definition that prints to the <code>stderr</code> the iteration number together with the current RSS value.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orgc9002ec"><span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">callback</span>(<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">iter</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #ff6347;">params</span>,
         <span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w</span>)
{
  <span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">f</span> = gsl_multifit_nlinear_residual(w);
  
  fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"iter %2zu: RSS = %.4f\n"</span>,
          iter,
          gsl_pow_2(gsl_blas_dnrm2(f)));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org98b0eb4" class="outline-5">
<h5 id="org98b0eb4"><span class="section-number-5">8.3.1.14</span> <code>&lt;&lt;fit_pwc_to_roi-initialize-gsl_multifit_nlinear_fdf&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-14">
<p>
As its name says, initialization of the structure required by the least-squares solver.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org5b882fa"><span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_fdf</span> <span style="color: #ff6347;">fdf</span>;
fdf.f = residual_fct;
fdf.df = <span style="color: #8ae234;">NULL</span>;   <span style="color: #2c5115;">/* </span><span style="color: #888a85;">set to NULL for finite-difference Jacobian </span><span style="color: #2c5115;">*/</span>
fdf.fvv = <span style="color: #8ae234;">NULL</span>;     <span style="color: #2c5115;">/* </span><span style="color: #888a85;">not using geodesic acceleration </span><span style="color: #2c5115;">*/</span>
fdf.n = nsamp*nb_pxl;
fdf.p = n_par;
fdf.params = &amp;d;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb79efda" class="outline-5">
<h5 id="orgb79efda"><span class="section-number-5">8.3.1.15</span> <code>&lt;&lt;fit_pwc_to_roi-allocate-and-initialize-solver&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-15">
<p>
Now the initialization of the solver itself.
</p>

<div class="org-src-container">
<pre class="src src-C" id="orga072cfa"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_type</span> *<span style="color: #ff6347;">T</span> = gsl_multifit_nlinear_trust;
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_parameters</span> <span style="color: #ff6347;">fdf_params</span> = gsl_multifit_nlinear_default_parameters();
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">allocate workspace with default parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_multifit_nlinear_workspace</span> *<span style="color: #ff6347;">w</span> = gsl_multifit_nlinear_alloc(T,
                                                               &amp;fdf_params,
                                                               nsamp*nb_pxl,
                                                               n_par);
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">initialize solver with starting point </span><span style="color: #2c5115;">*/</span>
gsl_multifit_nlinear_init (par, &amp;fdf, w);
</pre>
</div>
</div>
</div>

<div id="outline-container-orged8fcd5" class="outline-5">
<h5 id="orged8fcd5"><span class="section-number-5">8.3.1.16</span> <code>&lt;&lt;fit_pwc_to_roi-inital-rss&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-16">
<p>
We get the initial RSS value (the one given by the initial guess of the model parameters).
</p>

<div class="org-src-container">
<pre class="src src-C" id="org660bd20"><span style="color: #8ae234; font-weight: bold;">gsl_vector</span> *<span style="color: #ff6347;">residual</span> = gsl_multifit_nlinear_residual(w);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq0</span>;
gsl_blas_ddot(residual, residual, &amp;chisq0);
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ba4ca1" class="outline-5">
<h5 id="org6ba4ca1"><span class="section-number-5">8.3.1.17</span> <code>&lt;&lt;fit_pwc_to_roi-do-nls&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-17">
<p>
Now we run the solver.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org212757a"><span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">xtol</span> = 1e-10;
<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">gtol</span> = 1e-10;
<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">ftol</span> = 0.0;
<span style="color: #2c5115;">/* </span><span style="color: #888a85;">solve the system with a maximum of 200 iterations </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">info</span>;
<span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347;">status</span> = gsl_multifit_nlinear_driver(200, xtol, gtol, ftol,
                                         callback, <span style="color: #8ae234;">NULL</span>, &amp;info,
                                         w);

  <span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute covariance of best fit parameters </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">J</span> = gsl_multifit_nlinear_jac(w);
<span style="color: #8ae234; font-weight: bold;">gsl_matrix</span> *<span style="color: #ff6347;">covar</span> = gsl_matrix_alloc (1+nb_pxl+nsamp-baseline,
                                      1+nb_pxl+nsamp-baseline);
gsl_multifit_nlinear_covar (J, 0.0, covar);

<span style="color: #2c5115;">/* </span><span style="color: #888a85;">compute final cost </span><span style="color: #2c5115;">*/</span>
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">chisq</span>;
gsl_blas_ddot(residual, residual, &amp;chisq);
</pre>
</div>
</div>
</div>

<div id="outline-container-org567a321" class="outline-5">
<h5 id="org567a321"><span class="section-number-5">8.3.1.18</span> <code>&lt;&lt;fit_pwc_to_roi-print-info-final&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-18">
<p>
We print to the <code>stderr</code> general information of the fit. In particular the reason for stopping the iterations and the RSS per degree of freedom (should be close to 1 for a good fit).
</p>

<div class="org-src-container">
<pre class="src src-C" id="org4f25991">fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"\n\nsummary from method '%s/%s'\n"</span>,
        gsl_multifit_nlinear_name(w),
        gsl_multifit_nlinear_trs_name(w));
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"number of iterations: %zu\n"</span>,
        gsl_multifit_nlinear_niter(w));
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"function evaluations: %zu\n"</span>, fdf.nevalf);
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"Jacobian evaluations: %zu\n"</span>, fdf.nevaldf);
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"reason for stopping: %s\n"</span>,
        (info == 1) ? <span style="color: #ad7fa8; font-style: italic;">"small step size"</span> : <span style="color: #ad7fa8; font-style: italic;">"small gradient"</span>);
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"initial RSS = %f\n"</span>, chisq0);
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"final   RSS = %f\n"</span>, chisq);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">dof</span> = nsamp*nb_pxl - n_par;
fprintf(stderr, <span style="color: #ad7fa8; font-style: italic;">"RSS/dof = %g\n"</span>, chisq / dof);
fprintf (stderr, <span style="color: #ad7fa8; font-style: italic;">"status = %s\n\n"</span>, gsl_strerror (status));
</pre>
</div>
</div>
</div>

<div id="outline-container-org33c8eaa" class="outline-5">
<h5 id="org33c8eaa"><span class="section-number-5">8.3.1.19</span> <code>&lt;&lt;fit_pwc_to_roi-print-results&gt;&gt;</code></h5>
<div class="outline-text-5" id="text-8-3-1-19">
<p>
We print to the <code>stdout</code> what was announced in our <code>usage</code> code block.
</p>

<div class="org-src-container">
<pre class="src src-C" id="org1da2bc2"><span style="color: #3B5998;">#define</span> <span style="color: #edd400; font-weight: bold;">FIT</span>(<span style="color: #ff6347;">i</span>) gsl_vector_get(w-&gt;x, i)
<span style="color: #3B5998;">#define</span> <span style="color: #edd400; font-weight: bold;">ERR</span>(<span style="color: #ff6347;">i</span>) sqrt(gsl_matrix_get(covar,i,i))
printf(<span style="color: #ad7fa8; font-style: italic;">"# Common background estimate: %g [%g,%g]\n\n"</span>,
       exp(FIT(0)),exp(FIT(0)-1.96*ERR(0)),
       exp(FIT(0)+1.96*ERR(0)));
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Print f estimation as a first data set</span>
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;baseline; k++)
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g %g\n"</span>,1.0,1.0,1.0);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=baseline; k&lt;nsamp; k++) {
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">est</span> = FIT(1+nb_pxl+k-baseline);
  <span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">err</span> = ERR(1+nb_pxl+k-baseline);
  printf(<span style="color: #ad7fa8; font-style: italic;">"%g %g %g\n"</span>,
         exp(est), exp(est-1.96*err),
         exp(est+1.96*err));
}
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Print intensity estimations one column per pixel</span>
printf(<span style="color: #ad7fa8; font-style: italic;">"\n\n# Predicted variance stabilized signals\n"</span>);
<span style="color: #8ae234; font-weight: bold;">double</span> <span style="color: #ff6347;">auto_fluo</span> = exp(FIT(0));
printf(<span style="color: #ad7fa8; font-style: italic;">"#"</span>);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
  printf(<span style="color: #ad7fa8; font-style: italic;">" (%d,%d)"</span>,(<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_row[pxl_idx],(<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_col[pxl_idx]);
printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;baseline; k++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g "</span>, 2*sqrt(exp(FIT(pxl_idx+1))+auto_fluo+variance));
  printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
}
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=baseline; k&lt;nsamp; k++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g "</span>, 2*sqrt(exp(FIT(pxl_idx+1))*exp(FIT(1+nb_pxl+k-baseline))+auto_fluo+variance));
  printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
}
<span style="color: #2c5115;">// </span><span style="color: #888a85;">Print observations one column per pixel</span>
printf(<span style="color: #ad7fa8; font-style: italic;">"\n\n# Observed stabilized signals\n"</span>);
printf(<span style="color: #ad7fa8; font-style: italic;">"#"</span>);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
  printf(<span style="color: #ad7fa8; font-style: italic;">" (%d,%d)"</span>,(<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_row[pxl_idx],(<span style="color: #8ae234; font-weight: bold;">int</span>) pxl_col[pxl_idx]);
printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
<span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">k</span>=0; k&lt;nsamp; k++) {
  <span style="color: #729fcf; font-weight: bold;">for</span> (<span style="color: #8ae234; font-weight: bold;">size_t</span> <span style="color: #ff6347;">pxl_idx</span>=0; pxl_idx&lt;nb_pxl; pxl_idx++)
    printf(<span style="color: #ad7fa8; font-style: italic;">"%g "</span>, gsl_matrix_get(pxl_data,pxl_idx,k));
  printf(<span style="color: #ad7fa8; font-style: italic;">"\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d48f26" class="outline-5">
<h5 id="org5d48f26"><span class="section-number-5">8.3.1.20</span> Compile, run and test <code>roi</code></h5>
<div class="outline-text-5" id="text-8-3-1-20">
<p>
We compile the code with:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org0bf02cd">gcc -W -g -o code/fit_pwc_to_roi code/fit_pwc_to_roi.c -lgsl -lgslcblas -lhdf5 -lhdf5_hl -lm -std=gnu11
</pre>
</div>

<p>
We run it and store the <code>stdout</code> output to a file called <code>roi_fit</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org44b18ac">./code/fit_pwc_to_roi -f Data_POMC.hdf5 -d stack -g 0.14 -v 290 -p roi_pxl &gt; roi_fit
</pre>
</div>

<pre class="example">
Fitting now piecewise constant signal within ROI for
dataset /stack from file Data_POMC.hdf5
The row and column indexes of the pixels making the
ROI are:
  (26,36) (26,37) (26,38) (26,39)
  (27,36) (27,37) (27,38) (27,39)
  (28,36) (28,37) (28,38) (28,39)
The CCD gain and read-out variance are:
  0.14 and 290

iter  0: RSS = 17256272.3301
iter  1: RSS = 13998117.4429
iter  2: RSS = 7593455.7961
iter  3: RSS = 1663548.7841
iter  4: RSS = 143000.0538
iter  5: RSS = 54906.0470
iter  6: RSS = 40397.0454
iter  7: RSS = 23941.9594
iter  8: RSS = 12454.3227
iter  9: RSS = 6562.5716
iter 10: RSS = 3755.3448
iter 11: RSS = 2717.3812
iter 12: RSS = 2447.4664
iter 13: RSS = 2364.2423
iter 14: RSS = 2281.7851
iter 15: RSS = 2210.0332
iter 16: RSS = 2157.7101
iter 17: RSS = 2116.6896
iter 18: RSS = 2086.1365
iter 19: RSS = 2062.0695
iter 20: RSS = 2043.4441
iter 21: RSS = 2028.4456
iter 22: RSS = 2016.4435
iter 23: RSS = 2006.5716
iter 24: RSS = 1998.4771
iter 25: RSS = 1991.7092
iter 26: RSS = 1986.0608
iter 27: RSS = 1981.2822
iter 28: RSS = 1977.2434
iter 29: RSS = 1973.7948
iter 30: RSS = 1970.8489
iter 31: RSS = 1968.3371
iter 32: RSS = 1966.1716
iter 33: RSS = 1964.3094
iter 34: RSS = 1962.6948
iter 35: RSS = 1961.2984
iter 36: RSS = 1960.0846
iter 37: RSS = 1959.0317
iter 38: RSS = 1958.1156
iter 39: RSS = 1957.3199
iter 40: RSS = 1956.6276
iter 41: RSS = 1956.0261
iter 42: RSS = 1955.5034
iter 43: RSS = 1955.0498
iter 44: RSS = 1954.6563
iter 45: RSS = 1954.3157
iter 46: RSS = 1954.0212
iter 47: RSS = 1953.7672
iter 48: RSS = 1953.5486
iter 49: RSS = 1953.3612
iter 50: RSS = 1953.2009
iter 51: RSS = 1953.0645
iter 52: RSS = 1952.9489
iter 53: RSS = 1952.8516
iter 54: RSS = 1952.7701
iter 55: RSS = 1952.7024
iter 56: RSS = 1952.6468
iter 57: RSS = 1952.6015
iter 58: RSS = 1952.5651
iter 59: RSS = 1952.5363
iter 60: RSS = 1952.5140
iter 61: RSS = 1952.4970
iter 62: RSS = 1952.4846
iter 63: RSS = 1952.4758
iter 64: RSS = 1952.4700
iter 65: RSS = 1952.4663
iter 66: RSS = 1952.4643
iter 67: RSS = 1952.4633
iter 68: RSS = 1952.4630
iter 69: RSS = 1952.4629
iter 70: RSS = 1952.4629
iter 71: RSS = 1952.4629
iter 72: RSS = 1952.4629
iter 73: RSS = 1952.4629
iter 74: RSS = 1952.4629
iter 75: RSS = 1952.4629
iter 76: RSS = 1952.4629
iter 77: RSS = 1952.4629
iter 78: RSS = 1952.4629
iter 79: RSS = 1952.4629
iter 80: RSS = 1952.4629
iter 81: RSS = 1952.4629
iter 82: RSS = 1952.4629
iter 83: RSS = 1952.4629
iter 84: RSS = 1952.4629
iter 85: RSS = 1952.4629
iter 86: RSS = 1952.4629
iter 87: RSS = 1952.4629
iter 88: RSS = 1952.4629
iter 89: RSS = 1952.4629
iter 90: RSS = 1952.4629
iter 91: RSS = 1952.4629
iter 92: RSS = 1952.4629
iter 93: RSS = 1952.4629
iter 94: RSS = 1952.4629


summary from method 'trust-region/levenberg-marquardt'
number of iterations: 94
function evaluations: 16668
Jacobian evaluations: 0
reason for stopping: small step size
initial RSS = 17256272.330096
final   RSS = 1952.462926
RSS/dof = 1.06112
status = success

</pre>


<p>
We see that our RSS (or \(\chi^2\)) per degree of freedom is good! We can check our code with valgrind in the usual way:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org107b922">valgrind ./code/fit_pwc_to_roi -f Data_POMC.hdf5 -d stack -g 0.14 -v 290 -p roi_pxl &gt; dump
</pre>
</div>

<pre class="example">
==7270== Memcheck, a memory error detector
==7270== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==7270== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==7270== Command: ./code/fit_pwc_to_roi -f Data_POMC.hdf5 -d stack -g 0.14 -v 290 -p roi_pxl
==7270== 
Fitting now piecewise constant signal within ROI for
dataset /stack from file Data_POMC.hdf5
The row and column indexes of the pixels making the
ROI are:
  (26,36) (26,37) (26,38) (26,39)
  (27,36) (27,37) (27,38) (27,39)
  (28,36) (28,37) (28,38) (28,39)
The CCD gain and read-out variance are:
  0.14 and 290

iter  0: RSS = 17256272.3301
iter  1: RSS = 13998117.4429
iter  2: RSS = 7593455.7961
iter  3: RSS = 1663548.7841
iter  4: RSS = 143000.0538
iter  5: RSS = 54906.0470
iter  6: RSS = 40397.0454
iter  7: RSS = 23941.9594
iter  8: RSS = 12454.3227
iter  9: RSS = 6562.5716
iter 10: RSS = 3755.3448
iter 11: RSS = 2717.3812
iter 12: RSS = 2447.4664
iter 13: RSS = 2364.2423
iter 14: RSS = 2281.7851
iter 15: RSS = 2210.0332
iter 16: RSS = 2157.7101
iter 17: RSS = 2116.6896
iter 18: RSS = 2086.1365
iter 19: RSS = 2062.0695
iter 20: RSS = 2043.4441
iter 21: RSS = 2028.4456
iter 22: RSS = 2016.4435
iter 23: RSS = 2006.5716
iter 24: RSS = 1998.4771
iter 25: RSS = 1991.7092
iter 26: RSS = 1986.0608
iter 27: RSS = 1981.2822
iter 28: RSS = 1977.2434
iter 29: RSS = 1973.7948
iter 30: RSS = 1970.8489
iter 31: RSS = 1968.3371
iter 32: RSS = 1966.1716
iter 33: RSS = 1964.3094
iter 34: RSS = 1962.6948
iter 35: RSS = 1961.2984
iter 36: RSS = 1960.0846
iter 37: RSS = 1959.0317
iter 38: RSS = 1958.1156
iter 39: RSS = 1957.3199
iter 40: RSS = 1956.6276
iter 41: RSS = 1956.0261
iter 42: RSS = 1955.5034
iter 43: RSS = 1955.0498
iter 44: RSS = 1954.6563
iter 45: RSS = 1954.3157
iter 46: RSS = 1954.0212
iter 47: RSS = 1953.7672
iter 48: RSS = 1953.5486
iter 49: RSS = 1953.3612
iter 50: RSS = 1953.2009
iter 51: RSS = 1953.0645
iter 52: RSS = 1952.9489
iter 53: RSS = 1952.8516
iter 54: RSS = 1952.7701
iter 55: RSS = 1952.7024
iter 56: RSS = 1952.6468
iter 57: RSS = 1952.6015
iter 58: RSS = 1952.5651
iter 59: RSS = 1952.5363
iter 60: RSS = 1952.5140
iter 61: RSS = 1952.4970
iter 62: RSS = 1952.4846
iter 63: RSS = 1952.4758
iter 64: RSS = 1952.4700
iter 65: RSS = 1952.4663
iter 66: RSS = 1952.4643
iter 67: RSS = 1952.4633
iter 68: RSS = 1952.4630
iter 69: RSS = 1952.4629
iter 70: RSS = 1952.4629
iter 71: RSS = 1952.4629
iter 72: RSS = 1952.4629
iter 73: RSS = 1952.4629
iter 74: RSS = 1952.4629
iter 75: RSS = 1952.4629
iter 76: RSS = 1952.4629
iter 77: RSS = 1952.4629
iter 78: RSS = 1952.4629
iter 79: RSS = 1952.4629
iter 80: RSS = 1952.4629
iter 81: RSS = 1952.4629
iter 82: RSS = 1952.4629
iter 83: RSS = 1952.4629
iter 84: RSS = 1952.4629
iter 85: RSS = 1952.4629
iter 86: RSS = 1952.4629
iter 87: RSS = 1952.4629
iter 88: RSS = 1952.4629
iter 89: RSS = 1952.4629
iter 90: RSS = 1952.4629
iter 91: RSS = 1952.4629
iter 92: RSS = 1952.4629
iter 93: RSS = 1952.4629
iter 94: RSS = 1952.4629


summary from method 'trust-region/levenberg-marquardt'
number of iterations: 94
function evaluations: 16668
Jacobian evaluations: 0
reason for stopping: small step size
initial RSS = 17256272.330096
final   RSS = 1952.462926
RSS/dof = 1.06112
status = success

==7270== 
==7270== HEAP SUMMARY:
==7270==     in use at exit: 0 bytes in 0 blocks
==7270==   total heap usage: 6,684 allocs, 6,684 frees, 29,471,706 bytes allocated
==7270== 
==7270== All heap blocks were freed -- no leaks are possible
==7270== 
==7270== For counts of detected and suppressed errors, rerun with: -v
==7270== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>


<p>
We are happy to see that all our allocated memory was freed before returning.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbd7b2b2" class="outline-3">
<h3 id="orgbd7b2b2"><span class="section-number-3">8.4</span> Doing the figures</h3>
<div class="outline-text-3" id="text-8-4">
<p>
We plot our \(\hat{f}_k\) estimation together with pointwise 95% confidence intervals using the following code:
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="orgfc9fab1"><span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">"Time (s)"</span>
<span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">"f estimate"</span>
<span style="color: #8ae234;">unset</span> key
<span style="color: #729fcf; font-weight: bold;">plot</span> [<span style="color: #8ae234;">0:25</span>][] <span style="color: #ad7fa8; font-style: italic;">'roi_fit'</span> <span style="color: #8ae234; font-weight: bold;">index</span> 0 <span style="color: #8ae234; font-weight: bold;">using</span> ($0*0.15):1 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
     <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">'red'</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2,\
     <span style="color: #ad7fa8; font-style: italic;">''</span> <span style="color: #8ae234; font-weight: bold;">index</span> 0 <span style="color: #8ae234; font-weight: bold;">using</span> ($0*0.15):2 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
     <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">'grey'</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2,\
     <span style="color: #ad7fa8; font-style: italic;">''</span> <span style="color: #8ae234; font-weight: bold;">index</span> 0 <span style="color: #8ae234; font-weight: bold;">using</span> ($0*0.15):3 <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
     <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">'grey'</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/roi_fit_f_est.svg" class="org-svg" alt="f hat" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 19: </span><a id="org53b2c7c"></a> \(\hat{f}_k\) (red) from the 12 pixels of ROI (POMC data). The grey lines define pointwise 95% confidence intervals.</p>
</div>


<p>
We now build a figure showing the (variance stabilized) data of each of the 12 pixels of the ROI (in black) together with the fitted values (in red).
</p>

<div class="org-src-container">
<pre class="src src-gnuplot" id="orgea1e08e"><span style="color: #8ae234;">set</span> xlabel <span style="color: #ad7fa8; font-style: italic;">""</span>; <span style="color: #8ae234;">set</span> ylabel <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #8ae234;">set</span> yrange [<span style="color: #8ae234;">135:185</span>]; <span style="color: #8ae234;">set</span> xrange [<span style="color: #8ae234;">0:25</span>]
<span style="color: #8ae234;">set</span> xtics format <span style="color: #ad7fa8; font-style: italic;">""</span>; <span style="color: #8ae234;">set</span> ytics format <span style="color: #ad7fa8; font-style: italic;">""</span>
<span style="color: #8ae234;">unset</span> key; <span style="color: #8ae234;">set</span> grid
<span style="color: #8ae234;">set</span> multiplot layout 3,4 margins 0.1,0.9,0.1,0.95 spacing 0,0
<span style="color: #8ae234;">do</span> for[<span style="color: #8ae234;">k=1:12</span>] {\
   <span style="color: #729fcf; font-weight: bold;">plot</span> <span style="color: #ad7fa8; font-style: italic;">'roi_fit'</span> <span style="color: #8ae234; font-weight: bold;">index</span> 1 <span style="color: #8ae234; font-weight: bold;">using</span> ($0*0.15):k <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
   <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">'red'</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 2,\
   <span style="color: #ad7fa8; font-style: italic;">''</span> <span style="color: #8ae234; font-weight: bold;">index</span> 2 <span style="color: #8ae234; font-weight: bold;">using</span> ($0*0.15):k <span style="color: #8ae234; font-weight: bold;">with</span> <span style="color: #edd400; font-weight: bold;">lines</span>\
   <span style="color: #8ae234; font-weight: bold;">linecolor</span> rgb <span style="color: #ad7fa8; font-style: italic;">'black'</span> <span style="color: #8ae234; font-weight: bold;">linewidth</span> 1}
<span style="color: #8ae234;">unset</span> multiplot     
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="figs/roi_fit_fluo_est.svg" class="org-svg" alt="Observed and fitted values" align="center" width="500" height="500">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 20: </span><a id="org47e4226"></a> Observed (black) and fitted (red) values after variance stabilization for the 12 pixels of the ROI. Pixel (26,36) is at the upper left, pixel (26,39) at the upper right, pixel (28,36) at the bottom left and pixel (28,39) at the bottom right.</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: June 20 2017</p>
<p class="author">Author: Christophe Pouzat</p>
<p class="date">Created: 2017-07-21 ven. 16:47</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
